<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIM 2026 - Stable Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #007bff; --dark: #121212; --light: #2c2c2c; --danger: #dc3545; --success: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: var(--light); border-right: 1px solid #444; display: flex; flex-direction: column; flex-shrink: 0; }
        .auth-box { padding: 15px; border-bottom: 1px solid #444; }
        .auth-input { width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #444; background: #000; color: white; }
        
        .team-list { flex: 1; padding: 15px; overflow-y: auto; }
        .room-item { padding: 10px; background: #333; margin-bottom: 8px; border-radius: 6px; cursor: pointer; font-size: 14px; border-left: 4px solid transparent; display: flex; justify-content: space-between; }
        .active { border-left-color: var(--primary); background: #444; }

        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; }
        #video-area { height: 240px; background: #000; display: flex; position: relative; border-bottom: 2px solid #333; }
        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 100%; padding: 5px; }
        video { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; background: #222; transform: scaleX(-1); }
        
        #chat-area { flex: 1; display: flex; flex-direction: column; background: #181818; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; font-size: 14px; }
        .sent { background: var(--primary); align-self: flex-end; }
        .received { background: #333; align-self: flex-start; }

        .input-bar { padding: 15px; background: var(--light); display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 10px 15px; border-radius: 20px; border: none; background: #111; color: white; outline: none; }
        .btn { padding: 8px 15px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; color: white; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="auth-box" id="auth-ui">
            <h3>BIM Login</h3>
            <input type="email" id="email" class="auth-input" placeholder="E-Mail">
            <input type="password" id="password" class="auth-input" placeholder="Passwort">
            <button onclick="authAction()" class="btn" style="background:var(--success); width:100%;">Login / Reg</button>
        </div>
        <div class="auth-box" id="user-ui" style="display:none;">
            <p id="u-mail" style="margin:0; font-size:12px; color:var(--primary);"></p>
            <p style="font-size:11px; color:#888;">ID: <span id="u-id" style="color:var(--success)"></span></p>
            <button onclick="logout()" class="btn" style="background:var(--danger); width:100%; padding:5px; font-size:11px;">Logout</button>
        </div>
        <div class="team-list">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-size:11px; color:#888;">CHATS & TEAMS</span>
                <button onclick="addTeam()" style="background:none; border:1px solid #555; color:white; cursor:pointer;">+</button>
            </div>
            <div id="rooms-container">
                <div class="room-item active" onclick="setRoom('global')">ðŸ“¢ Hauptraum</div>
            </div>
        </div>
    </div>

    <div class="main">
        <div id="video-area">
            <div id="video-grid">
                <video id="localVid" autoplay playsinline muted></video>
                <video id="remoteVid" autoplay playsinline></video>
            </div>
            <div style="position:absolute; bottom:10px; left:50%; transform:translateX(-50%); display:flex; gap:10px;">
                <button onclick="toggleTrack('audio')" class="btn" style="background:#555">ðŸŽ¤</button>
                <button onclick="toggleTrack('video')" class="btn" style="background:#555">ðŸ“·</button>
                <button onclick="location.reload()" class="btn" style="background:var(--danger)">âœ–</button>
            </div>
        </div>

        <div id="chat-area">
            <div id="messages"></div>
            <div class="input-bar">
                <button onclick="callUser()" class="btn" style="background:var(--success)">ðŸ“ž</button>
                <input type="text" id="mInp" placeholder="Nachricht...">
                <button onclick="sendMsg()" class="btn" style="background:var(--primary)">âž¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const fbConfig = {
            apiKey: "AIzaSyB9Mw9ljgqeJztFtBEM2H7-c6k7XGy8zAw",
            authDomain: "projektmangerbim2026.firebaseapp.com",
            projectId: "projektmangerbim2026",
            storageBucket: "projektmangerbim2026.firebasestorage.app",
            messagingSenderId: "88720534809",
            appId: "1:88720534809:web:4da70e450799e1cc80a988"
        };

        const app = initializeApp(fbConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let peer, localStream, activeRoom = "global", myShortId;

        // --- AUTH ---
        window.authAction = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch { await createUserWithEmailAndPassword(auth, e, p).catch(err => alert(err.message)); }
        };

        window.logout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('user-ui').style.display = 'block';
                document.getElementById('u-mail').innerText = user.email;
                myShortId = user.uid.substring(0, 5);
                document.getElementById('u-id').innerText = myShortId;
                
                initPeer(myShortId);
                syncRooms();
                syncMessages();
            }
        });

        // --- ROOMS & TEAMS ---
        window.addTeam = async () => {
            const n = prompt("Team Name:");
            if(!n) return;
            await addDoc(collection(db, "rooms"), { name: n, members: [myShortId], type: "team" });
        };

        window.invite = async (id) => {
            const p = prompt("User ID hinzufÃ¼gen:");
            if(!p) return;
            await updateDoc(doc(db, "rooms", id), { members: arrayUnion(p) });
        };

        window.setRoom = (id) => {
            activeRoom = id;
            document.querySelectorAll('.room-item').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('room-' + id) || document.querySelector('.room-item');
            if(target) target.classList.add('active');
            syncMessages();
        };

        function syncRooms() {
            onSnapshot(collection(db, "rooms"), (snap) => {
                const cont = document.getElementById('rooms-container');
                cont.innerHTML = `<div class="room-item ${activeRoom==='global'?'active':''}" onclick="setRoom('global')">ðŸ“¢ Hauptraum</div>`;
                snap.forEach(d => {
                    const r = d.data();
                    if(r.members.includes(myShortId)) {
                        cont.innerHTML += `<div class="room-item ${activeRoom===d.id?'active':''}" id="room-${d.id}" onclick="setRoom('${d.id}')">
                            ðŸ‘¥ ${r.name} <span onclick="invite('${d.id}')" style="color:var(--primary)">+</span>
                        </div>`;
                    }
                });
            });
        }

        // --- CHAT LOGIK ---
        function syncMessages() {
            const q = query(collection(db, "msgs"), orderBy("time", "asc"));
            onSnapshot(q, (snap) => {
                const box = document.getElementById('messages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    if(m.room === activeRoom) {
                        const div = document.createElement('div');
                        div.className = `msg ${m.uid === auth.currentUser.uid ? 'sent' : 'received'}`;
                        div.innerHTML = `<small style="display:block;opacity:0.5;font-size:9px">${m.user}</small>${m.text}`;
                        box.appendChild(div);
                    }
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        window.sendMsg = async () => {
            const i = document.getElementById('mInp');
            if(!i.value.trim()) return;
            await addDoc(collection(db, "msgs"), {
                text: i.value,
                room: activeRoom,
                user: auth.currentUser.email.split('@')[0],
                uid: auth.currentUser.uid,
                time: serverTimestamp()
            });
            i.value = "";
        };

        // --- VIDEO ---
        function initPeer(id) {
            peer = new Peer(id);
            peer.on('call', async c => {
                if(confirm("Anruf annehmen?")) {
                    localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                    document.getElementById('localVid').srcObject = localStream;
                    c.answer(localStream);
                    c.on('stream', s => document.getElementById('remoteVid').srcObject = s);
                }
            });
        }

        window.callUser = async () => {
            const id = prompt("Partner ID:");
            if(!id) return;
            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localVid').srcObject = localStream;
            const c = peer.call(id, localStream);
            c.on('stream', s => document.getElementById('remoteVid').srcObject = s);
        };

        window.toggleTrack = (type) => {
            const t = type === 'video' ? localStream.getVideoTracks()[0] : localStream.getAudioTracks()[0];
            t.enabled = !t.enabled;
        };

        document.getElementById('mInp').onkeypress = (e) => { if(e.key==='Enter') sendMsg(); };
    </script>
</body>
</html>
