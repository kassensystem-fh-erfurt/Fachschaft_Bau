<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem FH-Erfurt</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif;
 background-color: #f7f7f7; }
    #receipt-content-interactive { overflow-y: auto; max-height: 40vh; }
    .product-btn:active { transform: scale(0.98);
 }
    .numpad-btn { height: 50px; display:flex; justify-content:center; align-items:center; }
    #async-loading-overlay { position: fixed; top:0;
 left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); z-index:100; display:none; justify-content:center; align-items:center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1);
 border-top: 4px solid #b91c1c; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite;
 }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #toast-container { position: fixed; top:1rem; right:1rem; z-index:1000;
 pointer-events:none; }
    .toast { padding: .75rem 1rem; border-radius: .5rem; color: #fff; margin-bottom:.5rem; opacity:0; transition: opacity .25s ease;
 }
    .toast-success { background: #16a34a; } .toast-error { background:#dc2626 } .toast-info { background:#2563eb }
    
    /* Druck-Container standardmäßig unsichtbar */
    #print-receipt-container { display: none;
 visibility: hidden; } 
    .receipt-print { font-family: 'Consolas', 'Courier New', monospace;
 }

    /* **KORRIGIERTE DRUCK-STILE FÜR BONDDRUCKER (80mm)** */
    @media print {
      body * { visibility: hidden !important;
 }
      
      /* NEU: Wichtig, um den Druckbereich zu isolieren */
      #print-receipt-container { 
        visibility: visible !important;
 display: block !important; 
        position: absolute !important; 
        left: 0 !important; 
        top: 0 !important; 
        width: 80mm !important;
 font-family: 'Consolas', 'Courier New', monospace !important; 
        font-size: 12px !important; /* Angepasst auf 12px für bessere Lesbarkeit und Zeilenbreite auf Bondruckern */
        color: #000 !important;
 padding: 2px !important; /* Reduziertes Padding für maximale Druckfläche */
        margin: 0 !important;
 line-height: 1.2 !important; /* Reduzierter Zeilenabstand */
      }
      #print-receipt-container * { 
        visibility: visible !important;
 }
      
      /* Print-Layout Regeln */
      .receipt-print .line { display:flex;
 justify-content:space-between; margin-bottom: 2px; }
      .receipt-print .item-name { width:70%; overflow:hidden; white-space:normal;
 } 
      .receipt-print .item-price { width:30%; text-align:right; font-weight:bold;
 }
      .receipt-print .separator { border-top: 1px dashed #000; margin: 4px 0;
 }
      .receipt-print .total-line { font-size: 14px !important; font-weight: bold;
 } /* Angepasst proportional zur neuen Basis von 12px */
      
      /* Stil für die Ausfüll-Linien (Bewirtungsbeleg) */
      .fill-line { border-bottom: 1px solid #000;
 height: 1.5em; margin-top: 0.5em; }
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-4 bg-red-500/10 overflow-x-hidden">

  <div id="toast-container"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <div id="login-modal" style="display:flex;"
 class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h1 class="text-3xl font-bold text-center text-red-700 mb-2">Kassensystem</h1>
      <p class="text-sm text-center text-gray-500 mb-6">Bitte anmelden oder registrieren.</p>
      <form id="login-form" onsubmit="event.preventDefault(); handleLoginSubmit()">
        <div class="mb-4">
          <label for="login-email" class="block text-sm font-medium text-gray-700">E-Mail</label>
          <input type="email" id="login-email" required class="mt-1 w-full px-3 py-2 border rounded-lg">
      
   </div>
        <div class="mb-6">
          <label for="login-password" class="block text-sm font-medium text-gray-700">Passwort</label>
          <input type="password" id="login-password" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600">Anmelden</button>
      </form>
      <div class="mt-4 text-center">
        <button onclick="openRegistrationModal()" class="text-sm text-indigo-600">Registrieren</button>
       
  <button onclick="openForgotPasswordModal()" class="ml-2 text-sm text-red-600">Passwort vergessen?</button>
      </div>
    </div>
  </div>

  <div id="registration-modal" style="display:none;"
 class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center text-indigo-700 mb-4">Konto erstellen</h2>
      <form id="register-form" onsubmit="event.preventDefault(); handleRegisterSubmit()">
        <div class="mb-4">
          <label for="register-email" class="block text-sm font-medium text-gray-700">E-Mail</label>
          <input type="email" id="register-email" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="mb-6">
 
          <label for="register-password" class="block text-sm font-medium text-gray-700">Passwort (mindestens 8 Zeichen und ein Sonderzeichen)</label>
          <input type="password" id="register-password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-green-600">Registrieren</button>
      </form>
      <button onclick="closeModal('registration-modal');
 openLoginModal();" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück</button>
    </div>
  </div>

  <div id="forgot-password-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center text-red-700 mb-4">Passwort zurücksetzen</h2>
      <p class="text-sm text-center text-gray-500 mb-4">Geben Sie Ihre E-Mail-Adresse ein, um einen Link zum Zurücksetzen Ihres Passworts zu erhalten.</p>
      <form id="reset-form" onsubmit="event.preventDefault();
 handlePasswordReset()">
        <div class="mb-6">
          <label for="reset-email" class="block text-sm font-medium text-gray-700">E-Mail</label>
          <input type="email" id="reset-email" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600">Link senden</button>
      </form>
      <button onclick="closeModal('forgot-password-modal');
 openLoginModal();" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück</button>
    </div>
  </div>
  
  <div id="pin-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 id="pin-modal-title" class="text-2xl font-bold text-center text-red-700 mb-4">Code eingeben</h2>
      <p id="pin-modal-message" class="text-sm text-center text-gray-500 mb-4">Bitte den Code zur Bestätigung eingeben.</p>
      
      <div class="mb-6">
        <label for="pin-input" class="block text-sm font-medium text-gray-700">Sicherheitscode</label>
        <input type="password" id="pin-input" required maxlength="10" class="mt-1 w-full px-3 py-2 border rounded-lg text-center text-xl font-mono">
      </div>
      
      <button onclick="handlePinSubmit()" id="pin-submit-button" class="w-full p-2 rounded-lg font-bold text-white bg-red-600">Bestätigen</button>
      
      <button onclick="closeModal('pin-modal')" class="mt-4 w-full p-1 text-sm text-gray-500">Abbrechen</button>
    </div>
</div>

  <div id="product-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">Produkt- & Kategorie-Verwaltung</h2>
      <div id="product-modal-content">
        <div class="mb-4 border-b pb-3">
          <h3 class="text-lg font-semibold mb-2">Neue Kategorie/Produkt</h3>
          <div class="flex space-x-2 mb-2">
       
             <input type="text" id="new-category-name" placeholder="Kategorie" class="flex-grow p-2 border rounded-lg">
            <button onclick="window.addCategory()" class="p-2 bg-indigo-500 text-white rounded-lg">Kategorie</button>
          </div>
          
          <div class="grid grid-cols-4 gap-2 items-end mb-2"> 
            <input type="text" id="new-product-name" placeholder="Produktname" class="col-span-2 p-2 border rounded-lg">
            <input type="number" id="new-product-price" placeholder="Preis 
 (€)" step="0.01" class="p-2 border rounded-lg">
            <input type="number" id="new-product-stock" placeholder="Lager" step="1" class="p-2 border rounded-lg">
          </div>
          
          <div class="grid grid-cols-2 gap-2 items-end mb-2">
            <select id="new-product-category" class="p-2 border rounded-lg"><option value="">Kategorie</option></select>
            <select id="new-product-tax-rate" class="p-2 border rounded-lg">
                <option value="19.0">19% MwSt.</option>
                <option value="7.0">7% MwSt.</option>
            </select>
          </div>
     
          <button onclick="window.addProduct()" class="w-full p-2 bg-green-500 text-white rounded-lg font-bold">Produkt hinzufügen</button>

        </div>

        <h3 class="text-lg font-semibold mb-2">Kategorien</h3>
        <div id="category-list" class="space-y-2 mb-4"></div>
        <h3 class="text-lg font-semibold mb-2">Produkte (Preis & Lager bearbeiten)</h3>
        <div id="product-list" class="space-y-2"></div>
      </div>
      <div class="mt-6 text-right"><button onclick="closeModal('product-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
    </div>
  </div>

  <div id="finalize-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] 
 flex items-center justify-center p-4">
    <div class="bg-white p-3 rounded-xl shadow-2xl w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4 text-green-700 text-center">Zahlung abschließen</h2>
      <div class="mb-3 p-2 border-2 border-green-500 rounded-lg bg-green-50">
        <p class="text-xs font-bold text-gray-700">Gesamtbetrag:</p>
        <div id="finalize-total" class="text-3xl font-extrabold text-right text-green-700">0.00 €</div>
      </div>

      <div id="payment-buttons" class="grid grid-cols-1 gap-3 mb-4">
        <button onclick="setPaymentMethod('KARTE')" id="btn-karte" class="p-3 rounded-xl font-semibold text-white bg-indigo-600">KARTE</button>
      
 </div>

      <div id="cash-payment-area" class="mt-4 p-3 border rounded-lg bg-gray-50">
        <h3 class="text-lg font-semibold mb-2 flex justify-between items-center text-blue-700">
          BAR Zahlung (Rückgeld)
          <span id="btn-bar-indicator" class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">AKTIV</span>
        </h3>

        <label class="block text-sm font-medium text-gray-700 mb-1">Erhaltener Betrag</label>
        <div id="cash-received-display" class="w-full h-10 flex items-center justify-end px-3 py-2 border rounded-xl text-xl font-extrabold text-gray-800 
 bg-white">0,00</div>

        <div class="mt-3 pt-2 border-t flex justify-between items-center">
          <span class="text-lg font-bold text-gray-700">Rückgeld:</span>
          <span id="change-display" class="text-2xl font-extrabold text-green-700">0,00 €</span>
        </div>

        <div id="cash-numpad-container" class="mt-4 grid grid-cols-3 gap-2">
          <button onclick="handleCashInput('7')" class="numpad-btn bg-gray-200">7</button>
          <button onclick="handleCashInput('8')" class="numpad-btn bg-gray-200">8</button>
          <button 
 onclick="handleCashInput('9')" class="numpad-btn bg-gray-200">9</button>
          <button onclick="handleCashInput('4')" class="numpad-btn bg-gray-200">4</button>
          <button onclick="handleCashInput('5')" class="numpad-btn bg-gray-200">5</button>
          <button onclick="handleCashInput('6')" class="numpad-btn bg-gray-200">6</button>
          <button onclick="handleCashInput('1')" class="numpad-btn bg-gray-200">1</button>
          <button onclick="handleCashInput('2')" class="numpad-btn bg-gray-200">2</button>
          <button onclick="handleCashInput('3')" class="numpad-btn bg-gray-200">3</button>
          <button onclick="handleCashInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
      
          <button onclick="handleCashInput('0')" class="numpad-btn bg-gray-200">0</button>
          <button onclick="handleCashInput('dot')" class="numpad-btn bg-gray-200">,</button>
        </div>

        <div class="mt-3 grid grid-cols-3 gap-2">
          <button onclick="setCashExact()" class="product-btn h-10 bg-blue-500 text-white rounded-xl">Exakt</button>
          <button onclick="addCashShortcut(5)" class="product-btn h-10 bg-blue-500 text-white rounded-xl">+5 €</button>
          <button onclick="addCashShortcut(10)" class="product-btn h-10 bg-blue-500 text-white rounded-xl">+10 €</button>
        </div>
  
     </div>

      <div id="finalize-button-container" class="mt-4">
        <div id="cash-finalize-buttons" style="display:block;">
          <p class="text-sm text-center text-gray-500 mb-2 font-semibold">Transaktion abschließen:</p>
          <div class="grid grid-cols-3 gap-2">
            <button onclick="handleFinalizeAction('BAR','none')" disabled id="btn-cash-none" class="p-3 rounded-xl font-extrabold text-white bg-red-400">Ohne Beleg</button>
            <button onclick="handleFinalizeAction('BAR','standard')" disabled id="btn-cash-standard" class="p-3 rounded-xl font-extrabold text-white bg-green-400">Standard Bon</button>
       
           <button onclick="handleFinalizeAction('BAR','bewirtung')" disabled id="btn-cash-bewirtung" class="p-3 rounded-xl font-extrabold text-white bg-red-600">Bewirtungsbeleg</button>
          </div>
        </div>

        <div id="card-finalize-buttons" style="display:none;">
          <p class="text-lg font-bold text-center text-indigo-700 mb-3">Belegoptionen:</p>
          <div class="grid grid-cols-3 gap-2">
            <button onclick="handleFinalizeAction('KARTE','none')" class="p-3 rounded-xl font-extrabold text-white bg-gray-500">NEIN</button>
            <button 
 onclick="handleFinalizeAction('KARTE','standard')" class="p-3 rounded-xl font-extrabold text-white bg-green-600">Standard Bon</button>
            <button onclick="handleFinalizeAction('KARTE','bewirtung')" class="p-3 rounded-xl font-extrabold text-white bg-red-700">Bewirtungsbeleg</button>
          </div>
        </div>
      </div>

      <div class="mt-4 text-right"><button onclick="closeModal('finalize-modal')" class="p-2 bg-gray-300 rounded-lg">Abbrechen</button></div>
    </div>
  </div>

  <div id="settings-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
    <div id="settings-content-container" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center 
 text-red-700 mb-6">Einstellungen & Verwaltung</h2>
      
      <div id="settings-menu" class="space-y-4">
        <button onclick="window.openGeneralSettings()" class="w-full p-3 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700">Kassenbon-Einstellungen</button>
        <button onclick="window.openProductModal();
 closeModal('settings-modal')" class="w-full p-3 rounded-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700">Produkt- & Kategorie-Verwaltung</button>
      </div>

      <div id="general-settings-form-container" style="display:none;">
        <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Kassenbon-Einstellungen</h3>
        <form id="settings-form">
          <div class="mb-4">
            <label for="company-name" class="block text-sm font-medium text-gray-700">Firmenname</label>
            <input type="text" id="company-name" class="mt-1 w-full p-2 border rounded-lg">
       
    </div>
          <div class="mb-4">
            <label for="address" class="block text-sm font-medium text-gray-700">Adresse (für Beleg)</label>
            <input type="text" id="address" class="mt-1 w-full p-2 border rounded-lg">
          </div>
          <div class="mb-4">
            <label for="tax-id" class="block text-sm font-medium text-gray-700">Steuernummer</label>
          
           <input type="text" id="tax-id" class="mt-1 w-full p-2 border rounded-lg">
          </div>
          <div class="mb-4">
            <label for="reversal-code" class="block text-sm font-medium text-gray-700">Code für Storno/Einstellungen</label>
            <input type="password" id="reversal-code" class="mt-1 w-full p-2 border rounded-lg" maxlength="10">
            <p class="text-xs text-gray-500 mt-1">Lassen Sie dieses Feld leer, um den aktuellen Code beizubehalten.</p>
          </div>
          <div class="mb-6">
            <label for="tax-rate" class="block text-sm font-medium text-gray-700">Steuersatz Fallback (%)</label>
            <input type="number" id="tax-rate" step="0.1" class="mt-1 w-full p-2 border rounded-lg">
            <p class="text-xs text-gray-500 mt-1">Dieser Satz wird nur verwendet, wenn einem Produkt kein Satz zugewiesen ist.</p>
     
          </div>
          <button type="button" onclick="window.saveSettings()" class="w-full p-3 rounded-lg font-bold text-white bg-red-600">Speichern</button>
        </form>
        <button onclick="window.showSettingsMenu()" class="mt-4 w-full p-1 text-sm text-gray-500">Zurück zum Menü</button>
      </div>
      
      <button onclick="closeModal('settings-modal')" id="btn-close-settings-modal" class="mt-6 w-full p-2 text-sm text-gray-500 border rounded-lg hover:bg-gray-100">Schließen</button>
    </div>
  </div>

  <div id="cash-management-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-center text-orange-600 mb-4">Kassenverwaltung</h2>
      
      <div class="mb-4 p-3 border-2 border-orange-300 rounded-lg bg-orange-50 text-center">
        <p class="text-sm font-bold text-gray-700">Aktueller Kassenstand:</p>
        <div id="cash-balance-display" class="text-3xl font-extrabold text-orange-700">0,00 €</div>
      </div>

      <div class="mb-4">
        <label for="cash-amount" class="block text-sm font-medium text-gray-700">Betrag (€)</label>
        <input type="number" id="cash-amount" step="0.01" value="0.00" class="mt-1 w-full p-3 border rounded-lg text-xl text-right font-mono">
      </div>
      
      <div class="mb-4">
        <label for="cash-reason" class="block text-sm font-medium text-gray-700">Grund/Beschreibung</label>
        <input type="text" id="cash-reason" class="mt-1 w-full p-2 border rounded-lg">
      </div>

      <div class="grid grid-cols-2 gap-3">
        <button onclick="handleCashManagement('deposit')" class="p-3 rounded-xl font-bold text-white bg-green-600">Einlage (+)</button>
        <button onclick="handleCashManagement('withdrawal')" class="p-3 rounded-xl font-bold text-white bg-red-600">Entnahme (-)</button>
      </div>

      <div class="mt-6 text-right"><button onclick="closeModal('cash-management-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
    </div>
</div>

  <div id="report-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
    <div class="bg-white 
 p-6 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
      <h2 class="text-2xl font-bold text-center text-blue-700 mb-4">Tagesabschluss & Transaktionen</h2>
      
      <div class="flex items-center space-x-2 mb-4 bg-blue-50 p-3 rounded-lg">
        <label for="report-date" class="text-sm font-bold text-blue-700 whitespace-nowrap">Bericht für Tag:</label>
        <input type="date" id="report-date" class="p-1 border rounded-lg text-sm flex-grow">
        <button onclick="window.setReportDateToday()" class="p-1 rounded-lg text-xs font-bold text-white bg-red-500">Heute</button>
      </div>

      <button onclick="window.runDailyReport('report')" class="product-btn w-full 
 p-3 rounded-xl font-bold text-base text-white bg-blue-600">Tagesabschluss (Bericht)</button>
      <button onclick="window.runDailyReport('csv')" class="product-btn w-full p-3 rounded-xl font-bold text-base text-gray-800 bg-gray-300">Tagesabschluss (CSV Export)</button>
      
      <div id="screen-report-content" class="mt-4 p-4 bg-gray-100 rounded-lg overflow-y-auto flex-grow receipt-print">
        <p class="text-gray-500 text-center">Wählen Sie ein Datum und klicken Sie auf 'Tagesabschluss (Bericht)'.</p>
      </div>

      <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2">Transaktionshistorie (Storno)</h3>
      <div id="transaction-list-container" class="border p-2 rounded-lg bg-white overflow-y-auto max-h-48">
       
   <div id="transaction-list">
          <p class="text-gray-500 text-center">Lade Transaktionen...</p>
        </div>
      </div>


      <div class="mt-6 text-right"><button onclick="closeModal('report-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
    </div>
  </div>

  <div id="kasse-content" style="display:none;" class="grid md:grid-cols-3 gap-4 h-full">
    
    <div class="md:col-span-2 flex flex-col space-y-4">
      
      <div class="flex space-x-2 p-2 bg-white rounded-xl shadow-lg">
        <div class="flex-grow">
      
          <div id="category-tabs" class="flex space-x-1 overflow-x-auto pb-1">
            </div>
        </div>
        <button onclick="window.handleLogout()" class="product-btn p-2 bg-red-500 text-white rounded-lg whitespace-nowrap">Logout</button>
      </div>

      <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 flex-grow min-h-[300px]">
        <p class="text-gray-500 col-span-full text-center p-4">Produkte werden geladen...</p>
      </div>

      <div class="p-4 bg-white rounded-xl shadow-lg grid grid-cols-4 gap-4">
   
          <div class="col-span-1">
          <span class="text-sm font-bold text-gray-600 block mb-1">Aktuelle Menge:</span>
          <div id="quantity-display" class="w-full h-10 flex items-center justify-center text-xl font-extrabold text-red-600 bg-red-100 rounded-xl">1</div>
        </div>
        <div id="main-numpad-container" class="grid grid-cols-3 gap-2 col-span-3">
          <button onclick="window.handleQuantityInput('7')" class="numpad-btn bg-gray-200">7</button>
          <button onclick="window.handleQuantityInput('8')" class="numpad-btn bg-gray-200">8</button>
          
          <button onclick="window.handleQuantityInput('9')" class="numpad-btn bg-gray-200">9</button>
          <button onclick="window.handleQuantityInput('4')" class="numpad-btn bg-gray-200">4</button>
          <button onclick="window.handleQuantityInput('5')" class="numpad-btn bg-gray-200">5</button>
          <button onclick="window.handleQuantityInput('6')" class="numpad-btn bg-gray-200">6</button>
          <button onclick="window.handleQuantityInput('1')" class="numpad-btn bg-gray-200">1</button>
          <button onclick="window.handleQuantityInput('2')" class="numpad-btn bg-gray-200">2</button>
          <button onclick="window.handleQuantityInput('3')" class="numpad-btn bg-gray-200">3</button>
          <button onclick="window.handleQuantityInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
     
          <button onclick="window.handleQuantityInput('0')" class="numpad-btn bg-gray-200">0</button>
          <button onclick="window.handleQuantityInput('+')" class="numpad-btn bg-green-500 text-white">+</button>
        </div>
      </div>

    </div>

    <div id="receipt-column" class="md:col-span-1 flex flex-col space-y-4">
      
      <div class="bg-white p-4 rounded-xl shadow-lg flex-grow flex flex-col">
        <h2 class="text-lg font-bold text-red-700 mb-2 border-b pb-1">Aktueller Bon</h2>
        <div id="receipt-content-interactive" class="flex-grow overflow-y-auto mb-2 space-y-1">
    
           <p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>
        </div>
        <div class="border-t pt-2 flex justify-between items-center">
          <button onclick="window.clearBestellung()" class="text-red-500 text-sm font-semibold">Leeren</button>
          <span id="total-display" class="text-2xl font-extrabold text-red-700">GESAMT: 0,00 €</span>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-lg space-y-3">
        <button onclick="window.openFinalizeModal()" 
 class="product-btn w-full p-4 rounded-xl font-extrabold text-white bg-green-600 hover:bg-green-700 shadow-xl" disabled id="btn-finalize">Zahlung abschließen</button>
        
        <button onclick="window.cancelLastTransaction()" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-red-700 hover:bg-red-800">Letzte Rechnung stornieren</button>
        
        <button onclick="window.openReportModalWithPin();" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700">Tagesabschluss & Storno</button>
        <button onclick="window.openCashManagementModal()" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-orange-500 hover:bg-orange-600">Kassenverwaltung</button>
        <button onclick="window.openSettingsModal()" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-gray-500 hover:bg-gray-600">Einstellungen & Verwaltung</button>
      </div>

    </div>

  </div>
  
  <div id="print-receipt-container" class="receipt-print"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { 
        getAuth, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword, 
        
 sendPasswordResetEmail, 
        onAuthStateChanged, 
        signOut 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
        getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc,
        query, where, orderBy, serverTimestamp, Timestamp, limit
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
 // ---------- Firebase config (aus deiner Datei) ----------
    const firebaseConfig = {
        apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
        authDomain: "kassensystem-85412.firebaseapp.com",
        databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kassensystem-85412",
        storageBucket: "kassensystem-85412.appspot.com",
        messagingSenderId: "305116742512",
        appId: "1:305116742512:web:48a65f97b5d1e2e98fa87f",
        measurementId: "G-9D3T2J23P8"
    };
 // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
 // ---------- Global Vars ----------
    let currentUser = null;
    let categories = {}; 
    let products = {};
    
    // Globale Variablen für Kassensystem
    let currentBestellung = []; 
    let totalBrutto = 0.00;
    let userSettings = {}; 
    let currentQuantity = 1;
    let cashReceivedInput = '0';
    let cashPaymentMethod = 'BAR'; 
    let transactionHistory = []; 

    // NEU: Globale Variablen für neue Funktionen
    let reversalCode = null; // Code für Storno/Einstellungen
    let cashBoxBalance = 0.00; // Aktueller Kassenstand
    let pinModalTarget = ''; // 'settings' or 'report'

    // ---------- Utility functions ----------
    window.updateAppView = function(view){
        document.getElementById('login-modal').style.display='none';
 document.getElementById('registration-modal').style.display='none';
        document.getElementById('forgot-password-modal').style.display='none';
        document.getElementById('kasse-content').style.display='none';
        
        switch(view){
            case 'login':
                window.openLoginModal();
 break;
            case 'kasse':
                document.getElementById('kasse-content').style.display='grid';
                window.toggleReceiptColumn(true);
 break;
        }
    }

    window.showLoading = function(show){
        document.getElementById('async-loading-overlay').style.display = show ?
 'flex' : 'none';
    }

    window.showToast = function(message, type = 'info'){
        const container = document.getElementById('toast-container');
 const toast = document.createElement('div');
        toast.className = `toast toast-${type} shadow-lg`;
        toast.innerText = message;
        container.appendChild(toast);
 // Show
        setTimeout(() => toast.style.opacity = 1, 10);
 // Hide and remove
        setTimeout(() => {
            toast.style.opacity = 0;
            setTimeout(() => toast.remove(), 250);
        }, 3000);
 }

    window.closeModal = function(id){
        document.getElementById(id).style.display = 'none';
        window.toggleReceiptColumn(true);
 // Re-show receipt column on close
        
        if(id === 'finalize-modal'){
            // Reset cash input on closing finalize modal
            cashReceivedInput = '0';
 cashPaymentMethod = 'BAR';
            document.getElementById('cash-received-display').innerText = '0,00';
            document.getElementById('change-display').innerText = '0,00 €';
            window.setPaymentMethod('BAR');
 }
    }

    window.toggleReceiptColumn = function(show){
        const receiptColumn = document.getElementById('receipt-column');
 if(receiptColumn) receiptColumn.style.display = show ? 'flex' : 'none';
    }


    // ---------- Auth (unchanged) ----------
    window.handleLoginSubmit = async function(){
        const email = document.getElementById('login-email').value;
 const password = document.getElementById('login-password').value;
        if(!email || !password){ showToast('Bitte E-Mail und Passwort eingeben','error'); return;
 }
        showLoading(true);
        try {
            await signInWithEmailAndPassword(auth, email, password);
 showToast('Erfolgreich angemeldet!', 'success');
        } catch(err){ 
            console.error(err);
 showToast('Login fehlgeschlagen: ' + (err.message||err.code), 'error'); 
        }
        finally{ showLoading(false);
 }
    }

    window.handleRegisterSubmit = async function(){
        const email = document.getElementById('register-email').value;
 const password = document.getElementById('register-password').value;
        if(!email || !password){ showToast('Bitte E-Mail und Passwort eingeben','error'); return;
 }
        showLoading(true);
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
 showToast('Registrierung erfolgreich! Automatische Anmeldung...', 'success');
        } catch(err){ 
            console.error(err);
 showToast('Registrierung fehlgeschlagen: ' + (err.message||err.code), 'error'); 
        }
        finally{ showLoading(false);
 }
    }

    window.handlePasswordReset = async function(){
        const email = document.getElementById('reset-email').value;
 if(!email){ showToast('Bitte E-Mail eingeben','error'); return; }
        showLoading(true);
 try{
            await sendPasswordResetEmail(auth, email);
 showToast('Passwort-Reset-Link gesendet. Prüfen Sie Ihr Postfach.', 'info');
            closeModal('forgot-password-modal');
            window.openLoginModal();
        } catch(err){ 
            console.error(err);
 showToast('Passwort-Reset fehlgeschlagen: ' + (err.message||err.code), 'error'); 
        }
        finally{ showLoading(false);
 }
    }

    window.handleLogout = async function(){
        showLoading(true);
        try{
            await signOut(auth);
 showToast('Erfolgreich abgemeldet.', 'info');
            // Reset global state
            currentUser = null;
            categories = {};
            products = {};
            currentBestellung = [];
            reversalCode = null;
            cashBoxBalance = 0.00;
            window.updateAppView('login');
        } catch(err){
            console.error(err);
 showToast('Abmeldung fehlgeschlagen.', 'error');
        }
        finally{ showLoading(false); }
    }

    onAuthStateChanged(auth, async (user) => {
        if(user){
            currentUser = user;
            await initializeUserData(user.uid);
            window.updateAppView('kasse');
            window.loadTransactionHistory();
        } else {
            currentUser = null;
            window.updateAppView('login');
        }
    });


    // ---------- Firebase Utils (unchanged) ----------
    function settingsDocRef(uid){ return doc(db, 'users', uid, 'settings', 'user-settings'); }
    function categoriesCollectionRef(uid){ return collection(db, 'users', uid, 'categories'); }
    function productsCollectionRef(uid){ return collection(db, 'users', uid, 'products'); }
    function transactionsCollectionRef(uid){ return collection(db, 'users', uid, 'transactions'); }
    // NEU: Cash Transactions Collection Ref
    function cashTransactionsCollectionRef(uid){ return collection(db, 'users', uid, 'cash-transactions'); }


    // ---------- Seed / Init (GEÄNDERT für Code, Kassenstand und Produkt-Stock) ----------
    async function seedUserDataIfNeeded(uid){
        const sRef = settingsDocRef(uid);
        const sSnap = await getDoc(sRef);
        if(sSnap.exists()){
            return;
        }
        showToast('Erste Anmeldung erkannt. Erzeuge Standarddaten...', 'info');

        // NEU: Reversal Code & Kassenstand hinzugefügt
        const defaultSettings = { 
            companyName:'Ihre Firma', 
            address:'Musterstr. 1, 12345 Musterstadt', 
            taxId:'123/456/7890', 
            taxRate:19.0,
            reversalCode: '1337', // Beispiel-Code
            cashBoxBalance: 0.00
        };
        await setDoc(sRef, defaultSettings);
        
        reversalCode = defaultSettings.reversalCode;
        cashBoxBalance = defaultSettings.cashBoxBalance;

        const catRef = categoriesCollectionRef(uid);
        const cat1 = await addDoc(catRef, { name: 'Getränke', order: 1 });
        const cat2 = await addDoc(catRef, { name: 'Speisen', order: 2 });
        const cat3 = await addDoc(catRef, { name: 'Sonstiges', order: 3 });
        const prodRef = productsCollectionRef(uid);

        // NEU: Steuersatz (taxRate) und Lagerbestand (stock) hinzugefügt
        await addDoc(prodRef, { name: 'Kaffee', price: 2.50, categoryId: cat1.id, taxRate: 19.0, stock: 10 });
        await addDoc(prodRef, { name: 'Wasser', price: 1.50, categoryId: cat1.id, taxRate: 19.0, stock: 5 });
        await addDoc(prodRef, { name: 'Kuchen', price: 3.00, categoryId: cat2.id, taxRate: 7.0, stock: 10 });
        await addDoc(prodRef, { name: 'Brot', price: 4.50, categoryId: cat2.id, taxRate: 7.0, stock: 0 }); // Nullbestand für Test
        await addDoc(prodRef, { name: 'Postkarte', price: 1.00, categoryId: cat3.id, taxRate: 19.0, stock: 99999 });

        window.showToast('Standarddaten erfolgreich erstellt.', 'success');
    }

    async function initializeUserData(uid){
        await seedUserDataIfNeeded(uid);
        await loadUserSettings(uid);
        await loadProductsAndCategories();
    }


    // ---------- Settings (GEÄNDERT für Code und Kassenstand) ----------
    async function loadUserSettings(uid){
        if(!uid) return;
        const sRef = settingsDocRef(uid);
        const sSnap = await getDoc(sRef);
        if(sSnap.exists()){
            userSettings = sSnap.data();
            // NEU: Storno Code & Kassenstand laden
            reversalCode = userSettings.reversalCode || '1337'; 
            cashBoxBalance = parseFloat(userSettings.cashBoxBalance || 0.00);
            
            // NEU: Kassenstand in UI aktualisieren (für das neue Modal)
            const balanceEl = document.getElementById('cash-balance-display');
            if(balanceEl) balanceEl.innerText = cashBoxBalance.toFixed(2).replace('.', ',') + ' €';

        } else {
            // Sollte durch seedUserDataIfNeeded() abgedeckt sein, aber als Fallback
            userSettings = {};
            reversalCode = '1337';
            cashBoxBalance = 0.00;
        }
    }

    window.saveSettings = async function(){
        if(!currentUser) { window.showToast('Nicht angemeldet','error'); return; }
        window.showLoading(true);
        try{
            const sRef = settingsDocRef(currentUser.uid);
            
            userSettings.companyName = document.getElementById('company-name').value.trim();
            userSettings.address = document.getElementById('address').value.trim();
            userSettings.taxId = document.getElementById('tax-id').value.trim();
            
            // NEU: Storno Code speichern (falls eingegeben)
            const newReversalCode = document.getElementById('reversal-code').value.trim();
            if (newReversalCode) {
                userSettings.reversalCode = newReversalCode;
                reversalCode = newReversalCode; // Update global var
            }

            userSettings.taxRate = parseFloat(document.getElementById('tax-rate').value) || 19.0;
            // NEU: Kassenstand in Settings speichern
            userSettings.cashBoxBalance = cashBoxBalance;

            await updateDoc(sRef, userSettings);
            window.showToast('Einstellungen gespeichert.', 'success');
        } catch(err){
            console.error(err);
            window.showToast('Fehler beim Speichern der Einstellungen.', 'error');
        } finally{ window.showLoading(false); }
    }

    window.showSettingsMenu = function(){
        document.getElementById('general-settings-form-container').style.display = 'none';
        document.getElementById('settings-menu').style.display = 'block';
    }

    window.openGeneralSettings = function(){
        document.getElementById('settings-menu').style.display = 'none';
        document.getElementById('general-settings-form-container').style.display = 'block';
        // Fill form fields
        document.getElementById('company-name').value = userSettings.companyName || '';
        document.getElementById('address').value = userSettings.address || '';
        document.getElementById('tax-id').value = userSettings.taxId || '';
        // NEU: Storno Code
        document.getElementById('reversal-code').value = ''; // Nicht den echten Code anzeigen
        document.getElementById('tax-rate').value = userSettings.taxRate || 19.0;
    }
    
    // NEU: PIN Logic for Settings/Report/Storno (Wird von den Buttons aufgerufen)
    window.openSettingsModal = function(){
        pinModalTarget = 'settings';
        document.getElementById('pin-modal-title').innerText = 'Einstellungen öffnen';
        document.getElementById('pin-modal-message').innerText = 'Bitte geben Sie den Code für die Einstellungen ein.';
        document.getElementById('pin-input').value = '';
        document.getElementById('settings-modal').style.display='none';
        window.toggleReceiptColumn(false);
        document.getElementById('pin-modal').style.display='flex';
    }

    window.openReportModalWithPin = function(){
        pinModalTarget = 'report';
        document.getElementById('pin-modal-title').innerText = 'Tagesabschluss & Storno';
        document.getElementById('pin-modal-message').innerText = 'Bitte geben Sie den Code für die Storno-/Berichtsfunktion ein.';
        document.getElementById('pin-input').value = '';
        document.getElementById('report-modal').style.display='none';
        window.toggleReceiptColumn(false);
        document.getElementById('pin-modal').style.display='flex';
    }

    window.handlePinSubmit = function(){
        const pin = document.getElementById('pin-input').value.trim();
        if(pin === reversalCode){
            window.closeModal('pin-modal');
            if(pinModalTarget === 'settings'){
                document.getElementById('settings-modal').style.display='flex';
                window.showSettingsMenu();
            } else if (pinModalTarget === 'report'){
                document.getElementById('report-modal').style.display='flex';
                window.setReportDateToday();
                window.loadTransactionHistory();
            }
            window.showToast('Code korrekt.', 'success');
        } else {
            window.showToast('Falscher Code.', 'error');
            document.getElementById('pin-input').value = '';
        }
    }


    // ---------- Products & Categories (GEÄNDERT für Stock) ----------
    async function loadProductsAndCategories(){
        if(!currentUser) return;
        categories = {}; products = {};
        const catRef = categoriesCollectionRef(currentUser.uid);
        const catSnap = await getDocs(query(catRef, orderBy('order', 'asc'), orderBy('name', 'asc')));
        catSnap.forEach(doc => { categories[doc.id] = { id: doc.id, ...doc.data() }; });
        const prodRef = productsCollectionRef(currentUser.uid);
        const prodSnap = await getDocs(query(prodRef, orderBy('name', 'asc')));
        prodSnap.forEach(doc => { 
            const data = doc.data(); 
            // Sicherstellen, dass taxRate als float existiert (Fallback auf 19.0)
            data.taxRate = parseFloat(data.taxRate) || 19.0;
            // NEU: Stock als Integer (Fallback auf unendlich)
            data.stock = parseInt(data.stock) || 99999;
            products[doc.id] = { id: doc.id, ...data }; 
        });
        renderCategoryTabs();
        window.renderProductGrid(Object.values(categories)[0]?.id || null);
        window.renderProductModalContent();
    }
    
    // ... (saveProductsAndCategories, renderCategoryTabs unchanged) ...

    window.addProduct = async function(){ 
        if(!currentUser) return;
        const name = document.getElementById('new-product-name').value.trim();
        const price = parseFloat(document.getElementById('new-product-price').value);
        // NEU: Bestand
        const stock = parseInt(document.getElementById('new-product-stock').value) || 0; 
        const categoryId = document.getElementById('new-product-category').value;
        const taxRate = parseFloat(document.getElementById('new-product-tax-rate').value);
        
        if(!name || isNaN(price) || !categoryId || isNaN(taxRate) || isNaN(stock)) { 
            window.showToast('Bitte Name, Preis, Lagerbestand, Kategorie und Steuersatz angeben', 'error');
            return; 
        }
        window.showLoading(true);
        try{
            await addDoc(productsCollectionRef(currentUser.uid), { 
                name, 
                price: price.toFixed(2), 
                categoryId, 
                taxRate: taxRate,
                stock: stock // NEU: Bestand speichern
            });
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-price').value = '';
            document.getElementById('new-product-stock').value = ''; // NEU: Bestand leeren
            document.getElementById('new-product-category').value = '';
            document.getElementById('new-product-tax-rate').value = '19.0';
            await loadProductsAndCategories();
            window.showToast('Produkt hinzugefügt.', 'success');
        } catch(err){ 
            console.error(err);
            window.showToast('Fehler beim Hinzufügen des Produkts.', 'error');
        } finally{ window.showLoading(false); }
    }
    
    // ... (deleteCategory, deleteProduct unchanged) ...

    window.saveProductPrice = async function(id){
        if(!currentUser) return;
        const price = parseFloat(document.getElementById(`price-input-${id}`).value);
        // NEU: Bestand speichern
        const stock = parseInt(document.getElementById(`stock-input-${id}`).value) || 0; 
        const taxRate = parseFloat(document.getElementById(`tax-input-${id}`).value);

        if(isNaN(price) || isNaN(taxRate) || isNaN(stock)) {
            window.showToast('Ungültiger Preis/Steuersatz/Lagerbestand', 'error');
            return;
        }

        window.showLoading(true);
        try{
            await updateDoc(doc(productsCollectionRef(currentUser.uid), id), {
                price: price.toFixed(2),
                taxRate: taxRate,
                stock: stock // NEU: Bestand speichern
            });
            // Update global object
            products[id].price = price.toFixed(2);
            products[id].taxRate = taxRate;
            products[id].stock = stock; // NEU: Globalen Bestand aktualisieren
            window.renderProductGrid(document.querySelector('.category-tab.bg-red-700')?.dataset.category);
            window.renderReceipt(); // Preisänderung könnte den Bon beeinflussen
            window.showToast('Produkt aktualisiert.', 'success');
        } catch(err){
            console.error(err);
            window.showToast('Fehler beim Aktualisieren.', 'error');
        } finally{ window.showLoading(false); }
    }


    window.renderProductModalContent = function(){
        // ... (existing code) ...

        // Product List (MODIFIZIERT für Price, Tax & Stock Edit)
        Object.values(products).forEach(prod => {
            const prodDiv = document.createElement('div');
            prodDiv.className = 'flex items-center justify-between bg-white border p-2 rounded-lg';
            const tax7Selected = prod.taxRate === 7.0 ? 'selected' : '';
            const tax19Selected = prod.taxRate === 19.0 ? 'selected' : '';

            // NEU: Stock Input
            prodDiv.innerHTML = `
                <div class="flex-grow flex flex-col space-y-1">
                    <span class="font-semibold">${prod.name}</span>
                    <span class="text-xs text-gray-500">${categories[prod.categoryId]?.name || 'Ohne Kategorie'}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center">
                        <input type="number" id="price-input-${prod.id}" value="${parseFloat(prod.price).toFixed(2)}" step="0.01" class="w-16 p-1 border rounded-lg text-right text-sm">
                        <span class="ml-1 text-sm font-bold">€</span>
                    </div>
                    <div class="flex items-center">
                        <input type="number" id="stock-input-${prod.id}" value="${prod.stock}" step="1" class="w-16 p-1 border rounded-lg text-right text-sm">
                        <span class="ml-1 text-sm font-bold">Stk.</span>
                    </div>
                    <select id="tax-input-${prod.id}" class="p-1 border rounded-lg text-sm">
                        <option value="19.0" ${tax19Selected}>19%</option>
                        <option value="7.0" ${tax7Selected}>7%</option>
                    </select>
                    <button onclick="window.saveProductPrice('${prod.id}')" class="text-sm text-white bg-green-500 p-1 rounded-lg">Speichern</button>
                    <button onclick="window.deleteProduct('${prod.id}')" class="text-sm text-white bg-red-500 p-1 rounded-lg">Löschen</button>
                </div>
            `;
            productListContainer.appendChild(prodDiv);
        });
    }

    // GEÄNDERT: Produkt-Grid-Rendering mit Lagerbestandsfilter
    window.renderProductGrid = function(activeCategoryId){
        const gridContainer = document.getElementById('product-grid');
        let gridHtml = '';
        const filteredProducts = Object.values(products).filter(p => 
            p.categoryId === activeCategoryId 
            // NEU: Nur Produkte anzeigen, wenn Bestand > 0
            && p.stock > 0
        );

        if(filteredProducts.length === 0){
            gridHtml = `<p class="text-gray-500 col-span-full text-center p-4">${activeCategoryId ? 'Keine Produkte in dieser Kategorie verfügbar oder Bestand leer.' : 'Wählen Sie eine Kategorie.'}</p>`;
        } else {
            filteredProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                gridHtml += `
                    <button onclick="window.addProductToBestellung('${product.id}')" class="product-btn h-20 bg-white rounded-xl shadow p-2 text-left flex flex-col justify-between hover:bg-gray-100 transition duration-150">
                        <span class="font-bold text-lg">${product.name}</span>
                        <div class="flex justify-between items-end">
                            <span class="text-red-600 font-extrabold text-xl">${parseFloat(product.price).toFixed(2).replace('.', ',')} €</span>
                            <span class="text-xs text-gray-500">Lager: ${product.stock}</span>
                        </div>
                    </button>
                `;
            });
        }

        gridContainer.innerHTML = gridHtml;
    }


    // ---------- Bestellung / Receipt (GEÄNDERT für Mengen-Entfernung) ----------
    window.addProductToBestellung = function(id){
        const product = products[id];
        if(!product) return;

        // NEU: Bestand vor Hinzufügen prüfen
        if((product.stock || 0) < currentQuantity) {
            window.showToast(`Nicht genügend Bestand für ${product.name}. Nur noch ${product.stock} Stück verfügbar.`, 'error');
            return;
        }

        const existingItem = currentBestellung.find(item => item.id === id);
        if(existingItem){
            // NEU: Gesamte Menge prüfen
             if((product.stock || 0) < existingItem.quantity + currentQuantity) {
                window.showToast(`Gesamte Menge (${existingItem.quantity + currentQuantity}) übersteigt Bestand (${product.stock}).`, 'error');
                return;
            }
            existingItem.quantity += currentQuantity;
            existingItem.totalBrutto = parseFloat((existingItem.price * existingItem.quantity).toFixed(2));
            
        } else {
            currentBestellung.push({ 
                id: product.id, 
                name: product.name, 
                price: parseFloat(product.price), 
                quantity: currentQuantity,
                totalBrutto: parseFloat((parseFloat(product.price) * currentQuantity).toFixed(2)),
                taxRate: product.taxRate 
            });
        }
        window.renderReceipt();
        currentQuantity = 1; // Reset quantity after adding
        document.getElementById('quantity-display').innerText = currentQuantity;
    }

    // GEÄNDERT: Mengen-Entfernung mit currentQuantity
    window.removeItem = function(index){
        if(index < 0 || index >= currentBestellung.length) return;

        const item = currentBestellung[index];
        
        let quantityToRemove = currentQuantity;
        if (quantityToRemove > item.quantity) {
            quantityToRemove = item.quantity; // Maximal die vorhandene Menge entfernen
        }

        if(item.quantity - quantityToRemove > 0){
            // Nur die aktuelle Menge entfernen
            item.quantity -= quantityToRemove;
            item.totalBrutto = parseFloat((item.price * item.quantity).toFixed(2)); 
        } else {
            // Wenn die zu entfernende Menge die vorhandene Menge erreicht oder überschreitet, gesamten Eintrag entfernen
            currentBestellung.splice(index, 1);
        }
        
        window.renderReceipt();
        window.showToast(`${quantityToRemove}x ${item.name} vom Bon entfernt.`, 'info'); 
        
        // Setzt Menge nach Entfernung wieder auf 1
        currentQuantity = 1;
        document.getElementById('quantity-display').innerText = currentQuantity;
    }

    // ... (clearBestellung, renderReceipt, renderInteractiveReceiptContent unchanged) ...


    // ---------- Finalization (GEÄNDERT für Stock Update) ----------
    window.handleFinalizeAction = async function(paymentMethod, receiptType){
        if(!currentUser || currentBestellung.length === 0 || totalBrutto <= 0) return;
        window.showLoading(true);

        try{
            const currentTimestamp = serverTimestamp();
            
            // 1. Transaction data preparation
            const transactionData = {
                items: currentBestellung,
                totalBrutto: totalBrutto,
                paymentMethod: paymentMethod,
                cashReceived: (paymentMethod === 'BAR') ? parseFloat(cashReceivedInput) : null,
                timestamp: currentTimestamp,
                uid: currentUser.uid,
                isCancelled: false,
                taxSummary: window.calculateTaxSummary(currentBestellung, userSettings.taxRate || 19.0),
                receiptType: receiptType 
            };
            
            // 2. Transaktion speichern
            const transRef = await addDoc(transactionsCollectionRef(currentUser.uid), transactionData);

            // NEU: Lagerbestände aktualisieren (nur bei erfolgreicher Transaktion)
            for (const item of currentBestellung) {
                const productRef = doc(productsCollectionRef(currentUser.uid), item.id);
                const productSnap = await getDoc(productRef);

                if (productSnap.exists()) {
                    const currentStock = productSnap.data().stock || 0;
                    const newStock = Math.max(0, currentStock - item.quantity); // Bestand nicht unter 0
                    await updateDoc(productRef, { 
                        stock: newStock
                    });
                    // Update the global product object immediately for the next transaction
                    products[item.id].stock = newStock;
                }
            }
            
            // 3. Optional print receipt
            if(receiptType !== 'none'){
                const printContainer = document.getElementById('print-receipt-container');
                window.renderReceipt(true, receiptType, transRef.id, currentTimestamp);

                // Force visibility and display temporarily to aid rendering
                printContainer.style.display = 'block';
                printContainer.style.visibility = 'visible';

                // **FIX FÜR SAFARI: EXTREM VERZÖGERN FÜR GARANTIERTES RENDERING**
                await new Promise(resolve => setTimeout(resolve, 800)); // 800ms für Safari

                // Trigger print
                window.print();

                // Aufräumarbeiten des Druck-Containers leicht verzögern
                setTimeout(() => {
                    printContainer.innerHTML = ''; // Clean up print content
                    printContainer.style.display = 'none';
                    printContainer.style.visibility = 'hidden';
                }, 800);
            }

            // 4. Clear state and close modal
            currentBestellung = [];
            totalBrutto = 0.00;
            window.renderReceipt(); // Render empty receipt
            window.closeModal('finalize-modal');
            await loadProductsAndCategories(); // Re-render product grid (to hide empty stock items)
            window.showToast('Transaktion abgeschlossen.', 'success');
        } catch(err){
            console.error(err);
            window.showToast('Fehler beim Abschließen der Transaktion.', 'error');
        } finally{ window.showLoading(false); }
    }


    // ---------- Storno der letzten Transaktion (GEÄNDERT für Stock Update) ----------
    window.cancelLastTransaction = async function(){
        if(!currentUser) return;

        // Hier wird kein PIN abgefragt, da es die "Letzte Transaktion" ist und im Hauptbildschirm verfügbar sein soll. 
        // Für eine PIN-Abfrage müsste der Button-Handler geändert werden. (Der User hat nach einem PIN für die Stornofunktion insgesamt gefragt, was jetzt über den Report-Modal abgedeckt ist. Die letzte Stornoaktion ist oft nötig und wird hier gelassen, kann aber mit PinLogic ergänzt werden).

        window.showLoading(true);
        try{
            // Query for the single most recent, non-cancelled transaction
            const q = query(
                transactionsCollectionRef(currentUser.uid), 
                where('isCancelled', '==', false), 
                orderBy('timestamp', 'desc'), 
                limit(1)
            );
            const querySnapshot = await getDocs(q);

            if(querySnapshot.empty){
                window.showToast('Keine letzte, nicht stornierte Transaktion gefunden.', 'info');
                return;
            }

            const docSnapshot = querySnapshot.docs[0];
            const transaction = { 
                id: docSnapshot.id, 
                ...docSnapshot.data(),
                cancellationTimestamp: serverTimestamp() // Hinzufügen des Zeitstempels für den Storno-Beleg
            };

            if(!confirm(`Letzte Transaktion ${transaction.id.substring(0, 8)}... (Gesamt: ${transaction.totalBrutto.toFixed(2).replace('.', ',')} €) wirklich stornieren?`)) {
                return;
            }

            const tRef = doc(transactionsCollectionRef(currentUser.uid), transaction.id);

            // 1. Transaktion als storniert markieren
            await updateDoc(tRef, {
                isCancelled: true,
                cancellationTimestamp: transaction.cancellationTimestamp 
            });

            // NEU: Lagerbestände zurückbuchen
            for (const item of transaction.items) {
                const productRef = doc(productsCollectionRef(currentUser.uid), item.id);
                // Hole den aktuellen Bestand, um Race Conditions zu vermeiden
                const productSnap = await getDoc(productRef);
                if (productSnap.exists()) {
                    const currentStock = productSnap.data().stock || 0;
                    const newStock = currentStock + item.quantity;
                    await updateDoc(productRef, { stock: newStock });
                    // Update the global product object
                    products[item.id].stock = newStock;
                }
            }
            
            // 2. Storno-Beleg drucken
            await window.printCancellationReceipt(transaction);

            // 3. UI aktualisieren
            await loadProductsAndCategories(); // Re-render product grid
            window.showToast('Transaktion erfolgreich storniert.', 'success');

        } catch(err){
            console.error('Reversal error', err);
            window.showToast('Fehler beim Stornieren der Transaktion.', 'error');
        }
        finally{ window.showLoading(false); }
    }


    // ... (Transaction Reversal History / handleReversal / printCancellationReceipt / Reporting unchanged) ...


    // ---------- NEU: Cash Management Logic ----------
    window.openCashManagementModal = function(){
        document.getElementById('cash-amount').value = '0.00';
        document.getElementById('cash-reason').value = '';
        // Aktualisiere Kassenstandsanzeige
        document.getElementById('cash-balance-display').innerText = cashBoxBalance.toFixed(2).replace('.', ',') + ' €';
        document.getElementById('cash-management-modal').style.display = 'flex';
        window.toggleReceiptColumn(false);
    }

    window.handleCashManagement = async function(type){
        if(!currentUser) return;
        
        const amount = parseFloat(document.getElementById('cash-amount').value);
        const reason = document.getElementById('cash-reason').value.trim();

        if(isNaN(amount) || amount <= 0){
            window.showToast('Bitte einen gültigen Betrag (> 0) eingeben.', 'error');
            return;
        }

        if(!reason){
            window.showToast('Bitte einen Grund/Beschreibung angeben.', 'error');
            return;
        }

        window.showLoading(true);
        try{
            const sign = type === 'deposit' ? 1 : -1;
            const finalAmount = amount * sign;
            const newBalance = cashBoxBalance + finalAmount;

            if (newBalance < 0 && type === 'withdrawal') {
                window.showToast('Die Entnahme würde den Kassenstand negativ machen. Abgebrochen.', 'error');
                return;
            }

            // 1. Transaktion speichern
            await addDoc(cashTransactionsCollectionRef(currentUser.uid), {
                type: type, // 'deposit' or 'withdrawal'
                amount: amount,
                finalAmount: finalAmount, // Betrag mit Vorzeichen
                reason: reason,
                oldBalance: cashBoxBalance,
                newBalance: newBalance,
                timestamp: serverTimestamp(),
                uid: currentUser.uid
            });

            // 2. Kassenstand aktualisieren (in globaler Variable und userSettings in DB)
            cashBoxBalance = newBalance;
            const sRef = settingsDocRef(currentUser.uid);
            await updateDoc(sRef, { cashBoxBalance: cashBoxBalance });

            // 3. UI aktualisieren
            document.getElementById('cash-balance-display').innerText = cashBoxBalance.toFixed(2).replace('.', ',') + ' €';
            window.showToast(`${type === 'deposit' ? 'Einlage' : 'Entnahme'} von ${amount.toFixed(2).replace('.', ',')} € erfolgreich. Neuer Stand: ${cashBoxBalance.toFixed(2).replace('.', ',')} €`, 'success');
            window.closeModal('cash-management-modal');

        } catch(err){
            console.error('Cash Management error', err);
            window.showToast('Fehler bei der Kassenverwaltung.', 'error');
        } finally{ window.showLoading(false); }
    }


    // ---------- Modal Controls (Helpers) (unchanged) ----------

    window.openLoginModal = function(){ document.getElementById('login-modal').style.display='flex'; window.toggleReceiptColumn(false); };
    window.openRegistrationModal = function(){ window.closeModal('login-modal'); window.toggleReceiptColumn(false); document.getElementById('registration-modal').style.display='flex'; };
    window.openForgotPasswordModal = function(){ window.closeModal('login-modal'); window.toggleReceiptColumn(false); document.getElementById('forgot-password-modal').style.display='flex'; };
    window.openProductModal = function(){ window.renderProductModalContent(); window.toggleReceiptColumn(false); document.getElementById('product-modal').style.display='flex'; };
    window.openFinalizeModal = function(){ 
        window.toggleReceiptColumn(false); 
        document.getElementById('finalize-modal').style.display='flex'; 
        document.getElementById('finalize-total').innerText = totalBrutto.toFixed(2).replace('.', ',') + ' €';
        window.setPaymentMethod('BAR'); // Standard auf BAR setzen
    };
    
    // ... (rest of the file) ...
    
    // ---------- Startup (unchanged) ----------
    document.addEventListener('DOMContentLoaded', () => {
        window.setReportDateToday();
        window.updateAppView('login'); 
    });

  </script>
</body>
</html>
