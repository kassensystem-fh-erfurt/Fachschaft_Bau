<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem — Komplett</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial; background:#f7f7f7; }
    .numpad-btn { height:50px; display:flex; justify-content:center; align-items:center; }
    .product-btn:active { transform: scale(0.98); }
    #async-loading-overlay { position: fixed; inset:0; background: rgba(255,255,255,0.8); z-index:100; display:none; justify-content:center; align-items:center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #b91c1c; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #toast-container { position: fixed; top:1rem; right:1rem; z-index:1000; pointer-events:none; }
    .toast { padding:.75rem 1rem; border-radius:.5rem; color:#fff; margin-bottom:.5rem; opacity:0; transition: opacity .25s ease; }
    .toast-success{ background:#16a34a } .toast-error{ background:#dc2626 } .toast-info{ background:#2563eb }

    /* Druckbereich (Bondrucker 80mm) */
    #print-receipt-container { display:none; visibility:hidden; }
    .receipt-print { font-family: 'Consolas', 'Courier New', monospace; }
    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container { visibility: visible !important; display:block !important; position:absolute !important; left:0; top:0; width:80mm !important; font-size:12px !important; color:#000 !important; padding:2px !important; line-height:1.2 !important; }
      #print-receipt-container * { visibility: visible !important; }
      .receipt-print .line { display:flex; justify-content:space-between; margin-bottom:2px; }
    }

    .hidden-important { display:none !important; }
    /* small modal */
    .modal-backdrop { background: rgba(0,0,0,0.6); }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6 bg-red-500/5 overflow-x-hidden">

  <div id="async-loading-overlay"><div class="spinner"></div></div>
  <div id="toast-container"></div>

  <!-- LOGIN modal (simple) -->
  <div id="login-modal" class="fixed inset-0 modal-backdrop z-[999] flex items-center justify-center" style="display:flex;">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h1 class="text-2xl font-bold text-center text-red-700 mb-3">Kassensystem</h1>
      <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
        <label class="block text-sm">E-Mail</label>
        <input id="login-email" type="email" class="w-full p-2 border rounded mb-3" required>
        <label class="block text-sm">Passwort</label>
        <input id="login-password" type="password" class="w-full p-2 border rounded mb-4" required>
        <div class="flex gap-2">
          <button type="submit" class="flex-1 p-2 bg-red-600 text-white rounded">Anmelden</button>
          <button type="button" onclick="openRegisterModal()" class="flex-1 p-2 bg-gray-200 rounded">Registrieren</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Registration modal -->
  <div id="register-modal" class="fixed inset-0 modal-backdrop z-[999] hidden items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-xl font-bold mb-3">Registrieren</h2>
      <input id="reg-email" type="email" placeholder="E-Mail" class="w-full p-2 border rounded mb-2">
      <input id="reg-password" type="password" placeholder="Passwort (min 6)" class="w-full p-2 border rounded mb-4">
      <div class="flex gap-2">
        <button onclick="handleRegister()" class="flex-1 p-2 bg-green-600 text-white rounded">Registrieren</button>
        <button onclick="closeRegisterModal()" class="flex-1 p-2 bg-gray-200 rounded">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Top bar with Settings (opens modal) -->
  <div class="bg-white p-3 rounded-xl shadow mb-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-red-700">Kasse</h1>
    <div class="flex items-center gap-2">
      <button onclick="openSettingsModal()" class="px-4 py-2 bg-gray-700 text-white rounded-lg">Einstellungen</button>
      <button onclick="handleLogout()" class="px-4 py-2 bg-red-600 text-white rounded-lg">Logout</button>
    </div>
  </div>

  <!-- Main layout: Product grid left, Receipt right -->
  <div id="kasse-content" class="grid md:grid-cols-3 gap-4">
    <div class="md:col-span-2 space-y-4">
      <div id="category-tabs" class="flex space-x-2 overflow-x-auto"></div>
      <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 bg-white p-3 rounded-xl shadow min-h-[300px]">
        <p class="text-gray-500 col-span-full text-center p-4">Produkte werden geladen...</p>
      </div>

      <div class="bg-white p-4 rounded-xl shadow grid grid-cols-4 gap-4">
        <div>
          <div class="text-sm font-bold mb-1">Aktuelle Menge</div>
          <div id="quantity-display" class="bg-red-100 text-red-600 rounded p-2 text-center text-xl font-bold">1</div>
        </div>
        <div class="col-span-3 grid grid-cols-3 gap-2">
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('7')">7</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('8')">8</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('9')">9</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('4')">4</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('5')">5</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('6')">6</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('1')">1</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('2')">2</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('3')">3</button>
          <button class="numpad-btn bg-red-500 text-white rounded" onclick="handleQuantityInput('clear')">C</button>
          <button class="numpad-btn bg-gray-200 rounded" onclick="handleQuantityInput('0')">0</button>
          <button class="numpad-btn bg-green-500 text-white rounded" onclick="handleQuantityInput('+')">+</button>
        </div>
      </div>
    </div>

    <div id="receipt-column" class="flex flex-col space-y-4">
      <div class="bg-white p-4 rounded-xl shadow flex-grow flex flex-col">
        <h2 class="text-lg font-bold text-red-700 mb-2">Aktueller Bon</h2>
        <div id="receipt-content-interactive" class="flex-grow overflow-y-auto space-y-2">
          <p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>
        </div>
        <div class="border-t pt-2 flex justify-between items-center">
          <button onclick="clearBestellung()" class="text-red-500">Leeren</button>
          <span id="total-display" class="text-2xl font-extrabold text-red-700">GESAMT: 0,00 €</span>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow space-y-2">
        <button onclick="openFinalizeModal()" id="btn-finalize" disabled class="w-full p-3 bg-green-600 text-white rounded-xl">Zahlung abschließen</button>
        <button onclick="cancelLastTransaction()" class="w-full p-3 bg-red-700 text-white rounded-xl">Letzte Rechnung stornieren</button>
        <button onclick="openSettingsModal()" class="w-full p-3 bg-gray-500 text-white rounded-xl">Einstellungen</button>
      </div>
    </div>
  </div>

  <!-- Print area -->
  <div id="print-receipt-container" class="receipt-print"></div>

  <!-- SETTINGS MODAL (Variante B; Tabs enthalten) -->
  <div id="settings-modal" class="fixed inset-0 modal-backdrop z-[999] hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">Einstellungen</h2>

      <div class="flex space-x-2 mb-6 border-b pb-2">
        <button id="tab-produkte" onclick="openSettingsTab('produkte')" class="px-4 py-2 rounded-lg bg-gray-200 font-semibold">Produkte</button>
        <button id="tab-kassenbuch" onclick="openSettingsTab('kassenbuch')" class="px-4 py-2 rounded-lg">Kassenbuch</button>
        <button id="tab-verlauf" onclick="openSettingsTab('verlauf')" class="px-4 py-2 rounded-lg">Verlauf</button>
        <button id="tab-tagesabschluss" onclick="openSettingsTab('tagesabschluss')" class="px-4 py-2 rounded-lg">Tagesabschluss</button>
      </div>

      <div id="settings-content" class="space-y-4">
        <!-- Produkte -->
        <div id="tabcontent-produkte">
          <div class="flex justify-between items-center mb-3">
            <h3 class="text-xl font-bold">Produkte verwalten</h3>
            <button onclick="openProductForm()" class="px-3 py-2 bg-green-600 text-white rounded">+ Produkt</button>
          </div>
          <div id="product-list" class="space-y-2"></div>
        </div>

        <!-- Kassenbuch -->
        <div id="tabcontent-kassenbuch" class="hidden">
          <h3 class="text-xl font-bold mb-2">Kassenbuch</h3>
          <div class="flex items-center gap-2 mb-3">
            <input id="kassenbuch-betrag" type="number" step="0.01" placeholder="Betrag" class="p-2 border rounded w-36">
            <button onclick="kassenbuchEinlage()" class="p-2 bg-blue-600 text-white rounded">Einlage</button>
            <button onclick="kassenbuchEntnahme()" class="p-2 bg-red-600 text-white rounded">Entnahme</button>
          </div>
          <div id="kassenbuch-list" class="space-y-2"></div>
        </div>

        <!-- Verlauf -->
        <div id="tabcontent-verlauf" class="hidden">
          <h3 class="text-xl font-bold mb-2">Transaktionsverlauf</h3>
          <div id="verlauf-list" class="space-y-2"></div>
        </div>

        <!-- Tagesabschluss -->
        <div id="tabcontent-tagesabschluss" class="hidden">
          <h3 class="text-xl font-bold mb-2">Tagesabschluss (Z-Bericht)</h3>
          <div class="flex gap-2 mb-3">
            <input id="report-date" type="date" class="p-2 border rounded" />
            <button onclick="setReportDateToday()" class="p-2 bg-red-500 text-white rounded">Heute</button>
            <button onclick="generateZReport()" class="p-2 bg-gray-700 text-white rounded">Generieren</button>
            <button onclick="downloadZReportCSV()" class="p-2 bg-indigo-600 text-white rounded">CSV herunterladen</button>
          </div>
          <pre id="zbericht-output" class="mt-4 p-3 bg-gray-100 rounded-lg whitespace-pre-wrap min-h-[160px]"></pre>
        </div>
      </div>

      <div class="mt-6 text-right">
        <button onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg">Schließen</button>
      </div>
    </div>
  </div>

  <!-- Product Form Modal (small central modal) -->
  <div id="product-form-modal" class="fixed inset-0 modal-backdrop z-[999] hidden items-center justify-center p-4">
    <div class="bg-white p-5 rounded-xl shadow max-w-md w-full">
      <h3 id="product-form-title" class="text-xl font-bold mb-3">Produkt</h3>
      <input id="form-product-id" type="hidden" />
      <label class="block text-sm">Name</label>
      <input id="form-product-name" class="w-full p-2 border rounded mb-2" />
      <label class="block text-sm">Preis (Brutto €)</label>
      <input id="form-product-price" type="number" step="0.01" class="w-full p-2 border rounded mb-2" />
      <label class="block text-sm">Lagerbestand</label>
      <input id="form-product-stock" type="number" class="w-full p-2 border rounded mb-2" />
      <label class="block text-sm">MwSt (%)</label>
      <input id="form-product-tax" type="number" class="w-full p-2 border rounded mb-3" value="19" />
      <div class="flex gap-2 justify-end">
        <button onclick="closeProductForm()" class="px-3 py-2 bg-gray-200 rounded">Abbrechen</button>
        <button onclick="saveProductFromForm()" id="form-save-btn" class="px-3 py-2 bg-green-600 text-white rounded">Speichern</button>
        <button onclick="deleteProductFromForm()" id="form-delete-btn" class="px-3 py-2 bg-red-600 text-white rounded hidden">Löschen</button>
      </div>
    </div>
  </div>

<script type="module">
  // ----------------- Firebase v9 (modular) -----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
  import { getAuth, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, setDoc, getDocs, getDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // --- Deine Firebase Config (wie angegeben) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
    authDomain: "kassensystem-85412.firebaseapp.com",
    databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kassensystem-85412",
    storageBucket: "kassensystem-85412.firebasestorage.app",
    messagingSenderId: "916536785810",
    appId: "1:916536785810:web:0d0319ef565af65d279f4b",
    measurementId: "G-W5HWYEXWJ5"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) { /* analytics optional */ }

  const auth = getAuth(app);
  const db = getFirestore(app);

  // ----------------- Global State -----------------
  let currentUser = null;
  let categories = {};   // optional categories support
  let products = {};
  let productsInventory = {};
  let currentBestellung = [];
  let currentQuantity = 1;
  let userSettings = {};

  // ----------------- UI helpers -----------------
  function showLoading(show){ document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none'; }
  function showToast(message, type='info'){
    const container = document.getElementById('toast-container');
    const t = document.createElement('div'); t.className = 'toast toast-'+type; t.innerText = message; container.appendChild(t);
    setTimeout(()=> t.style.opacity = 1, 10);
    setTimeout(()=> { t.style.opacity = 0; setTimeout(()=> t.remove(), 300); }, 3000);
  }

  // ----------------- Auth -----------------
  window.handleLogin = async () => {
    const email = document.getElementById('login-email').value;
    const pwd = document.getElementById('login-password').value;
    if(!email || !pwd) { showToast('E-Mail & Passwort erforderlich','error'); return; }
    showLoading(true);
    try { await signInWithEmailAndPassword(auth, email, pwd); document.getElementById('login-modal').style.display = 'none'; showToast('Erfolgreich angemeldet','success'); }
    catch(e){ console.error(e); showToast('Login fehlgeschlagen','error'); }
    finally{ showLoading(false); }
  };

  window.openRegisterModal = ()=> { document.getElementById('register-modal').style.display='flex'; };
  window.closeRegisterModal = ()=> { document.getElementById('register-modal').style.display='none'; };

  window.handleRegister = async () => {
    const email = document.getElementById('reg-email').value;
    const pwd = document.getElementById('reg-password').value;
    if(!email || !pwd){ showToast('E-Mail & Passwort erforderlich','error'); return; }
    showLoading(true);
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pwd);
      // seed minimal user doc
      await setDoc(doc(db,'users',cred.user.uid), { canCancelTransaction: false }, { merge:true });
      showToast('Registrierung erfolgreich. Bitte anmelden.','success');
      closeRegisterModal();
    } catch(e){ console.error(e); showToast('Registrierung fehlgeschlagen','error'); }
    finally{ showLoading(false); }
  };

  window.handleLogout = async () => {
    showLoading(true);
    try { await signOut(auth); location.reload(); } catch(e){ console.error(e); showToast('Logout fehlgeschlagen','error'); } finally{ showLoading(false); }
  };

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if(user){
      // hide login modal if visible
      document.getElementById('login-modal').style.display = 'none';
      // load initial data
      await seedIfNeeded(user.uid);
      await loadProducts();
      await loadKassenbuch();
      await loadVerlauf();
    } else {
      document.getElementById('login-modal').style.display = 'flex';
    }
  });

  // ----------------- Seed default data if new user -----------------
  async function seedIfNeeded(uid){
    try {
      const sRef = doc(db,'users',uid,'meta','settings');
      const sSnap = await getDoc(sRef);
      if(sSnap.exists()) return;
    } catch(e){}
    showToast('Erste Anmeldung: Standarddaten werden erzeugt...','info');
    await setDoc(doc(db,'users',uid,'meta','settings'),'dummy', { merge:true }).catch(()=>{});
    // create minimal category and product collection
    const catCol = collection(db,'users',uid,'categories');
    const prodCol = collection(db,'users',uid,'products');
    await addDoc(catCol, { name:'Getränke', order:1 }).catch(()=>{});
    await addDoc(prodCol, { name:'Kaffee', price:2.50, stock:50, taxRate:19, categoryId:null }).catch(()=>{});
    await addDoc(prodCol, { name:'Wasser', price:1.50, stock:100, taxRate:19, categoryId:null }).catch(()=>{});
  }

  // ----------------- Products CRUD (modal form) -----------------
  function openSettingsModal(){ document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('settings-modal').classList.add('flex'); openSettingsTab('produkte'); }
  function closeSettingsModal(){ document.getElementById('settings-modal').classList.add('hidden'); document.getElementById('settings-modal').classList.remove('flex'); }

  function openSettingsTab(tab){
    const tabs = ['produkte','kassenbuch','verlauf','tagesabschluss'];
    tabs.forEach(t => {
      document.getElementById('tab-'+t).classList.remove('bg-gray-200');
      document.getElementById('tabcontent-'+t).classList.add('hidden');
    });
    document.getElementById('tab-'+tab).classList.add('bg-gray-200');
    document.getElementById('tabcontent-'+tab).classList.remove('hidden');
    // load corresponding content if needed
    if(tab === 'produkte') loadProducts();
    if(tab === 'kassenbuch') loadKassenbuch();
    if(tab === 'verlauf') loadVerlauf();
  }

  async function loadProducts(){
    if(!currentUser) return;
    const list = document.getElementById('product-list');
    list.innerHTML = '<p class="text-gray-500">Lade Produkte...</p>';
    try {
      const col = collection(db,'users',currentUser.uid,'products');
      const snaps = await getDocs(query(col, orderBy('name')));
      list.innerHTML = '';
      products = {};
      productsInventory = {};
      snaps.forEach(s => {
        const p = { id:s.id, ...s.data() };
        products[p.id] = p;
        productsInventory[p.id] = typeof p.stock === 'number' ? p.stock : 9999;
        const el = document.createElement('div');
        el.className = 'p-2 border rounded flex justify-between items-center';
        el.innerHTML = `<div><div class="font-semibold">${escapeHtml(p.name)}</div><div class="text-xs text-gray-600">Preis: ${Number(p.price||0).toFixed(2)} € | Lager: ${p.stock ?? 'n/a'} | MwSt: ${p.taxRate ?? 19}%</div></div>`;
        const actions = document.createElement('div');
        const edit = document.createElement('button'); edit.className='px-2 py-1 bg-yellow-400 rounded mr-2'; edit.innerText='Bearb'; edit.onclick = ()=> openProductForm(p);
        const del = document.createElement('button'); del.className='px-2 py-1 bg-red-600 text-white rounded'; del.innerText='Löschen'; del.onclick = async ()=> { if(!confirm('Produkt löschen?')) return; await deleteDoc(doc(db,'users',currentUser.uid,'products',p.id)); loadProducts(); };
        actions.appendChild(edit); actions.appendChild(del); el.appendChild(actions);
        list.appendChild(el);
      });
      // also render product-grid in main kasse area
      renderProductGrid();
    } catch(e){ console.error(e); list.innerHTML = '<p class="text-red-500">Fehler beim Laden</p>'; }
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

  // Product form operations
  function openProductForm(product = null){
    document.getElementById('product-form-modal').style.display = 'flex';
    document.getElementById('product-form-modal').classList.add('flex');
    if(product){
      document.getElementById('product-form-title').innerText = 'Produkt bearbeiten';
      document.getElementById('form-product-id').value = product.id;
      document.getElementById('form-product-name').value = product.name || '';
      document.getElementById('form-product-price').value = product.price ?? 0;
      document.getElementById('form-product-stock').value = product.stock ?? 0;
      document.getElementById('form-product-tax').value = product.taxRate ?? 19;
      document.getElementById('form-delete-btn').classList.remove('hidden');
    } else {
      document.getElementById('product-form-title').innerText = 'Neues Produkt';
      document.getElementById('form-product-id').value = '';
      document.getElementById('form-product-name').value = '';
      document.getElementById('form-product-price').value = '';
      document.getElementById('form-product-stock').value = 0;
      document.getElementById('form-product-tax').value = 19;
      document.getElementById('form-delete-btn').classList.add('hidden');
    }
  }

  function closeProductForm(){
    document.getElementById('product-form-modal').style.display = 'none';
    document.getElementById('product-form-modal').classList.remove('flex');
  }

  async function saveProductFromForm(){
    if(!currentUser){ alert('Nicht angemeldet'); return; }
    const id = document.getElementById('form-product-id').value;
    const name = document.getElementById('form-product-name').value.trim();
    const price = parseFloat(document.getElementById('form-product-price').value) || 0;
    const stock = parseInt(document.getElementById('form-product-stock').value) || 0;
    const taxRate = parseFloat(document.getElementById('form-product-tax').value) || 19;
    if(!name){ alert('Name erforderlich'); return; }
    showLoading(true);
    try {
      if(id){
        await updateDoc(doc(db,'users',currentUser.uid,'products',id), { name, price, stock, taxRate });
        showToast('Produkt aktualisiert','success');
      } else {
        await addDoc(collection(db,'users',currentUser.uid,'products'), { name, price, stock, taxRate, categoryId:null });
        showToast('Produkt hinzugefügt','success');
      }
      closeProductForm();
      await loadProducts();
    } catch(e){ console.error(e); showToast('Fehler beim Speichern','error'); }
    finally{ showLoading(false); }
  }

  async function deleteProductFromForm(){
    const id = document.getElementById('form-product-id').value;
    if(!id) return closeProductForm();
    if(!confirm('Produkt löschen?')) return;
    showLoading(true);
    try {
      await deleteDoc(doc(db,'users',currentUser.uid,'products',id));
      showToast('Produkt gelöscht','success');
      closeProductForm();
      await loadProducts();
    } catch(e){ console.error(e); showToast('Fehler beim Löschen','error'); }
    finally{ showLoading(false); }
  }

  // ----------------- Render product grid (kasse) -----------------
  function renderProductGrid(){
    const grid = document.getElementById('product-grid');
    grid.innerHTML = '';
    const arr = Object.values(products);
    if(arr.length === 0){ grid.innerHTML = '<p class="text-gray-500 col-span-full text-center p-4">Keine Produkte</p>'; return; }
    arr.forEach(prod => {
      const stock = productsInventory[prod.id];
      const isOut = typeof stock === 'number' && stock <= 0;
      const isLow = typeof stock === 'number' && stock > 0 && stock <= 10;
      const btn = document.createElement('button');
      btn.className = `product-btn bg-white p-3 rounded-lg shadow border text-left ${isOut? 'opacity-50 border-red-400' : isLow? 'border-yellow-400' : 'border-gray-200'}`;
      btn.disabled = isOut;
      btn.innerHTML = `<div class="font-semibold">${escapeHtml(prod.name)}</div><div class="text-sm">${(prod.price||0).toFixed(2)} €</div><div class="text-xs ${isOut? 'text-red-600' : isLow? 'text-yellow-600' : 'text-gray-500'}">${isOut? 'AUSVERKAUFT' : 'Lager: '+stock}</div>`;
      btn.onclick = ()=> addToBestellung(prod);
      grid.appendChild(btn);
    });
  }

  // ----------------- Kasse / Bestellungen -----------------
  function handleQuantityInput(input){
    if(input === 'clear'){ currentQuantity = 1; }
    else if(input === '+'){ currentQuantity++; }
    else {
      const cur = currentQuantity.toString();
      if(cur.length >= 4) return;
      if(cur === '1' && input !== '0') currentQuantity = parseInt(input);
      else currentQuantity = parseInt(cur + input);
    }
    currentQuantity = Math.max(1, currentQuantity);
    document.getElementById('quantity-display').innerText = currentQuantity;
  }

  function addToBestellung(prod){
    const available = productsInventory[prod.id];
    if(typeof available === 'number' && currentQuantity > available){ showToast(`Nur ${available} verfügbar`,'error'); return; }
    const existing = currentBestellung.find(i=>i.id===prod.id);
    if(existing){ existing.quantity += currentQuantity; existing.totalBrutto = parseFloat((existing.quantity * existing.price).toFixed(2)); }
    else {
      currentBestellung.push({ id:prod.id, name:prod.name, price:parseFloat(prod.price || 0), quantity: currentQuantity, totalBrutto: parseFloat((prod.price||0)*currentQuantity), taxRate: prod.taxRate||19 });
    }
    currentQuantity = 1;
    document.getElementById('quantity-display').innerText = currentQuantity;
    renderReceipt();
  }

  function renderReceipt(){
    const container = document.getElementById('receipt-content-interactive');
    container.innerHTML = '';
    if(currentBestellung.length === 0){
      container.innerHTML = '<p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>';
      document.getElementById('btn-finalize').disabled = true;
      document.getElementById('total-display').innerText = 'GESAMT: 0,00 €';
      return;
    }
    let total = 0;
    currentBestellung.forEach((it, idx) => {
      it.totalBrutto = parseFloat((it.price * it.quantity).toFixed(2));
      total += it.totalBrutto;
      const el = document.createElement('div');
      el.className = 'p-2 border rounded flex justify-between items-center';
      el.innerHTML = `<div><div class="font-semibold">${escapeHtml(it.name)}</div><div class="text-xs text-gray-500">${it.quantity} x ${it.price.toFixed(2)} €</div></div><div class="text-right"><div class="font-bold">${it.totalBrutto.toFixed(2)} €</div><div class="text-xs mt-1"><button onclick="removeItem(${idx})" class="text-red-600 text-sm">-1</button><button onclick="editBestellungItemQuantity(${idx})" class="ml-2 text-blue-600 text-sm">Menge</button></div></div>`;
      container.appendChild(el);
    });
    document.getElementById('btn-finalize').disabled = false;
    document.getElementById('total-display').innerText = 'GESAMT: ' + total.toFixed(2) + ' €';
  }

  function removeItem(idx){
    const it = currentBestellung[idx];
    if(!it) return;
    if(it.quantity > 1){ it.quantity -=1; it.totalBrutto = parseFloat((it.price*it.quantity).toFixed(2)); }
    else currentBestellung.splice(idx,1);
    renderReceipt();
  }

  function editBestellungItemQuantity(idx){
    const newQ = prompt('Neue Menge', currentBestellung[idx].quantity);
    if(newQ === null) return;
    updateBestellungItemQuantity(idx, newQ);
  }
  function updateBestellungItemQuantity(index,newQuantity){
    newQuantity = parseInt(newQuantity);
    if(isNaN(newQuantity) || newQuantity<=0){ showToast('Ungültige Menge','error'); return; }
    const item = currentBestellung[index];
    const available = productsInventory[item.id];
    if(available !== undefined && newQuantity > available){ showToast(`Nur ${available} verfügbar`,'error'); return; }
    item.quantity = newQuantity;
    item.totalBrutto = parseFloat((item.price * item.quantity).toFixed(2));
    renderReceipt();
  }

  function clearBestellung(){ if(!confirm('Bon leeren?')) return; currentBestellung = []; renderReceipt(); showToast('Bon gelöscht','info'); }

  // ----------------- Finalize / Transactions -----------------
  function openFinalizeModal(){
    if(currentBestellung.length === 0){ showToast('Keine Positionen im Bon','error'); return; }
    // open a simple finalize modal (re-use browser confirm for simplicity)
    const method = confirm('Mit Karte? OK=Karte, Abbruch=Bar') ? 'KARTE' : 'BAR';
    handleFinalizeAction(method,'standard');
  }

  async function handleFinalizeAction(method, receiptType){
    if(!currentUser){ showToast('Nicht angemeldet','error'); return; }
    showLoading(true);
    try {
      // compute totals & tax summary
      let totalBrutto = 0;
      const taxSummary = {};
      currentBestellung.forEach(it => {
        totalBrutto += it.totalBrutto;
        const r = (it.taxRate||19).toFixed(1);
        const net = it.totalBrutto / (1 + (it.taxRate||19)/100);
        const tax = it.totalBrutto - net;
        if(!taxSummary[r]) taxSummary[r] = { net:0, tax:0, gross:0 };
        taxSummary[r].net += net; taxSummary[r].tax += tax; taxSummary[r].gross += it.totalBrutto;
      });
      const tdata = {
        items: currentBestellung,
        totalBrutto,
        paymentMethod: method,
        timestamp: serverTimestamp(),
        isCancelled: false,
        taxSummary
      };
      const tRef = await addDoc(collection(db,'users',currentUser.uid,'transactions'), tdata);
      // decrement stock
      for(const it of currentBestellung){
        if(productsInventory[it.id] !== undefined){
          const newStock = Math.max(0, productsInventory[it.id] - it.quantity);
          productsInventory[it.id] = newStock;
          try { await updateDoc(doc(db,'users',currentUser.uid,'products',it.id), { stock: newStock }); } catch(e){}
        }
      }
      // optional print
      await printReceipt(tRef.id, tdata);
      currentBestellung = [];
      renderReceipt();
      showToast('Transaktion abgeschlossen','success');
      // reload history & products
      await loadVerlauf(); await loadProducts();
    } catch(e){ console.error(e); showToast('Fehler beim Abschließen','error'); }
    finally{ showLoading(false); }
  }

  async function printReceipt(id, transaction){
    try {
      const pc = document.getElementById('print-receipt-container');
      let html = `<div class="line"><strong>${(userSettings.companyName||'Kassensystem').toUpperCase()}</strong></div>`;
      html += `<div class="line">Beleg: ${id}</div><div class="line">Datum: ${new Date().toLocaleString()}</div><div class="line separator"></div>`;
      transaction.items.forEach(it => {
        html += `<div class="line"><span>${it.quantity}x ${escapeHtml(it.name)}</span><span>${it.totalBrutto.toFixed(2)} €</span></div>`;
      });
      html += `<div class="line separator"></div><div class="line total-line"><span>GESAMT</span><span>${transaction.totalBrutto.toFixed(2)} €</span></div>`;
      pc.innerHTML = html;
      pc.style.display = 'block'; pc.style.visibility = 'visible';
      await new Promise(r=>setTimeout(r,400));
      window.print();
      setTimeout(()=>{ pc.innerHTML=''; pc.style.display='none'; pc.style.visibility='hidden'; }, 600);
    } catch(e){ console.error(e); }
  }

  async function cancelLastTransaction(){
    if(!currentUser) return;
    showLoading(true);
    try {
      const q = query(collection(db,'users',currentUser.uid,'transactions'), where('isCancelled','==',false), orderBy('timestamp','desc'), limit(1));
      const snaps = await getDocs(q);
      if(snaps.empty){ showToast('Keine Transaktion zum Stornieren','info'); return; }
      const docS = snaps.docs[0]; const t = { id: docS.id, ...docS.data() };
      if(!confirm(`Transaktion ${t.id.substring(0,8)} stornieren?`)) return;
      await updateDoc(doc(db,'users',currentUser.uid,'transactions',t.id), { isCancelled:true, cancellationTimestamp: serverTimestamp() });
      // restore stock
      for(const it of t.items || []) {
        try { const pRef = doc(db,'users',currentUser.uid,'products', it.id); const pSnap = await getDoc(pRef); if(pSnap.exists()){ const p = pSnap.data(); await updateDoc(pRef, { stock: (p.stock||0) + (it.quantity||0) }); } } catch(e){ console.error(e); }
      }
      await loadProducts(); await loadVerlauf();
      showToast('Transaktion storniert','success');
    } catch(e){ console.error(e); showToast('Fehler beim Stornieren','error'); }
    finally{ showLoading(false); }
  }

  // ----------------- Verlauf / Storno (UI) -----------------
  async function loadVerlauf(){
    if(!currentUser) return;
    const cont = document.getElementById('verlauf-list');
    cont.innerHTML = 'Lade...';
    try {
      const snaps = await getDocs(query(collection(db,'users',currentUser.uid,'transactions'), orderBy('timestamp','desc'), limit(50)));
      cont.innerHTML = '';
      snaps.forEach(s => {
        const t = { id:s.id, ...s.data() };
        const el = document.createElement('div'); el.className = 'p-2 border rounded flex justify-between items-center';
        el.innerHTML = `<div><div class="font-semibold">${(t.totalBrutto||0).toFixed(2)} € ${t.isCancelled? '(storniert)':''}</div><div class="text-xs text-gray-500">${t.timestamp?.seconds? new Date(t.timestamp.seconds*1000).toLocaleString() : ''}</div></div>`;
        const btn = document.createElement('button'); btn.className='px-2 py-1 bg-red-600 text-white rounded'; btn.innerText='Storno'; btn.onclick = ()=> handleReversal(t.id);
        if(t.isCancelled) btn.disabled = true;
        el.appendChild(btn);
        cont.appendChild(el);
      });
    } catch(e){ console.error(e); cont.innerHTML = '<p class="text-red-500">Fehler</p>'; }
  }

  async function handleReversal(transactionId){
    if(!confirm('Transaktion stornieren?')) return;
    showLoading(true);
    try {
      const tRef = doc(db,'users',currentUser.uid,'transactions', transactionId);
      const tSnap = await getDoc(tRef);
      if(!tSnap.exists()) { showToast('Transaktion nicht gefunden','error'); showLoading(false); return; }
      const t = tSnap.data();
      await updateDoc(tRef, { isCancelled:true, cancellationTimestamp: serverTimestamp() });
      // restore stock
      for(const it of t.items || []) {
        try { const pRef = doc(db,'users',currentUser.uid,'products', it.id); const pSnap = await getDoc(pRef); if(pSnap.exists()){ const p = pSnap.data(); await updateDoc(pRef, { stock: (p.stock||0) + (it.quantity||0) }); } } catch(e){ console.error(e); }
      }
      await loadProducts(); await loadVerlauf();
      showToast('Storno durchgeführt','success');
    } catch(e){ console.error(e); showToast('Fehler','error'); }
    finally{ showLoading(false); }
  }

  // ----------------- Kassenbuch -----------------
  async function kassenbuchEinlage(){ await saveKassenbuch('einlage'); }
  async function kassenbuchEntnahme(){ await saveKassenbuch('entnahme'); }
  async function saveKassenbuch(type){
    if(!currentUser) { showToast('Nicht angemeldet','error'); return; }
    const amount = parseFloat(document.getElementById('kassenbuch-betrag').value) || 0;
    if(amount <= 0) { showToast('Betrag > 0','error'); return; }
    const reason = prompt('Grund (optional)', '') || '';
    showLoading(true);
    try {
      await addDoc(collection(db,'users',currentUser.uid,'cashMovements'), { type, amount, reason, timestamp: serverTimestamp(), user: currentUser.email });
      document.getElementById('kassenbuch-betrag').value = '';
      showToast('Kassenbewegung gespeichert','success');
      await loadKassenbuch();
    } catch(e){ console.error(e); showToast('Fehler','error'); }
    finally{ showLoading(false); }
  }

  async function loadKassenbuch(){
    if(!currentUser) return;
    const container = document.getElementById('kassenbuch-list'); container.innerHTML = 'Lade...';
    try {
      const snaps = await getDocs(query(collection(db,'users',currentUser.uid,'cashMovements'), orderBy('timestamp','desc'), limit(50)));
      container.innerHTML = '';
      snaps.forEach(s => {
        const d = s.data();
        const el = document.createElement('div'); el.className='p-2 border rounded';
        el.innerHTML = `<div class="flex justify-between"><div>${escapeHtml(d.type)} ${escapeHtml(d.reason||'')}</div><div>${(d.amount||0).toFixed(2)} €</div></div><div class="text-xs text-gray-500">${d.timestamp?.seconds? new Date(d.timestamp.seconds*1000).toLocaleString() : ''}</div>`;
        container.appendChild(el);
      });
    } catch(e){ console.error(e); container.innerHTML = '<p class="text-red-500">Fehler</p>'; }
  }

  // ----------------- Z-Bericht + CSV export -----------------
  let lastZReport = { text: '', csv: '' };
  function setReportDateToday(){ document.getElementById('report-date').value = new Date().toISOString().slice(0,10); }

  async function generateZReport(){
    if(!currentUser) return;
    const dateVal = document.getElementById('report-date').value;
    const target = dateVal ? new Date(dateVal) : new Date();
    const start = new Date(target); start.setHours(0,0,0,0);
    const end = new Date(target); end.setHours(23,59,59,999);
    showLoading(true);
    try {
      const snaps = await getDocs(query(collection(db,'users',currentUser.uid,'transactions'), orderBy('timestamp','asc')));
      const all = snaps.docs.map(d => ({ id:d.id, ...d.data() }));
      const filtered = all.filter(t => t.timestamp && (t.timestamp.seconds*1000) >= start.getTime() && (t.timestamp.seconds*1000) <= end.getTime());
      let totalGross = 0;
      const taxSummary = {}; const paymentTotals = {}; const productSummary = {};
      filtered.forEach(t => {
        totalGross += t.totalBrutto || 0;
        Object.entries(t.taxSummary || {}).forEach(([k,v])=>{
          if(!taxSummary[k]) taxSummary[k] = { net:0, tax:0, gross:0 };
          taxSummary[k].net += v.net; taxSummary[k].tax += v.tax; taxSummary[k].gross += v.gross;
        });
        paymentTotals[t.paymentMethod || 'UNKNOWN'] = (paymentTotals[t.paymentMethod||'UNKNOWN'] || 0) + (t.totalBrutto || 0);
        (t.items || []).forEach(it => {
          productSummary[it.name] = productSummary[it.name] || { q:0, gross:0 };
          productSummary[it.name].q += it.quantity || 1;
          productSummary[it.name].gross += it.totalBrutto || 0;
        });
      });
      let txt = `Z-Bericht für ${start.toLocaleDateString()}\n\nGesamt Brutto: ${totalGross.toFixed(2)} €\n\nUmsatz nach MwSt:\n`;
      Object.keys(taxSummary).forEach(k => txt += `  MwSt ${k}% – Brutto: ${taxSummary[k].gross.toFixed(2)} €, MwSt: ${taxSummary[k].tax.toFixed(2)} €\n`);
      txt += '\nZahlungsarten:\n'; Object.keys(paymentTotals).forEach(k => txt += `  ${k}: ${paymentTotals[k].toFixed(2)} €\n`);
      txt += '\nVerkaufte Artikel:\n'; Object.keys(productSummary).forEach(n => txt += `  ${productSummary[n].q}x ${n} – ${productSummary[n].gross.toFixed(2)} €\n`);
      document.getElementById('zbericht-output').textContent = txt;

      // build CSV for product summary
      let csv = 'name,quantity,gross\n';
      Object.keys(productSummary).forEach(n => csv += `"${n.replace(/"/g,'""')}",${productSummary[n].q},${productSummary[n].gross.toFixed(2)}\n`);
      lastZReport = { text: txt, csv };
    } catch(e){ console.error(e); document.getElementById('zbericht-output').textContent = 'Fehler beim Erstellen'; }
    finally{ showLoading(false); }
  }

  function downloadZReportCSV(){
    if(!lastZReport.csv){ alert('Bitte zuerst Z-Bericht generieren'); return; }
    const blob = new Blob([lastZReport.csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `zbericht_${document.getElementById('report-date').value || new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ----------------- Utility: small escaping -----------------
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // expose functions for HTML
  window.openSettingsModal = openSettingsModal;
  window.closeSettingsModal = closeSettingsModal;
  window.openProductForm = openProductForm;
  window.closeProductForm = closeProductForm;
  window.saveProductFromForm = saveProductFromForm;
  window.deleteProductFromForm = deleteProductFromForm;
  window.addToBestellung = addToBestellung;
  window.handleQuantityInput = handleQuantityInput;
  window.clearBestellung = clearBestellung;
  window.openFinalizeModal = openFinalizeModal;
  window.cancelLastTransaction = cancelLastTransaction;
  window.kassenbuchEinlage = kassenbuchEinlage;
  window.kassenbuchEntnahme = kassenbuchEntnahme;
  window.generateZReport = generateZReport;
  window.downloadZReportCSV = downloadZReportCSV;
  window.setReportDateToday = setReportDateToday;

  // set today's date in report input
  document.addEventListener('DOMContentLoaded', ()=> setReportDateToday());

</script>

</body>
</html>
