<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem — Vereint</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, 'Helvetica Neue', Arial; background: #f7f7f7; }
    .numpad-btn { height:50px; display:flex; justify-content:center; align-items:center; }
    .product-btn:active { transform: scale(0.98); }
    #async-loading-overlay { position: fixed; inset:0; background: rgba(255,255,255,0.8); z-index:100; display:none; justify-content:center; align-items:center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #b91c1c; border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #toast-container { position: fixed; top:1rem; right:1rem; z-index:1000; pointer-events:none; }
    .toast { padding:.75rem 1rem; border-radius:.5rem; color:#fff; margin-bottom:.5rem; opacity:0; transition: opacity .25s ease; }
    .toast-success{ background:#16a34a } .toast-error{ background:#dc2626 } .toast-info{ background:#2563eb }

    /* Druckbereich (Bondrucker 80mm) */
    #print-receipt-container { display:none; visibility:hidden; }
    .receipt-print { font-family: 'Consolas', 'Courier New', monospace; }
    @media print {
      body * { visibility: hidden !important; }
      #print-receipt-container { visibility: visible !important; display:block !important; position:absolute !important; left:0; top:0; width:80mm !important; font-size:12px !important; color:#000 !important; padding:2px !important; line-height:1.2 !important; }
      #print-receipt-container * { visibility: visible !important; }
      .receipt-print .line { display:flex; justify-content:space-between; margin-bottom:2px; }
    }

    /* small helpers */
    .hidden-important { display:none !important; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6 bg-red-500/5 overflow-x-hidden">

  <div id="toast-container"></div>
  <div id="async-loading-overlay"><div class="spinner"></div></div>

  <!-- LOGIN / REGISTRATION (Finale Version UI) -->
  <div id="login-modal" style="display:flex;" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h1 class="text-3xl font-bold text-center text-red-700 mb-2">Kassensystem</h1>
      <p class="text-sm text-center text-gray-500 mb-4">Bitte anmelden oder registrieren.</p>
      <form id="login-form" onsubmit="event.preventDefault(); handleLoginSubmit()">
        <div class="mb-3">
          <label class="block text-sm">E-Mail</label>
          <input id="login-email" type="email" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="mb-3">
          <label class="block text-sm">Passwort</label>
          <input id="login-password" type="password" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600">Anmelden</button>
      </form>
      <div class="mt-3 text-center">
        <button onclick="openRegistrationModal()" class="text-sm text-indigo-600">Registrieren</button>
        <button onclick="openForgotPasswordModal()" class="ml-2 text-sm text-red-600">Passwort vergessen?</button>
      </div>
    </div>
  </div>

  <!-- Registration & Forgot (both files) -->
  <div id="registration-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-indigo-700 mb-4">Konto erstellen</h2>
      <form id="register-form" onsubmit="event.preventDefault(); handleRegisterSubmit()">
        <div class="mb-3">
          <label class="block text-sm">E-Mail</label>
          <input id="register-email" type="email" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <div class="mb-3">
          <label class="block text-sm">Passwort</label>
          <input id="register-password" type="password" required minlength="6" class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-green-600">Registrieren</button>
      </form>
      <button onclick="closeModal('registration-modal'); openLoginModal();" class="mt-3 w-full p-1 text-sm text-gray-500">Zurück</button>
    </div>
  </div>

  <div id="forgot-password-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-90 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
      <h2 class="text-2xl font-bold text-red-700 mb-4">Passwort zurücksetzen</h2>
      <form id="reset-form" onsubmit="event.preventDefault(); handlePasswordReset()">
        <div class="mb-3">
          <label class="block text-sm">E-Mail</label>
          <input id="reset-email" type="email" required class="mt-1 w-full px-3 py-2 border rounded-lg">
        </div>
        <button type="submit" class="w-full p-2 rounded-lg font-bold text-white bg-red-600">Link senden</button>
      </form>
      <button onclick="closeModal('forgot-password-modal'); openLoginModal();" class="mt-3 w-full p-1 text-sm text-gray-500">Zurück</button>
    </div>
  </div>

  <!-- Product / Settings / Report Modals (merged from Verbesserungen + Finale) -->
  <div id="product-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">Produktverwaltung</h2>
      <div class="flex space-x-4">
        <div class="flex-1 max-h-96 overflow-y-auto border p-2 rounded-lg">
          <ul id="product-list" class="space-y-1"></ul>
        </div>
        <div class="w-1/3">
          <h3 id="product-form-title" class="text-lg font-semibold mb-3">Neues Produkt</h3>
          <input type="hidden" id="product-id">
          <label class="block text-sm">Name</label>
          <input id="product-name" type="text" class="mt-1 block w-full p-2 border rounded-lg">
          <label class="block text-sm mt-3">Preis Brutto (€)</label>
          <input id="product-price" type="number" step="0.01" class="mt-1 block w-full p-2 border rounded-lg">
          <label class="block text-sm mt-3">Lagerbestand</label>
          <input id="product-stock" type="number" min="0" class="mt-1 block w-full p-2 border rounded-lg">
          <div class="flex space-x-2 mt-4">
            <button onclick="saveProduct()" class="bg-indigo-600 text-white p-2 rounded-lg flex-1">Speichern</button>
            <button id="delete-product-btn" onclick="deleteProduct()" class="bg-red-600 text-white p-2 rounded-lg hidden">Löschen</button>
          </div>
          <button onclick="resetProductForm()" class="mt-2 w-full p-2 bg-gray-500 text-white rounded-lg">Neu/Abbrechen</button>
        </div>
      </div>
      <div class="mt-4 text-right"><button onclick="closeModal('product-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
    </div>
  </div>

  <!-- Cash Movement Modal (Kassenbuch) -->
  <div id="cash-movement-modal" class="fixed inset-0 bg-black bg-opacity-70 z-[999] hidden items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
      <h2 class="text-xl font-bold mb-4">Kassenbewegung (Einlage / Entnahme)</h2>
      <label class="block text-sm">Art</label>
      <select id="movement-type" class="mt-1 block w-full p-2 border rounded-lg">
        <option value="entnahme">Entnahme</option>
        <option value="einlage">Einlage</option>
      </select>
      <label class="block text-sm mt-3">Betrag (€)</label>
      <input id="movement-amount" type="number" min="0.01" step="0.01" class="mt-1 block w-full p-2 border rounded-lg">
      <label class="block text-sm mt-3">Grund (optional)</label>
      <input id="movement-reason" type="text" class="mt-1 block w-full p-2 border rounded-lg">
      <div class="flex justify-end mt-4 space-x-2">
        <button onclick="closeModal('cash-movement-modal')" class="p-2 bg-gray-300 rounded-lg">Abbrechen</button>
        <button onclick="saveCashMovement()" class="p-2 bg-indigo-600 text-white rounded-lg">Speichern</button>
      </div>
    </div>
  </div>

  <!-- Transaction History / Storno Modal -->
  <div id="report-modal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
      <h2 class="text-2xl font-bold text-blue-700 mb-4">Tagesabschluss & Transaktionen</h2>

      <div class="flex items-center space-x-2 mb-4">
        <label class="text-sm font-bold">Bericht für Tag:</label>
        <input id="report-date" type="date" class="p-1 border rounded-lg">
        <button onclick="setReportDateToday()" class="p-1 rounded-lg text-xs bg-red-500 text-white">Heute</button>
      </div>

      <div class="flex space-x-2 mb-3">
        <button onclick="runDailyReport('report')" class="p-2 bg-blue-600 text-white rounded-lg">Tagesabschluss (Bericht)</button>
        <button onclick="runDailyReport('csv')" class="p-2 bg-gray-300 rounded-lg">Tagesabschluss (CSV)</button>
      </div>

      <div id="screen-report-content" class="mt-2 p-3 bg-gray-100 rounded-lg min-h-[150px] receipt-print"></div>

      <h3 class="mt-4 text-lg font-bold">Transaktions-Historie (Storno)</h3>
      <div id="transaction-list-container" class="border p-2 rounded-lg bg-white max-h-48 overflow-y-auto">
        <div id="transaction-list"><p class="text-gray-500 text-center p-2">Lade...</p></div>
      </div>

      <div class="mt-4 text-right"><button onclick="closeModal('report-modal')" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div>
    </div>
  </div>

  <!-- Main Kasse Content (Finale layout) -->
  <div id="kasse-content" style="display:none;" class="grid md:grid-cols-3 gap-4 h-full">

    <div class="md:col-span-2 flex flex-col space-y-4">
      <div class="flex space-x-2 p-2 bg-white rounded-xl shadow-lg items-center">
        <div class="flex-grow">
          <div id="category-tabs" class="flex space-x-1 overflow-x-auto pb-1"></div>
        </div>
        <div class="flex space-x-2">
          <button onclick="openCashMovementModal()" class="p-2 bg-yellow-500 text-white rounded-lg">Kassenbuch</button>
          <button onclick="openTransactionHistoryModal()" class="p-2 bg-sky-500 text-white rounded-lg">Verlauf</button>
          <button onclick="openSettingsModal()" class="p-2 bg-gray-500 text-white rounded-lg">Einstellungen</button>
          <button onclick="openProductModal()" class="p-2 bg-indigo-600 text-white rounded-lg">Produkte</button>
          <button onclick="openReportModal()" class="p-2 bg-purple-600 text-white rounded-lg">Tagesabschluss</button>
          <button onclick="handleLogout()" class="p-2 bg-red-600 text-white rounded-lg">Logout</button>
        </div>
      </div>

      <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 flex-grow min-h-[300px] bg-white p-3 rounded-xl shadow-lg">
        <p class="text-gray-500 col-span-full text-center p-4">Produkte werden geladen...</p>
      </div>

      <div class="p-4 bg-white rounded-xl shadow-lg grid grid-cols-4 gap-4">
        <div class="col-span-1">
          <span class="text-sm font-bold text-gray-600 block mb-1">Aktuelle Menge:</span>
          <div id="quantity-display" class="w-full h-10 flex items-center justify-center text-xl font-extrabold text-red-600 bg-red-100 rounded-xl">1</div>
        </div>
        <div id="main-numpad-container" class="grid grid-cols-3 gap-2 col-span-3">
          <button onclick="handleQuantityInput('7')" class="numpad-btn bg-gray-200">7</button>
          <button onclick="handleQuantityInput('8')" class="numpad-btn bg-gray-200">8</button>
          <button onclick="handleQuantityInput('9')" class="numpad-btn bg-gray-200">9</button>
          <button onclick="handleQuantityInput('4')" class="numpad-btn bg-gray-200">4</button>
          <button onclick="handleQuantityInput('5')" class="numpad-btn bg-gray-200">5</button>
          <button onclick="handleQuantityInput('6')" class="numpad-btn bg-gray-200">6</button>
          <button onclick="handleQuantityInput('1')" class="numpad-btn bg-gray-200">1</button>
          <button onclick="handleQuantityInput('2')" class="numpad-btn bg-gray-200">2</button>
          <button onclick="handleQuantityInput('3')" class="numpad-btn bg-gray-200">3</button>
          <button onclick="handleQuantityInput('clear')" class="numpad-btn bg-red-500 text-white">C</button>
          <button onclick="handleQuantityInput('0')" class="numpad-btn bg-gray-200">0</button>
          <button onclick="handleQuantityInput('+')" class="numpad-btn bg-green-500 text-white">+</button>
        </div>
      </div>
    </div>

    <div id="receipt-column" class="md:col-span-1 flex flex-col space-y-4">
      <div class="bg-white p-4 rounded-xl shadow-lg flex-grow flex flex-col">
        <h2 class="text-lg font-bold text-red-700 mb-2 border-b pb-1">Aktueller Bon</h2>
        <div id="receipt-content-interactive" class="flex-grow overflow-y-auto mb-2 space-y-1">
          <p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>
        </div>
        <div class="border-t pt-2 flex justify-between items-center">
          <button onclick="clearBestellung()" class="text-red-500 text-sm font-semibold">Leeren</button>
          <span id="total-display" class="text-2xl font-extrabold text-red-700">GESAMT: 0,00 €</span>
        </div>
      </div>

      <div class="bg-white p-4 rounded-xl shadow-lg space-y-3">
        <button onclick="openFinalizeModal()" id="btn-finalize" class="product-btn w-full p-4 rounded-xl font-extrabold text-white bg-green-600 disabled:opacity-50" disabled>Zahlung abschließen</button>
        <button onclick="cancelLastTransaction()" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-red-700">Letzte Rechnung stornieren</button>
        <button onclick="openReportModal();" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-blue-600">Tagesabschluss & Storno</button>
        <button onclick="openSettingsModal()" class="product-btn w-full p-3 rounded-xl font-bold text-white bg-gray-500">Einstellungen & Verwaltung</button>
      </div>
    </div>

  </div>

  <!-- Hidden print area used by Verbesserungen.rtf -->
  <div id="receipt-print-area" class="w-80 p-4 mx-auto bg-white font-mono text-xs hidden"></div>
  <div id="print-receipt-container" class="receipt-print"></div>

  <!-- SCRIPT: Firebase v9 (Finale modular) + merged logic -->
  <script type="module">
    // ----------------- FIREBASE v9 (modular) -----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy, serverTimestamp, Timestamp, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
        authDomain: "kassensystem-85412.firebaseapp.com",
        databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kassensystem-85412",
        storageBucket: "kassensystem-85412.appspot.com",
        messagingSenderId: "305116742512",
        appId: "1:305116742512:web:48a65f97b5d1e2e98fa87f",
        measurementId: "G-9D3T2J23P8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ----------------- GLOBAL STATE -----------------
    let currentUser = null;
    let categories = {};
    let products = {};
    let currentBestellung = [];
    let totalBrutto = 0.00;
    let userSettings = {};
    let currentQuantity = 1;
    let cashReceivedInput = '0';
    let cashPaymentMethod = 'BAR';
    let transactionHistory = [];
    let productsInventory = {}; // cache inventory (stock)
    const UST_FALLBACK = 19.0;

    // ----------------- UI Helpers -----------------
    function showLoading(show) { document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none'; }
    function showToast(message, type='info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerText = message;
      container.appendChild(toast);
      setTimeout(()=>toast.style.opacity=1,10);
      setTimeout(()=>{ toast.style.opacity=0; setTimeout(()=>toast.remove(),250); }, 3500);
    }
    function closeModal(id){ document.getElementById(id).style.display = 'none'; toggleReceiptColumn(true); }
    function openLoginModal(){ document.getElementById('login-modal').style.display='flex'; toggleReceiptColumn(false); }
    function openRegistrationModal(){ closeModal('login-modal'); toggleReceiptColumn(false); document.getElementById('registration-modal').style.display='flex'; }
    function openForgotPasswordModal(){ closeModal('login-modal'); toggleReceiptColumn(false); document.getElementById('forgot-password-modal').style.display='flex'; }

    function toggleReceiptColumn(show){
      const rc = document.getElementById('receipt-column');
      if(!rc) return;
      rc.style.display = show ? 'flex' : 'none';
    }

    function formatCurrency(amount){
      return parseFloat(amount||0).toFixed(2).replace('.', ',');
    }

    // ----------------- AUTH -----------------
    async function handleLoginSubmit(){
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      if(!email||!password){ showToast('Bitte E-Mail und Passwort eingeben','error'); return; }
      showLoading(true);
      try { await signInWithEmailAndPassword(auth, email, password); showToast('Erfolgreich angemeldet','success'); }
      catch(err){ console.error(err); showToast('Login fehlgeschlagen: '+(err.message||err.code),'error'); }
      finally{ showLoading(false); }
    }
    async function handleRegisterSubmit(){
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      if(!email||!password){ showToast('Bitte E-Mail und Passwort eingeben','error'); return; }
      showLoading(true);
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        // seed default user doc with canCancelTransaction false
        await setDoc(doc(db,'users',cred.user.uid), { canCancelTransaction:false }, { merge:true });
        showToast('Registrierung erfolgreich! Bitte anmelden.', 'success');
        closeModal('registration-modal'); openLoginModal();
      } catch(err){ console.error(err); showToast('Registrierung fehlgeschlagen: '+(err.message||err.code),'error'); }
      finally{ showLoading(false); }
    }
    async function handlePasswordReset(){
      const email = document.getElementById('reset-email').value;
      if(!email){ showToast('Bitte E-Mail eingeben','error'); return; }
      showLoading(true);
      try{ await sendPasswordResetEmail(auth, email); showToast('Passwort-Reset-Link gesendet','info'); closeModal('forgot-password-modal'); openLoginModal(); }
      catch(err){ console.error(err); showToast('Fehler beim Senden: '+(err.message||err.code),'error'); }
      finally{ showLoading(false); }
    }
    async function handleLogout(){ showLoading(true); try{ await signOut(auth); showToast('Abgemeldet','info'); } catch(err){ showToast('Fehler beim Logout','error'); } finally{ showLoading(false); } }

    onAuthStateChanged(auth, async user => {
      if(user){ currentUser = user; await initUserData(); } else { currentUser = null; updateAppView('login'); categories={}; products={}; currentBestellung=[]; totalBrutto=0; userSettings={}; productsInventory={}; }
    });

    function updateAppView(view){
      document.getElementById('login-modal').style.display = (view==='login') ? 'flex' : 'none';
      document.getElementById('kasse-content').style.display = (view==='kasse' || view==='main') ? 'grid' : 'none';
    }

    // ----------------- INIT & SEED -----------------
    async function settingsDocRef(uid){ return doc(db,'users',uid,'meta','settings'); }
    function categoriesCollectionRef(uid){ return collection(db,'users',uid,'categories'); }
    function productsCollectionRef(uid){ return collection(db,'users',uid,'products'); }
    function transactionsCollectionRef(uid){ return collection(db,'users',uid,'transactions'); }

    async function seedUserDataIfNeeded(uid){
      const sRef = doc(db,'users',uid,'meta','settings');
      try {
         const sSnap = await getDoc(sRef);
         if(sSnap.exists()) return;
      } catch(e){}
      showToast('Erste Anmeldung: Standarddaten werden erzeugt...','info');
      await setDoc(sRef, { companyName:'Ihre Firma', address:'Musterstr. 1', taxId:'123/456', taxRate:19.0 });
      const catRef = categoriesCollectionRef(uid);
      const c1 = await addDoc(catRef, { name:'Getränke', order:1 });
      const c2 = await addDoc(catRef, { name:'Speisen', order:2 });
      const prodRef = productsCollectionRef(uid);
      await addDoc(prodRef, { name:'Kaffee', price:2.50, priceRaw:2.50, categoryId:c1.id, taxRate:19.0, stock:99 });
      await addDoc(prodRef, { name:'Wasser', price:1.50, priceRaw:1.50, categoryId:c1.id, taxRate:19.0, stock:50 });
      await addDoc(prodRef, { name:'Kuchen', price:3.00, priceRaw:3.00, categoryId:c2.id, taxRate:7.0, stock:20 });
      showToast('Standarddaten erstellt.','success');
    }

    async function initUserData(){
      showLoading(true);
      try {
        if(!currentUser) throw new Error('No user');
        await seedUserDataIfNeeded(currentUser.uid);
        await loadSettings();
        await loadProductsAndCategories();
        renderReceipt();
        updateAppView('kasse');
      } catch(err){ console.error(err); showToast('Fehler beim Initialisieren: '+err.message,'error'); await signOut(auth); }
      finally{ showLoading(false); }
    }

    // ----------------- SETTINGS -----------------
    async function loadSettings(){
      if(!currentUser) return;
      try {
        const sRef = doc(db,'users',currentUser.uid,'meta','settings');
        const sSnap = await getDoc(sRef);
        if(sSnap.exists()) userSettings = sSnap.data();
        else { userSettings = { companyName:'Kassensystem', address:'', taxId:'', taxRate:19.0 }; await setDoc(sRef, userSettings); }
      } catch(e){ console.error(e); userSettings = { companyName:'Kassensystem', taxRate:19.0 }; }
    }

    async function saveSettings(){
      if(!currentUser){ showToast('Nicht angemeldet','error'); return; }
      showLoading(true);
      try {
        const sRef = doc(db,'users',currentUser.uid,'meta','settings');
        userSettings = {
          companyName: document.getElementById('company-name')?.value || userSettings.companyName || 'Kassensystem',
          address: document.getElementById('address')?.value || userSettings.address || '',
          taxId: document.getElementById('tax-id')?.value || userSettings.taxId || '',
          taxRate: parseFloat(document.getElementById('tax-rate')?.value) || userSettings.taxRate || 19.0
        };
        await setDoc(sRef, userSettings, { merge:true });
        showToast('Einstellungen gespeichert','success');
      } catch(err){ console.error(err); showToast('Fehler beim Speichern','error'); }
      finally{ showLoading(false); }
    }

    // ----------------- PRODUCTS & CATEGORIES (merged) -----------------
    async function loadProductsAndCategories(){
      if(!currentUser) return;
      categories = {}; products = {};
      try {
        const catSnap = await getDocs(query(categoriesCollectionRef(currentUser.uid), orderBy('order','asc')));
        catSnap.forEach(c => categories[c.id] = { id:c.id, ...c.data() });

        const prodSnap = await getDocs(query(productsCollectionRef(currentUser.uid), orderBy('name','asc')));
        prodSnap.forEach(p => {
          const data = p.data();
          data.taxRate = parseFloat(data.taxRate) || UST_FALLBACK;
          products[p.id] = { id:p.id, ...data };
          productsInventory[p.id] = (typeof data.stock === 'number') ? data.stock : 9999;
        });

        renderCategoryTabs();
        renderProductGrid(Object.values(categories)[0]?.id || null);
        renderProductModalContent();
      } catch(err){ console.error('loadProducts',err); showToast('Fehler beim Laden der Produkte','error'); }
    }

    function renderCategoryTabs(){
      const container = document.getElementById('category-tabs');
      container.innerHTML = '';
      Object.values(categories).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'p-2 text-sm font-semibold rounded-lg bg-gray-200 hover:bg-red-200 whitespace-nowrap';
        btn.innerText = cat.name;
        btn.onclick = ()=>renderProductGrid(cat.id);
        container.appendChild(btn);
      });
    }

    function renderProductGrid(categoryId){
      const container = document.getElementById('product-grid');
      container.innerHTML = '';
      const filtered = Object.values(products).filter(p => p.categoryId === categoryId);
      if(filtered.length === 0){ container.innerHTML = '<p class="text-gray-500 col-span-full text-center p-4">Keine Produkte in dieser Kategorie.</p>'; return; }
      filtered.forEach(prod => {
        const stock = productsInventory[prod.id];
        const isOut = (typeof stock === 'number' && stock<=0);
        const isLow = (typeof stock === 'number' && stock>0 && stock<=10);
        const btn = document.createElement('button');
        btn.className = `product-btn bg-white p-3 rounded-lg shadow border text-left ${isOut? 'opacity-50 border-red-400' : isLow? 'border-yellow-400' : 'border-gray-200'}`;
        btn.innerHTML = `<div class="font-semibold">${prod.name}</div><div class="text-sm">${formatCurrency(prod.price)} €</div><div class="text-xs ${isOut? 'text-red-600' : isLow? 'text-yellow-600' : 'text-gray-500'}">${isOut? 'AUSVERKAUFT' : 'Lager: '+stock}</div>`;
        btn.disabled = isOut;
        btn.onclick = ()=>addToBestellung(prod);
        container.appendChild(btn);
      });
    }

    // Product modal rendering (improved from Verbesserungen)
    async function renderProductModalContent(){
      showLoading(true);
      try {
        const snapshot = await getDocs(productsCollectionRef(currentUser.uid));
        const list = document.getElementById('product-list'); list.innerHTML = '';
        snapshot.forEach(docSnap => {
          const p = { id: docSnap.id, ...docSnap.data() };
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center p-2 border-b cursor-pointer hover:bg-gray-100';
          li.innerHTML = `<div><span class="font-semibold">${p.name}</span><span class="text-sm block text-gray-500">${formatCurrency(p.price)} € | Lager: ${p.stock!==undefined? p.stock : 'N/A'}</span></div>`;
          li.onclick = ()=>editProduct(p);
          list.appendChild(li);
        });
        resetProductForm();
      } catch(err){ console.error(err); showToast('Fehler Produktmodal','error'); }
      finally{ showLoading(false); }
    }

    function resetProductForm(){
      document.getElementById('product-id').value = '';
      document.getElementById('product-name').value = '';
      document.getElementById('product-price').value = '';
      document.getElementById('product-stock').value = 0;
      document.getElementById('product-form-title').innerText = 'Neues Produkt erstellen';
      document.getElementById('delete-product-btn').classList.add('hidden');
    }

    function editProduct(prod){
      document.getElementById('product-id').value = prod.id;
      document.getElementById('product-name').value = prod.name;
      document.getElementById('product-price').value = prod.price;
      document.getElementById('product-stock').value = prod.stock||0;
      document.getElementById('product-form-title').innerText = 'Produkt bearbeiten';
      document.getElementById('delete-product-btn').classList.remove('hidden');
    }

    async function saveProduct(){
      if(!currentUser) { showToast('Nicht angemeldet','error'); return; }
      const name = document.getElementById('product-name').value.trim();
      const price = parseFloat(document.getElementById('product-price').value) || 0;
      const stock = parseInt(document.getElementById('product-stock').value) || 0;
      const id = document.getElementById('product-id').value;
      showLoading(true);
      try {
        if(id){
          const ref = doc(db,'users',currentUser.uid,'products',id);
          await setDoc(ref, { name, price, stock }, { merge:true });
          showToast('Produkt aktualisiert','success');
        } else {
          const ref = collection(db,'users',currentUser.uid,'products');
          await addDoc(ref, { name, price, stock, taxRate: UST_FALLBACK, categoryId: Object.values(categories)[0]?.id || null });
          showToast('Produkt erstellt','success');
        }
        await loadProductsAndCategories();
        resetProductForm();
      } catch(err){ console.error(err); showToast('Fehler beim Speichern','error'); }
      finally{ showLoading(false); }
    }

    async function deleteProduct(){
      const id = document.getElementById('product-id').value;
      if(!id) return;
      if(!confirm('Produkt löschen?')) return;
      showLoading(true);
      try{
        await deleteDoc(doc(db,'users',currentUser.uid,'products',id));
        showToast('Produkt gelöscht','success');
        await loadProductsAndCategories();
        resetProductForm();
      } catch(err){ console.error(err); showToast('Fehler beim Löschen','error'); }
      finally{ showLoading(false); }
    }

    // ----------------- KASSE / BESTELLUNG -----------------
    function handleQuantityInput(input){
      if(input === 'clear'){ currentQuantity = 1; }
      else if(input === '+'){ currentQuantity++; }
      else {
        const cur = currentQuantity.toString();
        if(cur.length >= 4) return;
        if(cur === '1' && input !== '0') currentQuantity = parseInt(input);
        else currentQuantity = parseInt(cur + input);
      }
      currentQuantity = Math.max(1, currentQuantity);
      document.getElementById('quantity-display').innerText = currentQuantity;
    }

    function addToBestellung(prod){
      const existing = currentBestellung.find(i=>i.id===prod.id);
      const qtyToAdd = currentQuantity;
      const available = productsInventory[prod.id];
      if(typeof available === 'number' && qtyToAdd > available){ showToast(`Nur ${available} Stück verfügbar`,'error'); return; }

      if(existing){
        existing.quantity += qtyToAdd;
        existing.totalBrutto = parseFloat((existing.price * existing.quantity).toFixed(2));
      } else {
        currentBestellung.push({
          id: prod.id,
          name: prod.name,
          price: parseFloat(prod.price),
          quantity: qtyToAdd,
          totalBrutto: parseFloat((prod.price * qtyToAdd).toFixed(2)),
          taxRate: parseFloat(prod.taxRate) || userSettings.taxRate || UST_FALLBACK
        });
      }
      currentQuantity = 1;
      document.getElementById('quantity-display').innerText = currentQuantity;
      renderReceipt();
    }

    function removeItem(index){
      const item = currentBestellung[index];
      if(!item) return;
      if(item.quantity > 1){ item.quantity -= 1; item.totalBrutto = parseFloat((item.price * item.quantity).toFixed(2)); }
      else currentBestellung.splice(index,1);
      renderReceipt();
    }

    function clearBestellung(){
      if(currentBestellung.length === 0) return;
      if(!confirm('Sicher? Ganzen Bon löschen?')) return;
      currentBestellung = [];
      renderReceipt();
      showToast('Bon gelöscht.','info');
    }

    // renderReceipt (both interactive + print)
    function renderReceipt(forPrint=false, receiptType='standard', transactionId=null, timestamp=null){
      const container = forPrint ? document.getElementById('print-receipt-container') : document.getElementById('receipt-content-interactive');
      if(!container) return;
      let html = '';
      totalBrutto = 0; let totalNetto=0; let totalTax=0; let taxSummary={};
      const fallback = userSettings.taxRate || UST_FALLBACK;

      currentBestellung.forEach(item=>{
        item.totalBrutto = parseFloat((item.price * item.quantity).toFixed(2));
        const rate = parseFloat(item.taxRate) || fallback;
        const itemNet = item.totalBrutto / (1 + rate/100);
        const itemTax = item.totalBrutto - itemNet;
        totalBrutto += item.totalBrutto; totalNetto += itemNet; totalTax += itemTax;
        const key = rate.toFixed(1);
        if(!taxSummary[key]) taxSummary[key] = { net:0, tax:0, gross:0 };
        taxSummary[key].net += itemNet; taxSummary[key].tax += itemTax; taxSummary[key].gross += item.totalBrutto;
      });

      totalBrutto = parseFloat(totalBrutto.toFixed(2)); totalNetto = parseFloat(totalNetto.toFixed(2)); totalTax = parseFloat(totalTax.toFixed(2));

      if(currentBestellung.length === 0){
        container.innerHTML = '<p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>';
        document.getElementById('btn-finalize').disabled = true;
        document.getElementById('total-display').innerText = 'GESAMT: 0,00 €';
        return;
      } else {
        document.getElementById('btn-finalize').disabled = false;
      }

      if(forPrint){
        html += `<div class="text-center font-bold">${(userSettings.companyName||'KASSENSYSTEM').toUpperCase()}</div>`;
        html += `<div class="text-center text-sm">${userSettings.address||''}</div>`;
        html += '<div class="separator"></div>';
      }

      currentBestellung.forEach((it, idx)=>{
        if(forPrint){
          html += `<div class="line"><span class="item-name">${it.quantity}x ${it.name}</span><span class="item-price">${formatCurrency(it.totalBrutto)} €</span></div>`;
        } else {
          html += `<div class="flex justify-between items-center p-2 border rounded-lg">
            <div>
              <div class="font-semibold">${it.name}</div>
              <div class="text-xs text-gray-500">${formatCurrency(it.price)} € • MwSt ${it.taxRate}%</div>
            </div>
            <div class="flex flex-col items-end">
              <div class="font-bold">${formatCurrency(it.totalBrutto)} €</div>
              <div class="text-xs mt-1">
                <button onclick="removeItem(${idx})" class="text-red-600 text-sm">-1</button>
                <button onclick="editBestellungItemQuantity(${idx})" class="ml-2 text-blue-600 text-sm">Menge</button>
              </div>
            </div>
          </div>`;
        }
      });

      if(forPrint){
        html += '<div class="separator"></div>';
        // taxSummary
        Object.keys(taxSummary).forEach(k=>{
          const s = taxSummary[k];
          html += `<div class="line"><span>MwSt ${k}%</span><span>${formatCurrency(s.tax)} €</span></div>`;
        });
        html += `<div class="separator"></div>`;
        html += `<div class="line total-line"><span>GESAMT</span><span>${formatCurrency(totalBrutto)} €</span></div>`;
        html += `<div class="text-center text-xs mt-2">${new Date().toLocaleString()}</div>`;
        container.innerHTML = html;
      } else {
        // interactive view summary
        container.innerHTML = html;
        document.getElementById('total-display').innerText = 'GESAMT: ' + formatCurrency(totalBrutto) + ' €';
      }
    }

    // Allow editing qty via prompt (from Verbesserungen)
    function editBestellungItemQuantity(index){
      const item = currentBestellung[index];
      const available = productsInventory[item.id];
      const promptText = available!==undefined ? `Aktuelle Menge für "${item.name}": ${item.quantity}\nNeue Menge (Max ${available}):` : `Aktuelle Menge für "${item.name}": ${item.quantity}\nNeue Menge:`;
      const newQ = prompt(promptText);
      if(newQ === null || newQ.trim()==='') return;
      updateBestellungItemQuantity(index, newQ);
    }

    function updateBestellungItemQuantity(index, newQuantity){
      newQuantity = parseInt(newQuantity);
      if(isNaN(newQuantity) || newQuantity<=0 || newQuantity>9999){ showToast('Ungültige Menge','error'); return; }
      const item = currentBestellung[index];
      const available = productsInventory[item.id];
      if(available!==undefined && newQuantity>available){ showToast(`Nicht genügend Bestand. Nur ${available} verfügbar.`,'error'); return; }
      item.quantity = newQuantity;
      item.totalBrutto = parseFloat((item.price * item.quantity).toFixed(2));
      renderReceipt();
      showToast('Menge aktualisiert','info');
    }

    // ----------------- FINALIZE / TRANSACTIONS -----------------
    async function openFinalizeModal(){
      document.getElementById('finalize-modal')?.remove();
      // create inline finalize modal (small) for simplicity
      const modal = document.createElement('div');
      modal.id = 'finalize-modal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="bg-white p-4 rounded-xl w-full max-w-md">
          <h3 class="text-lg font-bold mb-3">Zahlung abschließen</h3>
          <div class="mb-3 p-2 border rounded-lg"><div class="text-sm">Gesamt</div><div id="finalize-total" class="text-2xl font-bold">${formatCurrency(totalBrutto)} €</div></div>
          <div class="flex space-x-2">
            <button id="btn-karte" class="p-2 bg-indigo-600 text-white rounded-lg">KARTE</button>
            <button id="btn-bar" class="p-2 bg-green-600 text-white rounded-lg">BAR</button>
            <button onclick="closeModal('finalize-modal')" class="p-2 bg-gray-300 rounded-lg">Abbrechen</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      document.getElementById('btn-karte').onclick = ()=>handleFinalizeAction('KARTE','standard');
      document.getElementById('btn-bar').onclick = ()=>handleFinalizeAction('BAR','standard');
    }

    async function handleFinalizeAction(method, receiptType){
      if(!currentUser) { showToast('Nicht angemeldet','error'); return; }
      if(method==='BAR'){
        // optionally check cash input; for now accept
      }
      showLoading(true);
      try {
        // prepare tax summary for save
        let taxSummaryForSave = {};
        const finalTax = userSettings.taxRate || UST_FALLBACK;
        currentBestellung.forEach(item=>{
          const r = item.taxRate || finalTax;
          const netto = item.totalBrutto / (1 + r/100);
          const tax = item.totalBrutto - netto;
          const k = r.toFixed(1);
          if(!taxSummaryForSave[k]) taxSummaryForSave[k]={net:0,tax:0,gross:0,rate:r};
          taxSummaryForSave[k].net += netto; taxSummaryForSave[k].tax += tax; taxSummaryForSave[k].gross += item.totalBrutto;
        });

        const transactionData = {
          items: currentBestellung,
          totalBrutto,
          paymentMethod: method,
          receiptType,
          timestamp: serverTimestamp(),
          taxSummary: taxSummaryForSave,
          isCancelled: false,
          taxRate: finalTax,
        };

        if(method==='BAR'){ transactionData.cashReceived = parseFloat(cashReceivedInput) || totalBrutto; transactionData.cashChange = Math.max(0,(transactionData.cashReceived - totalBrutto)); }

        const tRef = await addDoc(transactionsCollectionRef(currentUser.uid), transactionData);

        // decrement inventory
        for(const it of currentBestellung){
          if(productsInventory[it.id] !== undefined){
            const newStock = Math.max(0, (productsInventory[it.id] - it.quantity));
            productsInventory[it.id] = newStock;
            // write back to firestore product doc
            const pRef = doc(db,'users',currentUser.uid,'products', it.id);
            await updateDoc(pRef, { stock: newStock }).catch(()=>{});
          }
        }

        if(receiptType !== 'none'){
          // render then print
          renderReceipt(true, receiptType, tRef.id, { seconds: Math.floor(Date.now()/1000) });
          const printContainer = document.getElementById('print-receipt-container');
          printContainer.style.display='block'; printContainer.style.visibility='visible';
          await new Promise(r=>setTimeout(r,600));
          window.print();
          setTimeout(()=>{ printContainer.innerHTML=''; printContainer.style.display='none'; },800);
        }

        currentBestellung = []; totalBrutto = 0;
        renderReceipt();
        closeModal('finalize-modal');
        showToast('Transaktion abgeschlossen','success');
      } catch(err){ console.error(err); showToast('Fehler beim Abschließen','error'); }
      finally{ showLoading(false); }
    }

    // cancel last transaction (from Finale + Verbesserungen)
    async function cancelLastTransaction(){
      if(!currentUser) return;
      showLoading(true);
      try {
        const q = query(transactionsCollectionRef(currentUser.uid), where('isCancelled','==',false), orderBy('timestamp','desc'), limit(1));
        const snap = await getDocs(q);
        if(snap.empty){ showToast('Keine letzte, nicht stornierte Transaktion gefunden.','info'); return; }
        const docSnap = snap.docs[0]; const t = { id: docSnap.id, ...docSnap.data() };
        if(!confirm(`Transaktion ${t.id.substring(0,8)} (Gesamt: ${formatCurrency(t.totalBrutto)} €) stornieren?`)){ showLoading(false); return; }

        // print cancellation receipt
        await printCancellationReceipt(t);
        // mark cancelled
        const tRef = doc(db,'users',currentUser.uid,'transactions', t.id);
        await updateDoc(tRef, { isCancelled:true, cancellationTimestamp: serverTimestamp() });

        // restore inventory if items present
        for(const it of t.items || []) {
          if(productsInventory[it.id] !== undefined){
            productsInventory[it.id] = productsInventory[it.id] + (it.quantity || 0);
            try { await updateDoc(doc(db,'users',currentUser.uid,'products', it.id), { stock: productsInventory[it.id] }); } catch(e){}
          }
        }

        showToast('Transaktion storniert','success');
      } catch(err){ console.error(err); showToast('Fehler beim Stornieren','error'); }
      finally{ showLoading(false); }
    }

    function printCancellationReceipt(transaction){
      const printArea = document.getElementById('receipt-print-area');
      let content = `<div class="w-80 p-4 font-mono text-xs"><h3 class="text-center font-bold text-red-600">STORNO-BELEG</h3><p class="text-center">ID: ${transaction.id.substring(0,8)}</p><p class="text-center">Mitarbeiter: ${currentUser.email}</p><div class="border-t my-1"></div>`;
      let total = 0;
      (transaction.items || []).forEach(item=>{
        const qty = item.quantity || item.menge || 1;
        const gross = item.totalBrutto || item.gesamtBrutto || 0;
        total += gross;
        content += `<div class="flex justify-between"><span>${qty}x ${item.name}</span><span>-${formatCurrency(gross)} €</span></div>`;
      });
      content += `<div class="border-t my-1"></div><div class="flex justify-between font-bold"><span>GESAMT STORNO</span><span>-${formatCurrency(total)} €</span></div><div class="text-center mt-2">${new Date().toLocaleString()}</div></div>`;
      printArea.innerHTML = content;
      printArea.style.display='block';
      setTimeout(()=>{ window.print(); printArea.style.display='none'; }, 600);
    }

    // ----------------- TRANSACTION HISTORY & REPORT (merged) -----------------
    async function openTransactionReversalModal(){
      if(!currentUser) return;
      const listContainer = document.getElementById('transaction-list');
      listContainer.innerHTML = '';
      showLoading(true);
      try {
        const q = query(transactionsCollectionRef(currentUser.uid), where('isCancelled','==',false), orderBy('timestamp','desc'), limit(50));
        const qs = await getDocs(q);
        transactionHistory = qs.docs.map(d=>({ id:d.id, ...d.data() }));
        if(transactionHistory.length===0){
          listContainer.innerHTML = '<p class="text-gray-500 text-center p-2">Keine aktuellen Transaktionen.</p>';
          return;
        }
        let html = '<ul class="divide-y">';
        transactionHistory.forEach((t,idx)=>{
          const time = t.timestamp?.seconds ? new Date(t.timestamp.seconds*1000).toLocaleTimeString() : '';
          const date = t.timestamp?.seconds ? new Date(t.timestamp.seconds*1000).toLocaleDateString() : '';
          html += `<li class="flex justify-between items-center py-2">
            <div><span class="font-bold">${formatCurrency(t.totalBrutto)} € (${t.paymentMethod})</span><div class="text-xs text-gray-500">${date} ${time} | Bon: ${t.id.substring(0,8)}...</div></div>
            <button onclick="handleReversal('${t.id}', ${idx})" class="bg-red-600 text-white p-1 rounded-lg">Storno</button>
          </li>`;
        });
        html += '</ul>';
        listContainer.innerHTML = html;
      } catch(err){ console.error(err); listContainer.innerHTML = '<p class="text-red-500">Fehler beim Laden</p>'; }
      finally{ showLoading(false); }
    }

    async function handleReversal(transactionId, index){
      if(!currentUser) return;
      const transaction = transactionHistory[index];
      if(!transaction) return;
      if(!confirm(`Transaktion ${transaction.id.substring(0,8)} (Gesamt: ${formatCurrency(transaction.totalBrutto)} €) wirklich stornieren?`)) return;
      showLoading(true);
      try {
        await printCancellationReceipt(transaction);
        const tRef = doc(db,'users',currentUser.uid,'transactions', transactionId);
        await updateDoc(tRef, { isCancelled:true, cancellationTimestamp: serverTimestamp() });
        // update UI
        await openTransactionReversalModal();
        showToast('Transaktion storniert','success');
      } catch(err){ console.error(err); showToast('Fehler beim Stornieren','error'); }
      finally{ showLoading(false); }
    }

    async function runDailyReport(mode='report'){
      if(!currentUser) return;
      const dateInput = document.getElementById('report-date').value;
      const targetDate = dateInput ? new Date(dateInput) : new Date();
      const start = new Date(targetDate); start.setHours(0,0,0,0);
      const end = new Date(targetDate); end.setHours(23,59,59,999);

      showLoading(true);
      try {
        // Query transactions in date range
        const q = query(transactionsCollectionRef(currentUser.uid), orderBy('timestamp','asc'));
        const qs = await getDocs(q);
        const all = qs.docs.map(d=>({ id:d.id, ...d.data() })).filter(t=>{
          if(!t.timestamp) return false;
          const ts = (t.timestamp.seconds||0)*1000;
          return ts >= start.getTime() && ts <= end.getTime();
        });

        // Build report HTML (simplified)
        let content = `<div><h3 class="font-bold">Tagesabschluss ${start.toLocaleDateString()}</h3>`;
        let totalGross=0, totalNet=0, totalTax=0; const taxSummary={}; const productSummary={}; const paymentTotals={};
        all.forEach(t=>{
          totalGross += t.totalBrutto || 0;
          Object.entries(t.taxSummary||{}).forEach(([k,v])=>{
            if(!taxSummary[k]) taxSummary[k]={net:0,tax:0,gross:0};
            taxSummary[k].net += v.net; taxSummary[k].tax += v.tax; taxSummary[k].gross += v.gross;
          });
          paymentTotals[t.paymentMethod] = (paymentTotals[t.paymentMethod] || 0) + (t.totalBrutto||0);
          (t.items||[]).forEach(it=>{
            productSummary[it.name] = productSummary[it.name] || { quantity:0, gross:0 };
            productSummary[it.name].quantity += it.quantity || 1;
            productSummary[it.name].gross += it.totalBrutto || 0;
          });
        });

        content += `<div class="mt-2"><strong>Bruttoumsatz:</strong> ${formatCurrency(totalGross)} €</div>`;
        content += `<div class="mt-2"><strong>Umsatz nach MwSt:</strong>`;
        Object.keys(taxSummary).forEach(k=>{
          const s = taxSummary[k];
          content += `<div class="text-sm ml-2">Brutto ${k}%: ${formatCurrency(s.gross)} € (Netto ${formatCurrency(s.net)} €, MwSt ${formatCurrency(s.tax)} €)</div>`;
        });
        content += `</div>`;

        content += `<div class="mt-2"><strong>Zahlungsarten:</strong>`;
        Object.keys(paymentTotals).forEach(pm=> content += `<div class="text-sm ml-2">${pm}: ${formatCurrency(paymentTotals[pm])} €</div>`);
        content += `</div>`;

        content += `<div class="mt-2"><strong>Verkaufte Artikel:</strong>`;
        Object.keys(productSummary).forEach(n => content += `<div class="text-sm ml-2">${productSummary[n].quantity}x ${n} (${formatCurrency(productSummary[n].gross)} €)</div>`);
        content += `</div></div>`;

        document.getElementById('screen-report-content').innerHTML = content;

        if(mode === 'csv'){
          // build CSV and download (basic)
          let csv = 'name,quantity,gross\n';
          Object.keys(productSummary).forEach(n => csv += `${n},${productSummary[n].quantity},${productSummary[n].gross}\n`);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download = `report_${start.toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        }
      } catch(err){ console.error(err); showToast('Fehler beim Erstellen des Berichts','error'); }
      finally{ showLoading(false); }
    }

    function setReportDateToday(){ const d = new Date(); document.getElementById('report-date').value = d.toISOString().slice(0,10); }

    // ----------------- CASH MOVEMENTS (Kassenbuch) from Verbesserungen -----------------
    function openCashMovementModal(){ document.getElementById('cash-movement-modal').style.display='flex'; toggleReceiptColumn(false); }
    async function saveCashMovement(){
      const type = document.getElementById('movement-type').value;
      const amount = parseFloat((document.getElementById('movement-amount').value||'0').replace(',', '.'));
      const reason = document.getElementById('movement-reason').value || (type==='entnahme' ? 'Entnahme' : 'Einlage');
      if(isNaN(amount) || amount<=0){ showToast('Betrag > 0 erforderlich','error'); return; }
      showLoading(true);
      try {
        await addDoc(collection(db,'cashMovements'), {
          type, amount, reason, timestamp: serverTimestamp(), userId: currentUser.uid, userName: currentUser.email
        });
        showToast('Kassenbewegung gespeichert','success');
        closeModal('cash-movement-modal');
      } catch(err){ console.error(err); showToast('Fehler beim Speichern','error'); }
      finally{ showLoading(false); }
    }

    // ----------------- Transaction history window (Verlauf modal) -----------------
    function openTransactionHistoryModal(){
      // open same report-modal but focus on history
      document.getElementById('report-modal').style.display='flex';
      toggleReceiptColumn(false);
      openTransactionReversalModal();
    }

    // ----------------- Misc startup -----------------
    document.addEventListener('DOMContentLoaded', ()=>{
      setReportDateToday();
      updateAppView('login');
    });

    // expose some functions to global for onclick handlers in HTML
    window.handleLoginSubmit = handleLoginSubmit;
    window.handleRegisterSubmit = handleRegisterSubmit;
    window.handlePasswordReset = handlePasswordReset;
    window.handleLogout = handleLogout;
    window.openLoginModal = openLoginModal;
    window.openRegistrationModal = openRegistrationModal;
    window.openForgotPasswordModal = openForgotPasswordModal;
    window.openProductModal = ()=>{ renderProductModalContent(); toggleReceiptColumn(false); document.getElementById('product-modal').style.display='flex'; };
    window.openCashMovementModal = openCashMovementModal;
    window.saveCashMovement = saveCashMovement;
    window.openReportModal = ()=>{ document.getElementById('report-modal').style.display='flex'; toggleReceiptColumn(false); };
    window.renderReceipt = renderReceipt;
    window.addToBestellung = addToBestellung;
    window.handleQuantityInput = handleQuantityInput;
    window.clearBestellung = clearBestellung;
    window.saveProduct = saveProduct;
    window.deleteProduct = deleteProduct;
    window.resetProductForm = resetProductForm;
    window.cancelLastTransaction = cancelLastTransaction;
    window.openTransactionReversalModal = openTransactionReversalModal;
    window.handleReversal = handleReversal;
    window.runDailyReport = runDailyReport;
    window.setReportDateToday = setReportDateToday;
    window.openTransactionHistoryModal = openTransactionHistoryModal;
    window.saveSettings = saveSettings;
    window.openSettingsModal = function(){ document.getElementById('settings-modal')?.remove(); const sModal = document.createElement('div'); sModal.id='settings-modal'; sModal.className='fixed inset-0 bg-black bg-opacity-70 z-[999] flex items-center justify-center p-4'; sModal.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg"><h3 class="text-xl font-bold mb-3">Einstellungen</h3><div class="mb-4 p-4 border rounded-lg bg-red-50 flex justify-between items-center"><label><span class="block text-lg">Storno-Berechtigung erteilen</span><span class="text-sm text-gray-500'>Erlaubt dem Benutzer, die letzte Transaktion zu stornieren.</span></label><input id="canCancelCheckbox" type="checkbox" class="h-6 w-6"/></div><div class="flex justify-end"><button onclick="document.getElementById('settings-modal').style.display='none'; toggleReceiptColumn(true);" class="p-2 bg-gray-300 rounded-lg">Schließen</button></div></div>`; document.body.appendChild(sModal); document.getElementById('canCancelCheckbox').checked = !!window.userSettings?.canCancelTransaction; toggleReceiptColumn(false); };
    window.saveSettings = saveSettings;

  </script>
</body>
</html>

