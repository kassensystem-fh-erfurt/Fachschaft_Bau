<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kassensystem FH-Erfurt</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
    #receipt-content-interactive { overflow-y: auto; max-height: 40vh; }
    .product-btn:active { transform: scale(0.98); }
    .numpad-btn { height: 50px; display:flex; justify-content:center; align-items:center; }
    #async-loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); z-index:100; display:none; justify-content:center; align-items:center; }
    .spinner { border: 4px solid rgba(0,0,0,0.1); border-top: 4px solid #b91c1c; border-radius: 50%; width:40px; height:40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    #toast-container { position: fixed; top:1rem; right:1rem; z-index: 500; }
    .toast { padding: 10px 20px; border-radius: 4px; color: white; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
    .toast-success { background-color: #10B981; }
    .toast-error { background-color: #EF4444; }
    @media print {
        body { margin: 0; padding: 0; background: none; }
        #app, .modal { display: none !important; }
        .receipt-print { display: block !important; width: 80mm; margin: 0 auto; font-family: 'Monospace', monospace; font-size: 12px; }
        .no-print { display: none !important; }
    }
    #receipt-column.hidden-on-mobile { display: none; }
    @media (min-width: 1024px) {
        #receipt-column.hidden-on-mobile { display: flex; }
    }
    /* Aktiver Tab-Stil */
    .tab-active {
      border-bottom-color: #b91c1c; /* Rot für aktive Tabs */
      color: #b91c1c;
      font-weight: 600;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100">

  <div id="async-loading-overlay">
    <div class="spinner"></div>
  </div>

  <div id="toast-container"></div>

  <div id="app" class="h-screen w-full flex">

    <div id="pos-column" class="flex-grow flex flex-col p-4">
      <div class="flex-shrink-0 flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold text-gray-800">Kasse</h1>
        <div class="flex space-x-2">
            <button onclick="window.openSettingsModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition">
                Einstellungen
            </button>
            <button onclick="window.openReportModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded transition">
                Berichte
            </button>
            <button onclick="window.openProductModal()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded transition">
                Produkte
            </button>
            <button onclick="window.closeTransactionReversalModal(); window.openTransactionReversalModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition">
                Storno
            </button>
            <button onclick="window.logout()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition">
                Logout
            </button>
        </div>
      </div>

      <div class="flex-grow flex flex-col lg:flex-row space-y-4 lg:space-y-0 lg:space-x-4">
        <div class="lg:w-2/3 flex flex-col space-y-4">
          <div id="category-tabs" class="flex flex-wrap space-x-2 mb-4">
            </div>

          <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 flex-grow overflow-y-auto bg-white p-4 rounded shadow-md">
            </div>
        </div>

        <div class="lg:w-1/3 flex flex-col space-y-4">
            <div class="bg-white p-4 rounded shadow-md flex-shrink-0">
                <label class="block text-gray-700 text-sm font-bold mb-2">Menge</label>
                <div class="text-3xl font-bold mb-4 p-2 border rounded text-right" id="current-quantity">1</div>
                <div id="pos-numpad" class="grid grid-cols-3 gap-2">
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(7)">7</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(8)">8</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(9)">9</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(4)">4</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(5)">5</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(6)">6</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(1)">1</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(2)">2</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(3)">3</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendQuantity(0)">0</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.clearQuantity()">C</button>
                    <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.backspaceQuantity()"><</button>
                </div>
            </div>

            <div class="bg-white p-4 rounded shadow-md flex-grow flex flex-col">
              <h3 class="text-xl font-bold mb-4">Aktueller Bon</h3>
              <div id="current-receipt-list" class="flex-grow overflow-y-auto mb-4">
                </div>
              <div class="text-2xl font-bold border-t pt-4 flex justify-between">
                <span>Gesamt:</span>
                <span id="current-total">0.00 €</span>
              </div>
            </div>

            <div class="flex space-x-2 flex-shrink-0">
              <button onclick="window.clearBestellung()" class="w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded transition">Bon leeren</button>
              <button onclick="window.openPaymentModal()" class="w-1/2 bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded transition" id="pay-button">Bezahlen</button>
            </div>
        </div>
      </div>
    </div>

    <div id="receipt-column" class="lg:w-1/4 bg-white p-4 flex-col justify-between hidden-on-mobile border-l shadow-lg">
      <h2 class="text-xl font-bold mb-4">Letzter Beleg</h2>
      <div id="last-receipt-content" class="flex-grow overflow-y-auto mb-4">
        <p class="text-gray-500">Noch kein Beleg gedruckt.</p>
      </div>
    </div>
  </div>

  <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="login-email" type="email" placeholder="E-Mail">
      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-6" id="login-password" type="password" placeholder="Passwort">
      <button onclick="window.login()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded w-full transition mb-4">Anmelden</button>
      <div class="flex justify-between text-sm">
        <button onclick="window.openRegistrationModal()" class="text-red-700 hover:text-red-800">Registrieren</button>
        <button onclick="window.openForgotPasswordModal()" class="text-red-700 hover:text-red-800">Passwort vergessen</button>
      </div>
    </div>
  </div>

  <div id="registration-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center">Registrieren</h2>
      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="reg-email" type="email" placeholder="E-Mail">
      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="reg-password" type="password" placeholder="Passwort (mind. 6 Zeichen)">
      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-6" id="reg-password-confirm" type="password" placeholder="Passwort bestätigen">
      <button onclick="window.register()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded w-full transition mb-4">Konto erstellen</button>
      <button onclick="window.closeModal('registration-modal'); window.openLoginModal()" class="text-gray-500 hover:text-gray-700 w-full">Zurück zum Login</button>
    </div>
  </div>

  <div id="forgot-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center">Passwort vergessen</h2>
      <p class="mb-4 text-gray-600">Geben Sie Ihre E-Mail-Adresse ein, um einen Link zum Zurücksetzen des Passworts zu erhalten.</p>
      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-6" id="reset-email" type="email" placeholder="E-Mail">
      <button onclick="window.sendPasswordReset()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded w-full transition mb-4">Passwort zurücksetzen</button>
      <button onclick="window.closeModal('forgot-password-modal'); window.openLoginModal()" class="text-gray-500 hover:text-gray-700 w-full">Zurück zum Login</button>
    </div>
  </div>

  <div id="payment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-lg">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold">Zahlung abschließen</h2>
        <button onclick="window.closeModal('payment-modal')" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">×</button>
      </div>

      <div class="flex justify-between items-center mb-6">
        <span class="text-xl font-semibold">Zu zahlen:</span>
        <span id="payment-total" class="text-3xl font-bold text-red-700">0.00 €</span>
      </div>

      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-2">Zahlungsmethode</h3>
        <div class="flex space-x-4">
          <button id="cash-btn" onclick="window.selectPaymentMethod('cash')" class="flex-grow bg-gray-200 hover:bg-gray-300 py-3 rounded font-semibold transition">BAR</button>
          <button id="card-btn" onclick="window.selectPaymentMethod('card')" class="flex-grow bg-gray-200 hover:bg-gray-300 py-3 rounded font-semibold transition">KARTE</button>
        </div>
      </div>

      <div id="cash-payment-details" class="hidden">
        <label class="block text-gray-700 text-sm font-bold mb-2">Erhalten Betrag</label>
        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4 text-right text-2xl font-bold" id="amount-received" type="text" value="0.00" readonly>
        
        <div class="flex justify-between items-center mb-6">
            <span class="text-xl font-semibold">Rückgeld:</span>
            <span id="change-display" class="text-2xl font-bold text-green-700">0.00 €</span>
        </div>

        <div id="payment-numpad" class="grid grid-cols-3 gap-2">
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(7)">7</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(8)">8</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(9)">9</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(4)">4</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(5)">5</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(6)">6</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(1)">1</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(2)">2</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(3)">3</button>
            <button class="numpad-btn numpad-btn-decimal bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue('.')">.</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.appendPaymentValue(0)">0</button>
            <button class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded text-xl" onclick="window.clearPaymentValue()">C</button>
        </div>
      </div>

      <div id="receipt-options" class="mt-6 border-t pt-4">
        <h3 class="text-lg font-semibold mb-2">Beleg-Optionen</h3>
        <select id="receipt-type" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
          <option value="none">Ohne Beleg</option>
          <option value="standard">Standard Bon</option>
          <option value="tax_receipt">Bewirtungsbeleg</option>
        </select>
        <button onclick="window.completePayment()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded w-full transition" id="complete-payment-button" disabled>Zahlung abschließen</button>
      </div>
    </div>
  </div>

  <div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold">Produkt- und Kategorie-Verwaltung</h2>
        <button onclick="window.closeModal('product-modal'); window.renderCategoryTabs(); window.renderProductGrid(window.currentCategory)" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">×</button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-1 border-r pr-6">
          <h3 class="text-xl font-semibold mb-4">Kategorien</h3>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-2" id="new-category-name" type="text" placeholder="Neue Kategorie">
          <div class="flex space-x-2 mb-4">
            <button onclick="window.addCategory()" class="flex-grow bg-red-700 hover:bg-red-800 text-white font-bold py-2 rounded transition">Hinzufügen</button>
            <button onclick="window.updateCategory()" class="flex-grow bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded transition" id="update-category-btn" disabled>Bearbeiten</button>
          </div>
          <div id="category-list" class="space-y-2 max-h-60 overflow-y-auto">
            </div>
        </div>

        <div class="lg:col-span-2">
          <h3 class="text-xl font-semibold mb-4">Produkte</h3>
          
          <div class="grid grid-cols-2 gap-4">
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="product-name" type="text" placeholder="Name">
            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="product-price" type="number" step="0.01" placeholder="Preis (Netto)">
            <select class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="product-tax-rate">
              <option value="19">19% Mehrwertsteuer</option>
              <option value="7">7% Mehrwertsteuer</option>
            </select>
            <select class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="product-category">
              </select>
          </div>

          <div class="flex space-x-2 mt-4">
            <button onclick="window.addProduct()" class="flex-grow bg-red-700 hover:bg-red-800 text-white font-bold py-2 rounded transition" id="add-product-btn">Produkt hinzufügen</button>
            <button onclick="window.saveProduct()" class="flex-grow bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded transition hidden" id="save-product-btn">Speichern</button>
            <button onclick="window.deleteProduct()" class="flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded transition hidden" id="delete-product-btn">Löschen</button>
            <button onclick="window.cancelEditProduct()" class="flex-grow bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 rounded transition hidden" id="cancel-product-btn">Abbrechen</button>
          </div>

          <div id="product-management-list" class="mt-6 space-y-2 max-h-96 overflow-y-auto border-t pt-4">
            </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="settings-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-4 rounded shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold">Einstellungen</h2>
        <button onclick="window.closeModal('settings-modal')" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">×</button>
      </div>

      <div class="flex border-b mb-4">
        <button id="receipt-settings-tab" onclick="window.switchSettingsTab('bon-settings')" class="px-4 py-2 border-b-2 border-transparent transition text-gray-600 hover:text-red-700 tab-active">
          Bon-Einstellungen
        </button>
        <button id="user-settings-tab" onclick="window.switchSettingsTab('user-settings')" class="px-4 py-2 border-b-2 border-transparent transition text-gray-600 hover:text-red-700">
          Benutzer-Einstellungen
        </button>
      </div>

      <div id="settings-content-container">

        <div id="bon-settings-content" class="p-4">
          <h2 class="text-xl font-bold mb-4">Bon-Einstellungen (Druck)</h2>

          <label class="block text-gray-700 text-sm font-bold mb-2" for="company-name">
              Firmenname
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="company-name" type="text" placeholder="Ihr Firmenname">

          <label class="block text-gray-700 text-sm font-bold mb-2" for="company-address">
              Adresse
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="company-address" type="text" placeholder="Ihre Adresse">
          
          <label class="block text-gray-700 text-sm font-bold mb-2" for="company-tax-id">
              Steuernummer
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="company-tax-id" type="text" placeholder="Ihre Steuernummer">

          <label class="block text-gray-700 text-sm font-bold mb-2" for="fallback-tax-rate">
              Fallback Mehrwertsteuersatz (%)
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-4" id="fallback-tax-rate" type="number" step="1" placeholder="z.B. 19">

        </div>
        
        <div id="user-settings-content" class="p-4 hidden">
          <h2 class="text-xl font-bold mb-4">Benutzer-Einstellungen</h2>

          <h3 class="text-lg font-semibold mb-2">Storno Code</h3>
          <label class="block text-gray-700 text-sm font-bold mb-2" for="reversal-code">
              Code für Transaktions-Stornierung (PIN)
          </label>
          <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="reversal-code" type="password" placeholder="z.B. 1234">
          <p class="text-xs text-gray-500 mb-4">Dieser Code wird benötigt, um Transaktionen stornieren zu können.</p>

        </div>

      </div>

      <div class="border-t pt-4 mt-4">
        <button onclick="window.saveSettings()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded w-full transition">Einstellungen speichern</button>
      </div>
    </div>
  </div>

  <div id="report-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold">Tagesabschluss und Historie</h2>
        <button onclick="window.closeModal('report-modal')" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">×</button>
      </div>
      
      <div class="flex space-x-4 mb-6 items-end">
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2" for="report-date">Datum auswählen</label>
          <input type="date" id="report-date" onchange="window.generateReport()" class="shadow border rounded py-2 px-3 text-gray-700">
        </div>
        <button onclick="window.generateReport()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded transition">Bericht generieren</button>
        <button onclick="window.exportReportCsv()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition">CSV Export</button>
      </div>

      <div id="report-summary" class="bg-gray-100 p-4 rounded mb-6 hidden">
        <h3 class="text-xl font-semibold mb-4 border-b pb-2">Zusammenfassung</h3>
        <div class="grid grid-cols-2 gap-4 text-lg">
          <div><span class="font-semibold">Gesamtumsatz Brutto:</span> <span id="report-total-gross" class="font-bold">0.00 €</span></div>
          <div><span class="font-semibold">Gesamtumsatz Netto:</span> <span id="report-total-net" class="font-bold">0.00 €</span></div>
          <div><span class="font-semibold">Gesamt MwSt.:</span> <span id="report-total-tax" class="font-bold">0.00 €</span></div>
        </div>
        
        <h4 class="text-lg font-semibold mt-4 mb-2">MwSt. Aufschlüsselung:</h4>
        <div id="report-tax-summary" class="grid grid-cols-2 gap-2">
          </div>
        
        <h4 class="text-lg font-semibold mt-4 mb-2">Umsatz nach Zahlung:</h4>
        <div id="report-payment-summary" class="grid grid-cols-2 gap-2">
          </div>

        <h4 class="text-lg font-semibold mt-4 mb-2">Umsatz nach Produkt:</h4>
        <div id="report-product-summary" class="space-y-1 text-sm max-h-40 overflow-y-auto">
          </div>
      </div>

      <h3 class="text-xl font-semibold mb-4 border-b pb-2">Transaktions-Historie</h3>
      <div id="transaction-history-list" class="space-y-2 max-h-60 overflow-y-auto">
        <p class="text-gray-500" id="no-transactions-msg">Keine Transaktionen für das gewählte Datum.</p>
        </div>
    </div>
  </div>

  <div id="transaction-reversal-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden justify-center items-center z-50">
    <div class="bg-white p-8 rounded shadow-xl w-full max-w-md">
      <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-red-700">Transaktion stornieren</h2>
        <button onclick="window.closeTransactionReversalModal()" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">×</button>
      </div>

      <p class="mb-4 text-gray-600">Um die **letzte Transaktion** zu stornieren, geben Sie bitte Ihren Storno Code ein.</p>

      <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mb-6" id="transaction-reversal-code" type="password" placeholder="Storno Code (PIN)">

      <div id="last-transaction-details" class="mb-6 p-4 border rounded bg-gray-50">
          </div>

      <button onclick="window.checkReversalCode()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded w-full transition" id="reversal-button" disabled>Stornierung bestätigen</button>
    </div>
  </div>


  <div id="receipt-print-template" class="receipt-print hidden">
    </div>

  <script>
    // Konfiguration (ersetzen Sie dies mit Ihrer Firebase-Konfiguration)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "kassensystem-85412.firebaseapp.com",
      projectId: "kassensystem-85412",
      storageBucket: "kassensystem-85412.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Globale Variablen
    window.userId = null;
    window.currentBestellung = [];
    window.currentQuantity = 1;
    window.currentCategory = 'Alle';
    window.products = {};
    window.categories = [];
    window.settings = {};
    window.editProductId = null;
    window.lastTransactionToReverse = null; // Für Storno-Funktion

    // Firebase Initialisierung
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --------------------------------------------------------
    // ---------- General UI/Helper Functions -----------------
    // --------------------------------------------------------

    window.showLoading = function(show) {
        document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none';
    }
    
    window.showToast = function(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `${message}`;
        container.appendChild(toast);

        // Auto-hide after 3 seconds
        setTimeout(() => {
            toast.style.opacity = 0;
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    }

    window.toggleReceiptColumn = function(show) {
        const column = document.getElementById('receipt-column');
        // Auf Mobilgeräten soll der Beleg-Spalte ausgeblendet werden
        if (window.innerWidth < 1024) {
             column.style.display = 'none';
        } else {
             column.style.display = show ? 'flex' : 'none';
        }
    }

    window.updateAppView = function(view) {
        const app = document.getElementById('app');
        const loginModal = document.getElementById('login-modal');
        if (view === 'pos') {
            app.style.display = 'flex';
            loginModal.style.display = 'none';
            window.toggleReceiptColumn(true);
        } else {
            app.style.display = 'none';
            loginModal.style.display = 'flex';
            window.toggleReceiptColumn(false);
        }
    }

    window.closeModal = function(id) {
        document.getElementById(id).style.display = 'none';
        window.toggleReceiptColumn(true);
    }

    window.openLoginModal = function(){ document.getElementById('login-modal').style.display='flex'; window.toggleReceiptColumn(false); };
    window.openRegistrationModal = function(){ window.closeModal('login-modal'); window.toggleReceiptColumn(false); document.getElementById('registration-modal').style.display='flex'; };
    window.openForgotPasswordModal = function(){ window.closeModal('login-modal'); window.toggleReceiptColumn(false); document.getElementById('forgot-password-modal').style.display='flex'; };
    
    // --------------------------------------------------------
    // ---------- Authentication ------------------------------
    // --------------------------------------------------------

    firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
            window.userId = user.uid;
            await window.loadSettings();
            await window.loadData();
            window.updateAppView('pos');
        } else {
            window.userId = null;
            window.updateAppView('login');
        }
    });

    window.login = async function() {
        window.showLoading(true);
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            await firebase.auth().signInWithEmailAndPassword(email, password);
            // onAuthStateChanged handler takes over
        } catch (error) {
            window.showToast(`Login fehlgeschlagen: ${error.message}`, 'error');
        }
        window.showLoading(false);
    }

    window.register = async function() {
        window.showLoading(true);
        const email = document.getElementById('reg-email').value;
        const password = document.getElementById('reg-password').value;
        const passwordConfirm = document.getElementById('reg-password-confirm').value;

        if (password !== passwordConfirm) {
            window.showToast('Passwörter stimmen nicht überein.', 'error');
            window.showLoading(false);
            return;
        }

        try {
            const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
            // Default-Einstellungen für neuen Benutzer speichern
            await db.collection('settings').doc(userCredential.user.uid).set({
                companyName: 'Ihr Geschäft',
                companyAddress: 'Ihre Adresse',
                companyTaxId: 'Ihre Steuernummer',
                fallbackTaxRate: 19,
                reversalCode: '1234'
            });
            window.showToast('Registrierung erfolgreich. Sie sind angemeldet.', 'success');
        } catch (error) {
            window.showToast(`Registrierung fehlgeschlagen: ${error.message}`, 'error');
        }
        window.showLoading(false);
    }

    window.logout = async function() {
        window.showLoading(true);
        try {
            await firebase.auth().signOut();
            window.showToast('Erfolgreich abgemeldet.', 'success');
            // onAuthStateChanged handler takes over
        } catch (error) {
            window.showToast(`Logout fehlgeschlagen: ${error.message}`, 'error');
        }
        window.showLoading(false);
    }

    window.sendPasswordReset = async function() {
        window.showLoading(true);
        const email = document.getElementById('reset-email').value;
        try {
            await firebase.auth().sendPasswordResetEmail(email);
            window.showToast(`Passwort-Reset-Link an ${email} gesendet.`, 'success');
            window.closeModal('forgot-password-modal');
            window.openLoginModal();
        } catch (error) {
            window.showToast(`Passwort-Reset fehlgeschlagen: ${error.message}`, 'error');
        }
        window.showLoading(false);
    }

    // --------------------------------------------------------
    // ---------- Settings (NEU: Tab-Logik) -------------------
    // --------------------------------------------------------
    
    window.switchSettingsTab = function(tabName) {
        // Alle Tabs ausblenden
        document.getElementById('bon-settings-content').classList.add('hidden');
        document.getElementById('user-settings-content').classList.add('hidden');
        
        // Alle Tab-Buttons auf inaktiv setzen
        document.getElementById('receipt-settings-tab').classList.remove('tab-active');
        document.getElementById('user-settings-tab').classList.remove('tab-active');
        document.getElementById('receipt-settings-tab').classList.add('bg-transparent');
        document.getElementById('user-settings-tab').classList.add('bg-transparent');


        // Gewählten Tab anzeigen und Button als aktiv markieren
        if (tabName === 'bon-settings') {
            document.getElementById('bon-settings-content').classList.remove('hidden');
            document.getElementById('receipt-settings-tab').classList.add('tab-active');
        } else if (tabName === 'user-settings') {
            document.getElementById('user-settings-content').classList.remove('hidden');
            document.getElementById('user-settings-tab').classList.add('tab-active');
        }
    }

    window.openSettingsModal = function() {
        document.getElementById('settings-modal').style.display='flex'; 
        window.toggleReceiptColumn(false);
        // Standardmäßig den Bon-Einstellungen Tab anzeigen und Daten laden
        window.loadSettings().then(() => {
            window.switchSettingsTab('bon-settings');
        });
    }

    window.saveSettings = async function() {
        if (!window.userId) return;
        window.showLoading(true);
        try {
            const companyName = document.getElementById('company-name').value;
            const companyAddress = document.getElementById('company-address').value;
            const companyTaxId = document.getElementById('company-tax-id').value;
            const fallbackTaxRate = parseFloat(document.getElementById('fallback-tax-rate').value);
            const reversalCode = document.getElementById('reversal-code').value; // NEU: Code aus neuem Tab

            await db.collection('settings').doc(window.userId).set({
                companyName: companyName,
                companyAddress: companyAddress,
                companyTaxId: companyTaxId,
                fallbackTaxRate: fallbackTaxRate,
                reversalCode: reversalCode, // Speichern des Storno Codes
            }, { merge: true });

            await window.loadSettings(); // Einstellungen neu laden
            window.showToast('Einstellungen erfolgreich gespeichert.', 'success');
            window.closeModal('settings-modal');

        } catch(err) {
            console.error('Settings save error', err);
            window.showToast('Fehler beim Speichern der Einstellungen.', 'error');
        }
        window.showLoading(false);
    }

    window.loadSettings = async function() {
        if (!window.userId) return;
        try {
            const doc = await db.collection('settings').doc(window.userId).get();
            if (doc.exists) {
                window.settings = doc.data();
                document.getElementById('company-name').value = window.settings.companyName || '';
                document.getElementById('company-address').value = window.settings.companyAddress || '';
                document.getElementById('company-tax-id').value = window.settings.companyTaxId || '';
                document.getElementById('fallback-tax-rate').value = window.settings.fallbackTaxRate || 19;
                
                // Laden des Storno Codes in den neuen Tab
                if(window.settings.reversalCode) {
                    document.getElementById('reversal-code').value = window.settings.reversalCode;
                } else {
                    document.getElementById('reversal-code').value = '';
                }
            } else {
                window.settings = {}; // Setze leere Einstellungen, falls Dokument nicht existiert
            }
        } catch(err) {
            console.error('Settings load error', err);
        }
    }

    // --------------------------------------------------------
    // ---------- Product and Category Management -------------
    // --------------------------------------------------------

    window.loadData = async function() {
        if (!window.userId) return;
        window.showLoading(true);
        try {
            // PRODUCTS LISTENER
            db.collection('users').doc(window.userId).collection('products').onSnapshot(snapshot => {
                window.products = {};
                snapshot.forEach(doc => {
                    window.products[doc.id] = { id: doc.id, ...doc.data() };
                });
                window.renderProductGrid(window.currentCategory);
                window.renderProductManagementList();
            });

            // CATEGORIES LISTENER
            db.collection('users').doc(window.userId).collection('categories').onSnapshot(snapshot => {
                window.categories = ['Alle'];
                snapshot.forEach(doc => {
                    window.categories.push(doc.data().name);
                });
                
                if (window.categories.length > 0) {
                    if (!window.categories.includes(window.currentCategory)) {
                        window.currentCategory = window.categories[0];
                    }
                } else {
                    window.currentCategory = 'Alle';
                }

                window.renderCategoryTabs();
                window.renderProductCategorySelect();
            });
            
        } catch(err) {
            console.error('Data load error', err);
            window.showToast('Fehler beim Laden der Produktdaten.', 'error');
        }
        window.showLoading(false);
    }

    // --- Category CRUD ---
    window.addCategory = async function() {
        const name = document.getElementById('new-category-name').value.trim();
        if (name === '') return;

        try {
            await db.collection('users').doc(window.userId).collection('categories').add({
                name: name
            });
            document.getElementById('new-category-name').value = '';
            window.showToast('Kategorie hinzugefügt.', 'success');
        } catch(err) {
            window.showToast('Fehler beim Hinzufügen der Kategorie.', 'error');
        }
    }

    window.renderProductCategorySelect = function() {
        const select = document.getElementById('product-category');
        select.innerHTML = '';
        window.categories.filter(c => c !== 'Alle').forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            select.appendChild(option);
        });
    }

    // --- Product CRUD ---
    window.openProductModal = function(){ 
        window.renderProductModalContent(); 
        window.toggleReceiptColumn(false); 
        document.getElementById('product-modal').style.display='flex'; 
    };

    window.renderProductModalContent = function() {
        window.renderCategoryList();
        window.renderProductManagementList();
        window.resetProductForm();
    }
    
    window.resetProductForm = function() {
        document.getElementById('product-name').value = '';
        document.getElementById('product-price').value = '';
        document.getElementById('product-tax-rate').value = '19';
        document.getElementById('product-category').selectedIndex = 0;

        document.getElementById('add-product-btn').classList.remove('hidden');
        document.getElementById('save-product-btn').classList.add('hidden');
        document.getElementById('delete-product-btn').classList.add('hidden');
        document.getElementById('cancel-product-btn').classList.add('hidden');
        window.editProductId = null;
    }

    window.addProduct = async function() {
        const name = document.getElementById('product-name').value.trim();
        const price = parseFloat(document.getElementById('product-price').value);
        const taxRate = parseInt(document.getElementById('product-tax-rate').value);
        const category = document.getElementById('product-category').value;

        if (!name || isNaN(price) || price <= 0 || !category) {
            window.showToast('Bitte alle Felder korrekt ausfüllen.', 'error');
            return;
        }

        try {
            await db.collection('users').doc(window.userId).collection('products').add({
                name: name,
                price: price, // Netto
                taxRate: taxRate,
                category: category
            });
            window.showToast('Produkt hinzugefügt.', 'success');
            window.resetProductForm();
        } catch(err) {
            window.showToast('Fehler beim Hinzufügen des Produkts.', 'error');
        }
    }

    window.renderProductManagementList = function() {
        const list = document.getElementById('product-management-list');
        list.innerHTML = '';

        Object.values(window.products).forEach(product => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center p-3 border rounded bg-gray-50 hover:bg-gray-100 cursor-pointer';
            div.onclick = () => window.editProduct(product.id);
            div.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold">${product.name}</p>
                    <p class="text-sm text-gray-600">${product.category} | Netto: ${product.price.toFixed(2)} €</p>
                </div>
                <span class="text-sm text-red-700 font-semibold">Brutto: ${(product.price * (1 + product.taxRate/100)).toFixed(2)} €</span>
            `;
            list.appendChild(div);
        });
    }
    
    window.editProduct = function(productId) {
        const product = window.products[productId];
        if (!product) return;

        window.editProductId = productId;
        document.getElementById('product-name').value = product.name;
        document.getElementById('product-price').value = product.price;
        document.getElementById('product-tax-rate').value = product.taxRate;
        document.getElementById('product-category').value = product.category;

        document.getElementById('add-product-btn').classList.add('hidden');
        document.getElementById('save-product-btn').classList.remove('hidden');
        document.getElementById('delete-product-btn').classList.remove('hidden');
        document.getElementById('cancel-product-btn').classList.remove('hidden');
    }

    window.saveProduct = async function() {
        if (!window.editProductId) return;

        const name = document.getElementById('product-name').value.trim();
        const price = parseFloat(document.getElementById('product-price').value);
        const taxRate = parseInt(document.getElementById('product-tax-rate').value);
        const category = document.getElementById('product-category').value;

        if (!name || isNaN(price) || price <= 0 || !category) {
            window.showToast('Bitte alle Felder korrekt ausfüllen.', 'error');
            return;
        }

        try {
            await db.collection('users').doc(window.userId).collection('products').doc(window.editProductId).update({
                name: name,
                price: price,
                taxRate: taxRate,
                category: category
            });
            window.showToast('Produkt gespeichert.', 'success');
            window.resetProductForm();
        } catch(err) {
            window.showToast('Fehler beim Speichern des Produkts.', 'error');
        }
    }

    window.deleteProduct = async function() {
        if (!window.editProductId || !confirm('Sind Sie sicher, dass Sie dieses Produkt löschen möchten?')) return;

        try {
            await db.collection('users').doc(window.userId).collection('products').doc(window.editProductId).delete();
            window.showToast('Produkt gelöscht.', 'success');
            window.resetProductForm();
        } catch(err) {
            window.showToast('Fehler beim Löschen des Produkts.', 'error');
        }
    }

    window.cancelEditProduct = function() {
        window.resetProductForm();
    }
    
    // --------------------------------------------------------
    // ---------- POS / Kasse Logic ---------------------------
    // --------------------------------------------------------

    window.renderProductGrid = function(category) {
        const grid = document.getElementById('product-grid');
        grid.innerHTML = '';
        const filteredProducts = Object.values(window.products).filter(p => category === 'Alle' || p.category === category);

        if (filteredProducts.length === 0) {
            grid.innerHTML = '<p class="text-gray-500 col-span-4">Keine Produkte in dieser Kategorie.</p>';
        }

        filteredProducts.forEach(product => {
            const btn = document.createElement('button');
            btn.className = 'product-btn bg-white p-4 rounded shadow-md hover:shadow-lg transition flex flex-col items-center justify-center border-b-4 border-red-700 hover:border-red-800';
            btn.onclick = () => window.addProductToBestellung(product);
            btn.innerHTML = `
                <span class="font-semibold text-lg text-gray-800">${product.name}</span>
                <span class="text-red-700 font-bold">${(product.price * (1 + product.taxRate/100)).toFixed(2)} €</span>
            `;
            grid.appendChild(btn);
        });
    }

    window.renderCategoryTabs = function() {
        const tabs = document.getElementById('category-tabs');
        tabs.innerHTML = '';

        window.categories.forEach(category => {
            const btn = document.createElement('button');
            btn.className = `px-3 py-1 rounded-full text-sm font-medium transition ${window.currentCategory === category ? 'bg-red-700 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`;
            btn.textContent = category;
            btn.onclick = () => {
                window.currentCategory = category;
                window.renderCategoryTabs();
                window.renderProductGrid(category);
            };
            tabs.appendChild(btn);
        });
    }

    window.addProductToBestellung = function(product) {
        if (window.currentQuantity <= 0) {
             window.showToast('Menge muss größer als 0 sein.', 'error');
             return;
        }

        const netPrice = parseFloat(product.price);
        const taxRate = parseInt(product.taxRate);
        const taxFactor = 1 + taxRate / 100;
        const grossPrice = netPrice * taxFactor;

        // Versuche, das Produkt zu finden, das bereits auf dem Bon ist und denselben Preis/Steuersatz hat
        const existingItem = window.currentBestellung.find(item => item.id === product.id);

        if (existingItem) {
            existingItem.quantity += window.currentQuantity;
        } else {
            window.currentBestellung.push({
                id: product.id,
                name: product.name,
                netPrice: netPrice,
                taxRate: taxRate,
                grossPrice: grossPrice, // Brutto-Einzelpreis
                quantity: window.currentQuantity
            });
        }

        window.renderCurrentReceipt();
        window.clearQuantity();
    }

    window.renderCurrentReceipt = function() {
        const list = document.getElementById('current-receipt-list');
        list.innerHTML = '';
        let totalGross = 0;

        window.currentBestellung.forEach((item, index) => {
            const itemTotalGross = item.grossPrice * item.quantity;
            totalGross += itemTotalGross;

            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 border-b last:border-b-0 group';
            div.innerHTML = `
                <div>
                    <span class="font-medium">${item.name}</span>
                    <span class="text-sm text-gray-500"> (${item.quantity} x ${item.grossPrice.toFixed(2)} €)</span>
                    <button onclick="window.removeItemFromBestellung(${index})" class="text-red-500 text-sm ml-2 opacity-0 group-hover:opacity-100 transition">Entfernen</button>
                </div>
                <span class="font-bold text-gray-700">${itemTotalGross.toFixed(2)} €</span>
            `;
            list.appendChild(div);
        });

        document.getElementById('current-total').textContent = `${totalGross.toFixed(2)} €`;
        document.getElementById('payment-total').textContent = `${totalGross.toFixed(2)} €`;

        if (totalGross > 0) {
            document.getElementById('pay-button').disabled = false;
        } else {
            document.getElementById('pay-button').disabled = true;
        }
    }

    window.removeItemFromBestellung = function(index) {
        window.currentBestellung.splice(index, 1);
        window.renderCurrentReceipt();
    }

    window.clearBestellung = function() {
        window.currentBestellung = [];
        window.renderCurrentReceipt();
    }

    window.appendQuantity = function(value) {
        let current = document.getElementById('current-quantity').textContent;
        if (current === '1' && value !== 0) {
            current = '';
        } else if (current === '0' && value === 0) {
            return;
        }

        if (current === '0') {
             current = '';
        }

        current += value;
        
        // Begrenze auf 4 Ziffern
        if (current.length > 4) {
            current = current.substring(current.length - 4);
        }

        document.getElementById('current-quantity').textContent = current;
        window.currentQuantity = parseInt(current) || 0;
    }

    window.clearQuantity = function() {
        document.getElementById('current-quantity').textContent = '1';
        window.currentQuantity = 1;
    }

    window.backspaceQuantity = function() {
        let current = document.getElementById('current-quantity').textContent;
        if (current.length > 1) {
            current = current.slice(0, -1);
        } else {
            current = '1';
        }
        document.getElementById('current-quantity').textContent = current;
        window.currentQuantity = parseInt(current) || 0;
    }
    
    // --------------------------------------------------------
    // ---------- Payment & Transaction Completion ------------
    // --------------------------------------------------------

    window.openPaymentModal = function() {
        document.getElementById('payment-modal').style.display = 'flex';
        window.toggleReceiptColumn(false);
        window.selectPaymentMethod('cash'); // Standardmäßig Barzahlung beim Öffnen
        window.resetPaymentValue();
    }

    window.paymentMethod = 'cash'; // Default
    
    window.selectPaymentMethod = function(method) {
        window.paymentMethod = method;
        document.getElementById('cash-btn').classList.remove('bg-red-700', 'text-white', 'bg-gray-200');
        document.getElementById('card-btn').classList.remove('bg-red-700', 'text-white', 'bg-gray-200');
        
        document.getElementById('cash-btn').classList.add('bg-gray-200');
        document.getElementById('card-btn').classList.add('bg-gray-200');

        if (method === 'cash') {
            document.getElementById('cash-btn').classList.add('bg-red-700', 'text-white');
            document.getElementById('cash-payment-details').classList.remove('hidden');
            window.resetPaymentValue();
        } else {
            document.getElementById('card-btn').classList.add('bg-red-700', 'text-white');
            document.getElementById('cash-payment-details').classList.add('hidden');
            const total = parseFloat(document.getElementById('payment-total').textContent.replace(' €', ''));
            window.updateChange(total); // Keine Berechnung bei Karte
        }
        window.updatePaymentButtonState();
    }

    window.resetPaymentValue = function() {
        const total = parseFloat(document.getElementById('payment-total').textContent.replace(' €', ''));
        document.getElementById('amount-received').value = total.toFixed(2);
        window.updateChange(total);
    }
    
    window.updateChange = function(amountReceived) {
        const total = parseFloat(document.getElementById('payment-total').textContent.replace(' €', ''));
        let change = 0;
        
        if (window.paymentMethod === 'cash') {
            change = amountReceived - total;
        } else {
            change = 0; // Kein Rückgeld bei Karte
        }

        document.getElementById('change-display').textContent = `${change.toFixed(2)} €`;
        
        window.updatePaymentButtonState();
    }
    
    window.appendPaymentValue = function(value) {
        const input = document.getElementById('amount-received');
        let current = input.value;
        
        if (value === '.') {
            if (current.includes('.')) return;
            if (current === '0.00' || current === '0') {
                 current = '0.';
            } else if (!current.includes('.')) {
                 current += '.';
            }
        } else {
            // Entferne Formatierung für Eingabe
            let cleanCurrent = current.replace(/[^\d]/g, ''); 
            
            // Logik zur Behandlung von Dezimalstellen (zwei Nachkommastellen)
            if (current.includes('.')) {
                const parts = current.split('.');
                if (parts[1].length >= 2) return;
                current += value;
            } else {
                 if (current === '0' || current === '0.00') {
                    current = value.toString();
                 } else {
                    current += value.toString();
                 }
            }
        }

        input.value = current;
        window.updateChange(parseFloat(input.value));
    }
    
    window.clearPaymentValue = function() {
        document.getElementById('amount-received').value = '0.00';
        window.updateChange(0);
    }

    window.updatePaymentButtonState = function() {
        const total = parseFloat(document.getElementById('payment-total').textContent.replace(' €', ''));
        const change = parseFloat(document.getElementById('change-display').textContent.replace(' €', ''));
        const button = document.getElementById('complete-payment-button');

        if (window.paymentMethod === 'card') {
            button.disabled = total <= 0;
        } else { // cash
            button.disabled = change < 0 || total <= 0;
        }
    }

    window.getTaxSummary = function(bestellung) {
        const summary = {};
        let totalNet = 0;
        let totalTax = 0;

        bestellung.forEach(item => {
            const taxRate = item.taxRate;
            // Brutto = Netto * (1 + Steuersatz/100)
            // Netto = Brutto / (1 + Steuersatz/100)
            const itemNet = (item.grossPrice / (1 + taxRate/100)) * item.quantity;
            const itemTax = item.grossPrice * item.quantity - itemNet;

            if (!summary[taxRate]) {
                summary[taxRate] = { net: 0, tax: 0 };
            }

            summary[taxRate].net += itemNet;
            summary[taxRate].tax += itemTax;

            totalNet += itemNet;
            totalTax += itemTax;
        });

        return { summary, totalNet, totalTax };
    }

    window.generateReceiptHTML = function(bestellung, totalGross, paymentMethod, change, isReversal = false, transactionId = 'N/A') {
        const { summary, totalNet, totalTax } = window.getTaxSummary(bestellung);
        const settings = window.settings;
        const receiptType = document.getElementById('receipt-type') ? document.getElementById('receipt-type').value : 'standard';

        let html = `
            <div class="receipt-print">
                <div style="text-align:center; font-weight:bold; margin-bottom:10px;">
                    ${isReversal ? '<h1 style="color:red; font-size:1.2em;">STORNO</h1>' : ''}
                    ${settings.companyName || 'Ihr Geschäft'}
                </div>
                <div style="text-align:center; font-size:0.9em; margin-bottom:15px;">
                    ${settings.companyAddress || 'Ihre Adresse'}<br>
                    Ust-ID/Steuer-Nr.: ${settings.companyTaxId || 'N/A'}<br>
                    Datum: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}<br>
                    Transaktion: ${transactionId}
                </div>
                <div style="border-top:1px dashed #000; margin-bottom:10px; padding-top:5px;"></div>
                
                ${bestellung.map(item => `
                    <div style="display:flex; justify-content:space-between; font-size:1em; margin-bottom:5px;">
                        <div>
                            <span style="font-weight:bold;">${item.name}</span>
                            <span style="font-size:0.9em; color:#555;"> (${item.taxRate}% MwSt.)</span>
                        </div>
                        <div style="text-align:right;">
                            ${item.quantity.toFixed(0)} x ${(item.grossPrice).toFixed(2)} €
                        </div>
                    </div>
                    <div style="text-align:right; font-weight:bold; margin-bottom:5px;">
                        ${(item.grossPrice * item.quantity).toFixed(2)} €
                    </div>
                `).join('')}

                <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px;"></div>
                
                <div style="display:flex; justify-content:space-between; font-size:1.2em; font-weight:bold;">
                    <span>GESAMT (${isReversal ? 'STORNO' : 'BRUTTO'}):</span>
                    <span>${totalGross.toFixed(2)} €</span>
                </div>
                
                <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px;"></div>

                <div style="font-size:0.9em;">
                    <div style="font-weight:bold; margin-bottom:5px;">MwSt. Aufschlüsselung:</div>
                    ${Object.entries(summary).map(([rate, data]) => `
                        <div style="display:flex; justify-content:space-between;">
                            <span>${rate}% Netto:</span>
                            <span>${data.net.toFixed(2)} €</span>
                        </div>
                        <div style="display:flex; justify-content:space-between;">
                            <span>${rate}% MwSt.:</span>
                            <span>${data.tax.toFixed(2)} €</span>
                        </div>
                    `).join('')}
                    <div style="border-top:1px solid #ddd; margin-top:5px; padding-top:5px; display:flex; justify-content:space-between; font-weight:bold;">
                        <span>Gesamt Netto:</span>
                        <span>${totalNet.toFixed(2)} €</span>
                    </div>
                </div>

                <div style="border-top:1px dashed #000; margin-top:10px; padding-top:5px;"></div>

                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>Bezahlt mit:</span>
                    <span>${paymentMethod.toUpperCase()}</span>
                </div>
                ${paymentMethod === 'cash' ? `
                    <div style="display:flex; justify-content:space-between;">
                        <span>Gegeben:</span>
                        <span>${(totalGross + change).toFixed(2)} €</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:5px;">
                        <span>Rückgeld:</span>
                        <span>${change.toFixed(2)} €</span>
                    </div>
                ` : ''}

                <div style="border-top:1px dashed #000; margin-top:15px; padding-top:5px;"></div>
                
                ${receiptType === 'tax_receipt' ? `
                    <div style="text-align:center; font-weight:bold; margin-bottom:10px; font-size:0.9em;">
                        Bewirtungsbeleg
                    </div>
                    <div style="border:1px solid #000; padding:10px; margin-bottom:10px; font-size:0.9em;">
                        <p>Betrag: ______________________</p>
                        <p>Anlass der Bewirtung: ______________________</p>
                        <p>Bewirtete Person(en): ______________________</p>
                        <p>Ort, Datum: ______________________</p>
                        <p>Unterschrift Bewirtender: ______________________</p>
                    </div>
                ` : ''}

                <div style="text-align:center; margin-top:15px; font-size:0.9em;">
                    Vielen Dank für Ihren Besuch!
                </div>
            </div>
        `;

        return html;
    }

    window.printReceipt = function(htmlContent) {
        // Druckvorschau-Fenster erstellen
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Kassenbon</title>
                <style>
                    body { margin: 0; padding: 0; font-family: 'Monospace', monospace; font-size: 12px; }
                    .receipt-print { width: 80mm; margin: 0 auto; padding: 10px; box-sizing: border-box; }
                    @media print {
                        @page { margin: 0; }
                    }
                </style>
            </head>
            <body>
                ${htmlContent}
                <script>
                    window.onload = function() {
                        window.print();
                        // Schließe das Fenster nach dem Drucken, um Bon-Chaos zu vermeiden
                        setTimeout(() => window.close(), 100);
                    };
                </script>
            </body>
            </html>
        `);
        printWindow.document.close();
    }

    window.completePayment = async function() {
        if (window.currentBestellung.length === 0) return;
        window.showLoading(true);
        window.closeModal('payment-modal');

        const totalGross = parseFloat(document.getElementById('payment-total').textContent.replace(' €', ''));
        const change = parseFloat(document.getElementById('change-display').textContent.replace(' €', ''));
        const receiptType = document.getElementById('receipt-type').value;

        try {
            const batch = db.batch();
            const transactionRef = db.collection('users').doc(window.userId).collection('transactions').doc();
            const transactionId = transactionRef.id.substring(0, 8).toUpperCase();

            const transactionData = {
                id: transactionId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                items: window.currentBestellung,
                totalGross: totalGross,
                paymentMethod: window.paymentMethod,
                isCancelled: false,
                isReversal: false,
                receiptType: receiptType
            };
            batch.set(transactionRef, transactionData);

            // Transaktions-ID der letzten Transaktion speichern
            const lastTransactionRef = db.collection('settings').doc(window.userId);
            batch.set(lastTransactionRef, { lastTransactionId: transactionRef.id }, { merge: true });

            await batch.commit();

            window.showToast('Transaktion erfolgreich abgeschlossen.', 'success');
            
            // Beleg-Druck
            if (receiptType !== 'none') {
                const receiptHTML = window.generateReceiptHTML(window.currentBestellung, totalGross, window.paymentMethod, change, false, transactionId);
                document.getElementById('last-receipt-content').innerHTML = receiptHTML;
                window.printReceipt(receiptHTML);
            } else {
                 document.getElementById('last-receipt-content').innerHTML = '<p class="text-gray-500">Ohne Beleg abgeschlossen.</p>';
            }

            // Zurücksetzen der Kasse
            window.clearBestellung();

        } catch(err) {
            console.error('Payment error', err);
            window.showToast('Fehler beim Abschließen der Zahlung.', 'error');
        }
        window.showLoading(false);
    }

    // --------------------------------------------------------
    // ---------- Reversal / Storno Logic ---------------------
    // --------------------------------------------------------

    window.closeTransactionReversalModal = function() {
         window.closeModal('transaction-reversal-modal');
    }

    window.openTransactionReversalModal = async function() {
        if (!window.userId) return;
        window.showLoading(true);
        window.closeModal('report-modal');

        try {
            // ID der letzten Transaktion laden
            const settingsDoc = await db.collection('settings').doc(window.userId).get();
            const lastTransactionId = settingsDoc.data()?.lastTransactionId;

            if (!lastTransactionId) {
                document.getElementById('last-transaction-details').innerHTML = '<p class="text-red-500">Keine letzte Transaktion gefunden, die storniert werden kann.</p>';
                document.getElementById('reversal-button').disabled = true;
                window.showLoading(false);
                document.getElementById('transaction-reversal-modal').style.display='flex';
                return;
            }

            // Letzte Transaktion laden
            const transactionDoc = await db.collection('users').doc(window.userId).collection('transactions').doc(lastTransactionId).get();
            if (!transactionDoc.exists || transactionDoc.data().isCancelled) {
                document.getElementById('last-transaction-details').innerHTML = `<p class="text-red-500">Transaktion ${transactionDoc.data()?.id || lastTransactionId.substring(0, 8)} ist bereits storniert oder nicht verfügbar.</p>`;
                document.getElementById('reversal-button').disabled = true;
                window.showLoading(false);
                document.getElementById('transaction-reversal-modal').style.display='flex';
                return;
            }

            window.lastTransactionToReverse = { id: transactionDoc.id, ...transactionDoc.data() };

            const details = window.lastTransactionToReverse;
            document.getElementById('last-transaction-details').innerHTML = `
                <p><strong>ID:</strong> ${details.id}</p>
                <p><strong>Datum:</strong> ${details.timestamp.toDate().toLocaleDateString()} ${details.timestamp.toDate().toLocaleTimeString()}</p>
                <p><strong>Gesamtbetrag:</strong> <span class="text-red-700 font-bold">${details.totalGross.toFixed(2)} €</span></p>
                <p><strong>Bezahlt mit:</strong> ${details.paymentMethod.toUpperCase()}</p>
            `;
            document.getElementById('reversal-button').disabled = false;
            document.getElementById('transaction-reversal-code').value = '';

        } catch(err) {
            console.error('Last transaction load error', err);
            document.getElementById('last-transaction-details').innerHTML = '<p class="text-red-500">Fehler beim Laden der Transaktion.</p>';
            document.getElementById('reversal-button').disabled = true;
        }

        window.showLoading(false);
        document.getElementById('transaction-reversal-modal').style.display='flex';
        window.toggleReceiptColumn(false);
    }

    window.checkReversalCode = async function() {
        if (!window.lastTransactionToReverse) return;
        const storedCode = window.settings.reversalCode;
        const enteredCode = document.getElementById('transaction-reversal-code').value;

        if (!storedCode || storedCode === '') {
            window.showToast('Es ist kein Storno Code in den Einstellungen hinterlegt.', 'error');
            return;
        }

        if (enteredCode === storedCode) {
            await window.reverseTransaction(window.lastTransactionToReverse);
        } else {
            window.showToast('Falscher Storno Code.', 'error');
        }
    }

    window.reverseTransaction = async function(transaction) {
        window.showLoading(true);
        try{
            // Transaktion in Datenbank als storniert markieren
            await db.collection('users').doc(window.userId).collection('transactions').doc(transaction.id).update({
                isCancelled: true,
                reversalTimestamp: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Storno-Bon drucken
            const reversalBestellung = transaction.items.map(item => ({
                ...item,
                grossPrice: -Math.abs(item.grossPrice) // Preise als Negativ darstellen
            }));
            const reversalTotalGross = -Math.abs(transaction.totalGross);

            // Storno-Beleg generieren und drucken
            const receiptHTML = window.generateReceiptHTML(reversalBestellung, reversalTotalGross, transaction.paymentMethod, 0, true, transaction.id);
            document.getElementById('last-receipt-content').innerHTML = receiptHTML;
            window.printReceipt(receiptHTML);
            
            window.closeTransactionReversalModal();
            
            window.showToast('Transaktion erfolgreich storniert.', 'success');
            
            // Lade den Bericht neu, um die stornierte Transaktion zu aktualisieren
            window.generateReport(); 

        } catch(err){
            console.error('Reversal error', err);
            window.showToast('Fehler beim Stornieren der Transaktion.', 'error');
        }
        finally{ window.showLoading(false); }
    }


    // --------------------------------------------------------
    // ---------- Reporting Logic -----------------------------
    // --------------------------------------------------------

    window.setReportDateToday = function() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Januar ist 0!
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('report-date').value = `${yyyy}-${mm}-${dd}`;
    }

    window.openReportModal = function() {
        document.getElementById('report-modal').style.display='flex';
        window.toggleReceiptColumn(false);
        window.setReportDateToday();
        window.generateReport(); // Initialen Bericht beim Öffnen generieren
    }

    window.generateReport = async function() {
        if (!window.userId) return;
        window.showLoading(true);

        const selectedDate = document.getElementById('report-date').value;
        const startOfDay = new Date(selectedDate);
        startOfDay.setHours(0, 0, 0, 0);
        const endOfDay = new Date(selectedDate);
        endOfDay.setHours(23, 59, 59, 999);

        try {
            const querySnapshot = await db.collection('users').doc(window.userId).collection('transactions')
                .where('timestamp', '>=', startOfDay)
                .where('timestamp', '<=', endOfDay)
                .orderBy('timestamp', 'asc')
                .get();
            
            let totalGross = 0;
            let totalNet = 0;
            let totalTax = 0;
            const reportTaxSummary = {}; // { 19: { net: x, tax: y }, 7: { net: a, tax: b } }
            const paymentSummary = { cash: 0, card: 0 };
            const productSummary = {}; // { productId: { name: x, grossRevenue: y, quantity: z } }
            const transactions = [];

            querySnapshot.forEach(doc => {
                const transaction = doc.data();
                transactions.push({ id: doc.id, ...transaction });

                if (transaction.isCancelled) return; // Stornierte Transaktionen ignorieren

                totalGross += transaction.totalGross;
                paymentSummary[transaction.paymentMethod] += transaction.totalGross;

                // Berechnung der Netto- und Steuerbeträge
                const { summary, totalNet: transactionTotalNet, totalTax: transactionTotalTax } = window.getTaxSummary(transaction.items);
                totalNet += transactionTotalNet;
                totalTax += transactionTotalTax;

                // Aggregation der Steuer-Zusammenfassung
                for (const [rate, data] of Object.entries(summary)) {
                    if (!reportTaxSummary[rate]) {
                        reportTaxSummary[rate] = { net: 0, tax: 0 };
                    }
                    reportTaxSummary[rate].net += data.net;
                    reportTaxSummary[rate].tax += data.tax;
                }

                // Aggregation der Produkt-Zusammenfassung
                transaction.items.forEach(item => {
                    if (!productSummary[item.id]) {
                        productSummary[item.id] = { name: item.name, grossRevenue: 0, quantity: 0 };
                    }
                    productSummary[item.id].grossRevenue += item.grossPrice * item.quantity;
                    productSummary[item.id].quantity += item.quantity;
                });
            });

            window.renderReportSummary(totalGross, totalNet, totalTax, reportTaxSummary, paymentSummary, productSummary);
            window.renderTransactionHistory(transactions);
            
        } catch(err) {
            console.error('Report error', err);
            window.showToast('Fehler beim Generieren des Berichts.', 'error');
        }
        window.showLoading(false);
    }

    window.renderReportSummary = function(totalGross, totalNet, totalTax, reportTaxSummary, paymentSummary, productSummary) {
        document.getElementById('report-summary').classList.remove('hidden');
        document.getElementById('report-total-gross').textContent = `${totalGross.toFixed(2)} €`;
        document.getElementById('report-total-net').textContent = `${totalNet.toFixed(2)} €`;
        document.getElementById('report-total-tax').textContent = `${totalTax.toFixed(2)} €`;
        
        // MwSt. Aufschlüsselung
        const taxSummaryDiv = document.getElementById('report-tax-summary');
        taxSummaryDiv.innerHTML = '';
        for (const [rate, data] of Object.entries(reportTaxSummary)) {
            taxSummaryDiv.innerHTML += `
                <div>${rate}% Netto: <span class="font-semibold">${data.net.toFixed(2)} €</span></div>
                <div>${rate}% MwSt.: <span class="font-semibold">${data.tax.toFixed(2)} €</span></div>
            `;
        }
        
        // Zahlung Aufschlüsselung
        const paymentSummaryDiv = document.getElementById('report-payment-summary');
        paymentSummaryDiv.innerHTML = '';
        for (const [method, total] of Object.entries(paymentSummary)) {
            paymentSummaryDiv.innerHTML += `
                <div>${method.toUpperCase()}: <span class="font-semibold">${total.toFixed(2)} €</span></div>
            `;
        }
        
        // Produkt-Zusammenfassung
        const productSummaryDiv = document.getElementById('report-product-summary');
        productSummaryDiv.innerHTML = '';
        const sortedProducts = Object.values(productSummary).sort((a, b) => b.grossRevenue - a.grossRevenue);
        if (sortedProducts.length > 0) {
            sortedProducts.forEach(product => {
                productSummaryDiv.innerHTML += `
                    <div class="flex justify-between border-b border-gray-200 py-1">
                        <span>${product.name} (${product.quantity}x)</span>
                        <span class="font-medium">${product.grossRevenue.toFixed(2)} €</span>
                    </div>
                `;
            });
        } else {
            productSummaryDiv.innerHTML = '<p class="text-gray-500">Keine Produktumsätze.</p>';
        }
    }

    window.renderTransactionHistory = function(transactions) {
        const list = document.getElementById('transaction-history-list');
        list.innerHTML = '';
        const noMsg = document.getElementById('no-transactions-msg');

        if (transactions.length === 0) {
            noMsg.classList.remove('hidden');
            return;
        }

        noMsg.classList.add('hidden');
        
        // Sortiere nach Zeitstempel absteigend (neueste zuerst)
        transactions.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        
        transactions.forEach(transaction => {
            const statusClass = transaction.isCancelled ? 'bg-red-100 border-red-500' : 'bg-green-100 border-green-500';
            const statusText = transaction.isCancelled ? 'STORNIERT' : 'ABGESCHLOSSEN';

            const div = document.createElement('div');
            div.className = `flex justify-between items-center p-3 border-l-4 ${statusClass} rounded`;
            div.innerHTML = `
                <div>
                    <p class="font-bold">${transaction.id}</p>
                    <p class="text-sm text-gray-600">${transaction.timestamp.toDate().toLocaleTimeString()} - ${transaction.totalGross.toFixed(2)} €</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm font-semibold">${statusText}</span>
                    ${!transaction.isCancelled ? 
                        `<button onclick="window.openTransactionReversalModalFromHistory('${transaction.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-2 rounded transition">
                            Stornieren
                        </button>`
                        : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }

    window.openTransactionReversalModalFromHistory = async function(transactionId) {
        window.showLoading(true);
        try {
            const transactionDoc = await db.collection('users').doc(window.userId).collection('transactions').doc(transactionId).get();
            if (!transactionDoc.exists || transactionDoc.data().isCancelled) {
                window.showToast('Transaktion bereits storniert oder nicht verfügbar.', 'error');
                window.showLoading(false);
                return;
            }

            window.lastTransactionToReverse = { id: transactionId, ...transactionDoc.data() };
            
            const details = window.lastTransactionToReverse;
            document.getElementById('last-transaction-details').innerHTML = `
                <p><strong>ID:</strong> ${details.id}</p>
                <p><strong>Datum:</strong> ${details.timestamp.toDate().toLocaleDateString()} ${details.timestamp.toDate().toLocaleTimeString()}</p>
                <p><strong>Gesamtbetrag:</strong> <span class="text-red-700 font-bold">${details.totalGross.toFixed(2)} €</span></p>
                <p><strong>Bezahlt mit:</strong> ${details.paymentMethod.toUpperCase()}</p>
            `;
            document.getElementById('reversal-button').disabled = false;
            document.getElementById('transaction-reversal-code').value = '';

            window.showLoading(false);
            document.getElementById('report-modal').style.display='none';
            document.getElementById('transaction-reversal-modal').style.display='flex';
            window.toggleReceiptColumn(false);

        } catch (err) {
            console.error('Loading history transaction error', err);
            window.showToast('Fehler beim Laden der Transaktion zur Stornierung.', 'error');
            window.showLoading(false);
        }
    }

    window.exportReportCsv = function() {
        window.showToast('CSV Export Funktion ist noch nicht implementiert.', 'error');
    }

    // ---------- Startup (unchanged) ----------
    document.addEventListener('DOMContentLoaded', () => {
        window.updateAppView('login'); 
    });

  </script>
</body>
</html>
