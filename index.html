<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Kassensystem FH-Erfurt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Allgemeine Stile */
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; 
        }
        #kasse-content {
            height: 100vh;
            grid-template-columns: 1fr 2fr 1fr; /* Links, Mitte, Rechts (Bon) */
        }
        #receipt-content-interactive { 
            overflow-y: auto; 
            max-height: 40vh; /* Anpassung für besseres Scrolling */
        }
        .product-btn:active, .numpad-btn:active { 
            transform: scale(0.98);
        }
        .numpad-btn { 
            height: 50px; 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Loading & Toast */
        #async-loading-overlay { 
            position: fixed; top:0; left:0; right:0; bottom:0; 
            background: rgba(255,255,255,0.8); 
            z-index:100; 
            display:none; 
            justify-content:center; 
            align-items:center; 
        }
        .spinner { 
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid #b91c1c; 
            border-radius: 50%; 
            width:40px; 
            height:40px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0%{transform:rotate(0)} 
            100%{transform:rotate(360deg)} 
        }
        #toast-container { 
            position: fixed; top:20px; right:20px; z-index: 101; 
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast { 
            opacity: 0; 
            transition: opacity 0.5s ease-in-out; 
            padding: 10px 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            min-width: 250px;
            font-weight: 600;
        }
        .toast-success { background-color: #d1fae5; color: #065f46; }
        .toast-error { background-color: #fee2e2; color: #991b1b; }
        .toast-info { background-color: #e0f2f1; color: #0f766e; }

        /* Print Styles */
        #print-receipt-container { display: none; } /* Standardmäßig nicht anzeigen */

        @media print {
            body > *:not(#print-receipt-container) { display: none !important; }
            #print-receipt-container { 
                display: block; 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 300px; /* Typische Kassenbon-Breite */
                margin: 0 auto; 
                padding: 10px;
                font-family: monospace; /* Kassenbon-Schrift */
                font-size: 10px;
            }
            .receipt-print .separator {
                border-top: 1px dashed #333;
                margin: 5px 0;
            }
            .receipt-print .line {
                display: flex;
                justify-content: space-between;
                margin-bottom: 2px;
            }
            .receipt-print .line span {
                white-space: nowrap;
            }
            .receipt-print .total-line {
                font-weight: bold;
                font-size: 12px;
                margin-top: 5px;
            }
            .receipt-print .fill-line {
                flex-grow: 1;
                border-bottom: 1px solid #000;
                margin-left: 5px;
            }
        }

    </style>
</head>
<body class="bg-gray-100">

    <div id="async-loading-overlay">
        <div class="spinner"></div>
    </div>

    <div id="toast-container"></div>

    <div id="kasse-content" class="h-screen w-full grid gap-4 p-4" style="display: none;">
        
        <div class="flex flex-col space-y-4">
            
            <div id="header-bar" class="flex justify-between items-center p-3 bg-white rounded-xl shadow-md">
                <h1 class="text-xl font-extrabold text-red-700">POS System</h1>
                <div class="space-x-2">
                    <button onclick="window.openSettingsModalWithPin()" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-800 font-semibold text-sm">Einstellungen</button>
                    <button onclick="window.openProductModal()" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-800 font-semibold text-sm">Produkte</button>
                    <button onclick="window.openReportModalWithPin()" class="p-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-800 font-semibold text-sm">Bericht</button>
                    <button onclick="window.handleLogout()" class="p-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold text-sm">Logout</button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md p-4 flex-none">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold">Menge:</span>
                    <span id="quantity-mode-display" class="font-bold text-lg text-green-600">ADD</span>
                </div>
                
                <div id="quantity-display" class="text-center text-5xl font-extrabold text-gray-800 bg-gray-100 p-3 rounded-lg mb-4">1</div>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="window.handleQuantityInput('7')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">7</button>
                    <button onclick="window.handleQuantityInput('8')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">8</button>
                    <button onclick="window.handleQuantityInput('9')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">9</button>
                    <button onclick="window.handleQuantityInput('4')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">4</button>
                    <button onclick="window.handleQuantityInput('5')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">5</button>
                    <button onclick="window.handleQuantityInput('6')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">6</button>
                    <button onclick="window.handleQuantityInput('1')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">1</button>
                    <button onclick="window.handleQuantityInput('2')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">2</button>
                    <button onclick="window.handleQuantityInput('3')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">3</button>
                    <button onclick="window.handleQuantityInput('clear')" class="numpad-btn bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">C</button>
                    <button onclick="window.handleQuantityInput('0')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">0</button>
                    <button id="btn-quantity-mode" onclick="window.toggleQuantityMode()" class="numpad-btn bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm">ADD</button>
                </div>
            </div>

            <button onclick="window.openCashManagementModal()" class="w-full p-4 bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-xl shadow-md">
                Kasse Verwalten
            </button>
        </div>

        <div class="flex flex-col space-y-4 overflow-hidden">
            <div id="category-tabs" class="flex space-x-2 p-2 bg-white rounded-xl shadow-md overflow-x-auto flex-none">
                </div>
            
            <div id="product-grid" class="grid grid-cols-3 gap-3 flex-grow overflow-y-auto p-2 bg-white rounded-xl shadow-md">
                </div>
        </div>

        <div id="receipt-column" class="flex flex-col space-y-4 bg-white rounded-xl shadow-md p-4">
            <h2 class="text-lg font-bold border-b pb-2 text-center text-gray-700">Aktuelle Bestellung</h2>

            <div id="receipt-content-interactive" class="flex-grow overflow-y-auto border p-2 rounded-lg bg-gray-50">
                <p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>
                </div>

            <div class="flex-none pt-2 border-t">
                <div id="total-display" class="text-3xl font-extrabold text-red-700 text-center mb-4">GESAMT: 0,00 €</div>
                <button id="btn-finalize" onclick="window.openFinalizeModal()" class="w-full p-4 mb-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-xl text-xl" disabled>
                    ZAHLEN
                </button>
                <button id="btn-clear-order" onclick="window.clearBestellung()" class="w-full p-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold rounded-xl text-sm">
                    BON LÖSCHEN
                </button>
            </div>
        </div>

    </div>

    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-bold mb-6 text-center text-red-700">Kassen Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                    <input type="email" id="login-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700 font-semibold mb-2">Passwort</label>
                    <input type="password" id="login-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                </div>
                <button type="submit" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-lg">Anmelden</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="window.openRegistrationModal()" class="text-sm text-red-600 hover:text-red-800 mr-4">Neu Registrieren</button>
                <button onclick="window.openForgotPasswordModal()" class="text-sm text-gray-600 hover:text-gray-800">Passwort vergessen?</button>
            </div>
        </div>
    </div>
    
    <div id="registration-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-700">Registrieren</h2>
            <form id="register-form">
                <div class="mb-4">
                    <label for="register-email" class="block text-gray-700 font-semibold mb-2">E-Mail</label>
                    <input type="email" id="register-email" required class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-gray-700 font-semibold mb-2">Passwort (mind. 6 Zeichen)</label>
                    <input type="password" id="register-password" required minlength="6" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <button type="submit" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-lg">Konto erstellen</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="window.closeModal('registration-modal'); window.openLoginModal();" class="text-sm text-gray-600 hover:text-gray-800">Zurück zum Login</button>
            </div>
        </div>
    </div>

    <div id="forgot-password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-700">Passwort zurücksetzen</h2>
            <form id="reset-form">
                <div class="mb-4">
                    <label for="reset-email" class="block text-gray-700 font-semibold mb-2">E-Mail-Adresse</label>
                    <input type="email" id="reset-email" required class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <button type="submit" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg text-lg">Link senden</button>
            </form>
            <div class="mt-4 text-center">
                <button onclick="window.closeModal('forgot-password-modal'); window.openLoginModal();" class="text-sm text-gray-600 hover:text-gray-800">Zurück zum Login</button>
            </div>
        </div>
    </div>

    <div id="pin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 id="pin-modal-title" class="text-2xl font-bold mb-6 text-center text-red-700">Code eingeben</h2>
            
            <div id="pin-input-display" class="text-center text-5xl font-extrabold text-gray-800 bg-gray-100 p-3 rounded-lg mb-4">****</div>
            
            <div class="grid grid-cols-3 gap-2">
                <button onclick="window.handlePinInput('7')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">7</button>
                <button onclick="window.handlePinInput('8')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">8</button>
                <button onclick="window.handlePinInput('9')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">9</button>
                <button onclick="window.handlePinInput('4')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">4</button>
                <button onclick="window.handlePinInput('5')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">5</button>
                <button onclick="window.handlePinInput('6')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">6</button>
                <button onclick="window.handlePinInput('1')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">1</button>
                <button onclick="window.handlePinInput('2')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">2</button>
                <button onclick="window.handlePinInput('3')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">3</button>
                <button onclick="window.handlePinInput('clear')" class="numpad-btn bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">C</button>
                <button onclick="window.handlePinInput('0')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">0</button>
                <button onclick="window.handlePinInput('enter')" class="numpad-btn bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm">OK</button>
            </div>
            
            <button onclick="window.closeModal('pin-modal')" class="w-full mt-4 p-2 text-gray-600 hover:text-gray-800">Abbrechen</button>
        </div>
    </div>
    
    <div id="finalize-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl grid grid-cols-2 gap-8">
            
            <div class="border-r pr-6">
                <h2 class="text-3xl font-bold mb-6 text-red-700">Zahlung abschließen</h2>
                
                <div class="mb-6">
                    <span class="text-xl font-semibold">Gesamtbetrag:</span>
                    <div id="finalize-total" class="text-5xl font-extrabold text-red-700 mt-2">0,00 €</div>
                </div>

                <div class="flex space-x-4 mb-8">
                    <button id="btn-bar" onclick="window.setPaymentMethod('BAR')" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg relative">
                        Bar
                        <span id="btn-bar-indicator" class="absolute top-0 right-0 p-1 bg-green-500 rounded-full" style="display:none;"></span>
                    </button>
                    <button id="btn-karte" onclick="window.setPaymentMethod('KARTE')" class="flex-1 p-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg">
                        Karte
                    </button>
                </div>

                <div id="cash-payment-area" style="display: none;">
                    <div class="mb-4">
                        <span class="block text-gray-700 font-semibold mb-2">Erhaltener Betrag:</span>
                        <div id="cash-received-display" class="text-center text-4xl font-extrabold text-gray-800 bg-gray-100 p-3 rounded-lg">0,00</div>
                    </div>
                    <div class="mb-4">
                        <span class="block text-gray-700 font-semibold mb-2">Rückgeld:</span>
                        <div id="change-display" class="text-center text-4xl font-extrabold text-green-700 p-3 rounded-lg">0,00 €</div>
                    </div>
                    <button onclick="window.setCashExact()" class="w-full p-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm">Genau Betrag</button>
                    <div class="grid grid-cols-4 gap-2 mt-2">
                        <button onclick="window.addCashShortcut(5)" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg text-lg">+ 5 €</button>
                        <button onclick="window.addCashShortcut(10)" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg text-lg">+ 10 €</button>
                        <button onclick="window.addCashShortcut(20)" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg text-lg">+ 20 €</button>
                        <button onclick="window.addCashShortcut(50)" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg text-lg">+ 50 €</button>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4 text-gray-700">Betrag Numpad (Bar)</h3>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="window.handleCashInput('7')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">7</button>
                    <button onclick="window.handleCashInput('8')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">8</button>
                    <button onclick="window.handleCashInput('9')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">9</button>
                    <button onclick="window.handleCashInput('4')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">4</button>
                    <button onclick="window.handleCashInput('5')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">5</button>
                    <button onclick="window.handleCashInput('6')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">6</button>
                    <button onclick="window.handleCashInput('1')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">1</button>
                    <button onclick="window.handleCashInput('2')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">2</button>
                    <button onclick="window.handleCashInput('3')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">3</button>
                    <button onclick="window.handleCashInput('clear')" class="numpad-btn bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">C</button>
                    <button onclick="window.handleCashInput('0')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">0</button>
                    <button onclick="window.handleCashInput('dot')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">,</button>
                </div>

                <h3 class="text-xl font-bold mt-6 mb-4 text-gray-700">Belegoptionen</h3>

                <div id="cash-finalize-buttons" class="space-y-3" style="display: none;">
                    <button id="btn-cash-standard" onclick="window.handleFinalizeAction('BAR', 'standard')" class="w-full p-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">Abschließen & Bon drucken</button>
                    <button id="btn-cash-bewirtung" onclick="window.handleFinalizeAction('BAR', 'bewirtung')" class="w-full p-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Abschließen & Bewirtungsbeleg</button>
                    <button id="btn-cash-none" onclick="window.handleFinalizeAction('BAR', 'none')" class="w-full p-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-lg text-sm">Abschließen (Kein Beleg)</button>
                </div>
                
                <div id="card-finalize-buttons" class="space-y-3" style="display: none;">
                    <button id="btn-card-standard" onclick="window.handleFinalizeAction('KARTE', 'standard')" class="w-full p-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">Abschließen & Bon drucken</button>
                    <button id="btn-card-bewirtung" onclick="window.handleFinalizeAction('KARTE', 'bewirtung')" class="w-full p-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-lg text-sm">Abschließen & Bewirtungsbeleg</button>
                    <button id="btn-card-none" onclick="window.handleFinalizeAction('KARTE', 'none')" class="w-full p-3 bg-gray-400 hover:bg-gray-500 text-white font-bold rounded-lg text-sm">Abschließen (Kein Beleg)</button>
                </div>
                
                <button onclick="window.closeModal('finalize-modal')" class="w-full mt-4 p-2 text-gray-600 hover:text-gray-800">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <div id="settings-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl">
            <h2 class="text-2xl font-bold mb-6 text-red-700">Kassen-Einstellungen</h2>
            
            <div id="settings-menu">
                <button onclick="window.openGeneralSettings()" class="w-full p-4 mb-3 bg-gray-200 hover:bg-gray-300 rounded-lg text-left text-lg font-semibold">Allgemeine Einstellungen (Firma, Steuern)</button>
                <button onclick="window.openSecurityCodeSettings()" class="w-full p-4 mb-6 bg-gray-200 hover:bg-gray-300 rounded-lg text-left text-lg font-semibold">Sicherheitscode (Storno, Bericht)</button>
            </div>

            <div id="general-settings-form-container" style="display:none;">
                <h3 class="text-xl font-semibold mb-4">Allgemein</h3>
                <div class="mb-4">
                    <label for="company-name" class="block text-gray-700 font-semibold mb-2">Firmenname (Bon)</label>
                    <input type="text" id="company-name" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="address" class="block text-gray-700 font-semibold mb-2">Adresse (Bon)</label>
                    <input type="text" id="address" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-4">
                    <label for="tax-id" class="block text-gray-700 font-semibold mb-2">Steuernummer/USt-Id (Bon)</label>
                    <input type="text" id="tax-id" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div class="mb-6">
                    <label for="tax-rate" class="block text-gray-700 font-semibold mb-2">Standard Steuersatz (%)</label>
                    <input type="number" id="tax-rate" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <button onclick="window.saveSettings()" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg text-lg">Einstellungen speichern</button>
                <button onclick="window.showSettingsMenu()" class="w-full mt-2 p-2 text-gray-600 hover:text-gray-800">Zurück zum Menü</button>
            </div>

            <div id="security-code-settings-container" style="display:none;">
                <h3 class="text-xl font-semibold mb-4">Sicherheitscode</h3>
                <p class="mb-4 text-sm text-gray-600">Der 4-stellige Code schützt Einstellungen, Berichte und Stornierungen.</p>
                <div class="mb-6">
                    <label for="reversal-code-separate" class="block text-gray-700 font-semibold mb-2">Neuer 4-stelliger Code</label>
                    <input type="password" id="reversal-code-separate" maxlength="4" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <button onclick="window.saveSecurityCode()" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg text-lg">Code speichern</button>
                <button onclick="window.showSettingsMenu()" class="w-full mt-2 p-2 text-gray-600 hover:text-gray-800">Zurück zum Menü</button>
            </div>
            
            <button onclick="window.closeModal('settings-modal')" class="w-full mt-4 p-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg">Schließen</button>
        </div>
    </div>
    
    <div id="product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-4xl grid grid-cols-2 gap-8 overflow-y-auto max-h-5/6">
            
            <div>
                <h3 class="text-xl font-bold mb-4 text-red-700">Produkte verwalten (Preis/Lager)</h3>
                <div id="product-list" class="space-y-3 h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                    </div>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4 text-red-700">Produkt hinzufügen</h3>
                <div class="bg-gray-100 p-4 rounded-lg space-y-3 mb-6">
                    <input type="text" id="new-product-name" placeholder="Name" class="w-full p-2 border rounded-lg">
                    <div class="flex space-x-2">
                        <input type="number" id="new-product-price" step="0.01" placeholder="Preis (z.B. 1.50)" class="w-1/2 p-2 border rounded-lg">
                        <input type="number" id="new-product-stock" value="1" min="0" placeholder="Lagerbestand" class="w-1/2 p-2 border rounded-lg">
                    </div>
                    <select id="new-product-category" class="w-full p-2 border rounded-lg">
                        </select>
                    <input type="number" id="new-product-tax-rate" step="0.01" value="19.0" placeholder="MwSt.-Satz (z.B. 19.0)" class="w-full p-2 border rounded-lg">
                    <button onclick="window.addProduct()" class="w-full p-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg">Produkt hinzufügen</button>
                </div>

                <h3 class="text-xl font-bold mb-4 text-red-700">Kategorie verwalten</h3>
                <div id="category-list" class="space-y-2 mb-4">
                    </div>
                <div class="flex space-x-2">
                    <input type="text" id="new-category-name" placeholder="Neue Kategorie" class="flex-grow p-2 border rounded-lg">
                    <button onclick="window.addCategory()" class="p-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg">Hinzufügen</button>
                </div>
            </div>

            <button onclick="window.closeModal('product-modal')" class="col-span-2 w-full mt-4 p-2 bg-red-500 hover:bg-red-600 text-white font-bold rounded-lg">Schließen</button>
        </div>
    </div>
    
    <div id="cash-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-3xl grid grid-cols-2 gap-8">
            
            <div class="border-r pr-6">
                <h2 class="text-3xl font-bold mb-6 text-red-700">Kasse verwalten</h2>
                
                <div class="mb-6">
                    <span class="text-xl font-semibold">Aktueller Kassenstand (Bar):</span>
                    <div id="cash-balance-display" class="text-5xl font-extrabold text-blue-700 mt-2">0,00 €</div>
                </div>

                <div class="mb-4">
                    <span class="block text-gray-700 font-semibold mb-2">Betrag für Einlage/Entnahme:</span>
                    <div id="cash-man-received-display" class="text-center text-4xl font-extrabold text-gray-800 bg-gray-100 p-3 rounded-lg">0,00</div>
                </div>

                <button onclick="window.handleCashManagement('EINLAGE')" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg mb-2">BAR-EINLAGE HINZUFÜGEN</button>
                <button onclick="window.handleCashManagement('ENTNAHME')" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg">BAR-ENTNAHME ENTFERNEN</button>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4 text-gray-700">Betrag Numpad</h3>
                
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="window.handleCashManInput('7')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">7</button>
                    <button onclick="window.handleCashManInput('8')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">8</button>
                    <button onclick="window.handleCashManInput('9')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">9</button>
                    <button onclick="window.handleCashManInput('4')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">4</button>
                    <button onclick="window.handleCashManInput('5')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">5</button>
                    <button onclick="window.handleCashManInput('6')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">6</button>
                    <button onclick="window.handleCashManInput('1')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">1</button>
                    <button onclick="window.handleCashManInput('2')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">2</button>
                    <button onclick="window.handleCashManInput('3')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">3</button>
                    <button onclick="window.handleCashManInput('clear')" class="numpad-btn bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">C</button>
                    <button onclick="window.handleCashManInput('0')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">0</button>
                    <button onclick="window.handleCashManInput('dot')" class="numpad-btn bg-gray-200 hover:bg-gray-300 rounded-lg">,</button>
                </div>
                
                <button onclick="window.closeModal('cash-management-modal')" class="w-full mt-6 p-2 text-gray-600 hover:text-gray-800">Abbrechen</button>
            </div>
        </div>
    </div>
    
    <div id="report-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-5xl grid grid-cols-2 gap-8 overflow-y-auto max-h-5/6">
            
            <div>
                <h2 class="text-2xl font-bold mb-4 text-red-700">Tagesabschluss</h2>
                <div class="flex items-center space-x-3 mb-4">
                    <label for="report-date" class="font-semibold">Datum:</label>
                    <input type="date" id="report-date" onchange="window.loadTransactionHistory()" class="p-2 border rounded-lg">
                </div>
                
                <div id="screen-report-content" class="bg-gray-100 p-4 rounded-lg mb-4 text-sm font-mono whitespace-pre-wrap">
                    <p class="text-center text-gray-500">Bitte Datum wählen und Bericht erstellen.</p>
                </div>
                
                <button onclick="window.runDailyReport('report')" class="w-full p-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg">Bericht erstellen & anzeigen</button>
            </div>

            <div>
                <h3 class="text-xl font-bold mb-4 text-red-700">Transaktionshistorie (Storno)</h3>
                <div class="flex justify-between font-bold text-sm border-b pb-1 mb-2">
                    <span class="w-1/4">Zeit</span>
                    <span class="flex-grow text-right pr-2">Betrag</span>
                    <span class="w-1/4 text-center">Zahlart</span>
                    <span class="w-1/4 text-center">Aktion</span>
                </div>
                <div id="transaction-list" class="space-y-1 h-96 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                    </div>
                <button onclick="window.closeModal('report-modal')" class="w-full mt-4 p-2 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg">Schließen</button>
            </div>
        </div>
    </div>

    <div id="print-receipt-container"></div>

    <script type="module">
        // --- Firebase Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, getDoc, getDocs, deleteDoc, query, where, orderBy, serverTimestamp, addDoc, runTransaction, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Globaler Status
        let currentUser = null;
        let userSettings = {}; // Gespeicherte Einstellungen (Firmenname, Adresse etc.)
        let products = {}; // Cache für Produkte
        let categories = {}; // Cache für Kategorien
        let currentBestellung = []; // Die aktuelle Bestellung
        let totalBrutto = 0.00; 
        let currentQuantity = 1; // Quantity for product booking
        let isRemovalMode = false;
        // NEU: Kartengebühr Rate und temporärer Finalisierungs-Betrag
        const CARD_FEE_RATE = 0.0139; // 1.39%
        // NEU: Steuert den Entfernungsmodus (ADD/REMOVE) 
        let cashReceivedInput = '0'; // For the payment modal 
        let cashPaymentMethod = 'BAR';
        let finalTotalForPayment = 0.00; // Gesamtbetrag inkl. Gebühr für die Anzeige/Transaktion
        let reversalCode = ''; 
        let currentPinInput = ''; 
        let transactionHistory = []; // Für Transaktionshistorie/Bericht 
        let cashBoxBalance = 0.00; 
        let pinActionCallback = null; // Callback-Funktion nach erfolgreicher PIN-Eingabe 
        // Firebase Config 
        const firebaseConfig = { 
            apiKey: "AIzaSyBoa1jaK18f0yNjzaHTmxXFuZLmQ-Eefhc",
            authDomain: "kassensystem-85412.firebaseapp.com",
            databaseURL: "https://kassensystem-85412-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "kassensystem-85412",
            storageBucket: "kassensystem-85412.firebasestorage.app",
            messagingSenderId: "916536785810",
            appId: "1:916536785810:web:0d0319ef565af65d279f4b",
            measurementId: "G-W5HWYEXWJ5"
        };
        // Initialize Firebase 
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Collection References
        const settingsDocRef = (uid) => doc(db, 'users', uid, 'settings', 'userSettings');
        const productsCollectionRef = (uid) => collection(db, 'users', uid, 'products');
        const categoriesCollectionRef = (uid) => collection(db, 'users', uid, 'categories');
        const transactionsCollectionRef = (uid) => collection(db, 'users', uid, 'transactions');
        const cashMovementsCollectionRef = (uid) => collection(db, 'users', uid, 'cashMovements');


        // Initial check for authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                window.showLoading(true);
                seedUserDataIfNeeded(user.uid).then(() => {
                    window.loadSettings();
                    window.loadProductsAndCategories();
                    window.loadTransactionHistory(); // Starte das Laden der Historie beim Login
                });
                window.updateAppView('kasse');
            } else {
                currentUser = null;
                window.updateAppView('login');
            }
        });

        // ---------- Utility & UI Functions ----------
        window.showLoading = function(show){
            document.getElementById('async-loading-overlay').style.display = show ? 'flex' : 'none';
        }

        window.showToast = function(message, type = 'info'){
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type} shadow-lg`;
            toast.innerText = message;
            container.appendChild(toast);

            // Fade in
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        window.updateAppView = function(view){
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('kasse-content').style.display = 'none';

            if(view === 'login'){
                document.getElementById('login-modal').style.display = 'flex';
            } else if (view === 'kasse'){
                document.getElementById('kasse-content').style.display = 'grid';
                window.renderProductGrid(null); // Initial render
                window.updateReceipt(); // Initialer Bon
            }
        }

        window.toggleReceiptColumn = function(show){
            const col = document.getElementById('receipt-column');
            if(col) col.style.display = show ? 'flex' : 'none';
        }

        window.closeModal = function(id){
            document.getElementById(id).style.display='none';
            // Beim Schließen eines Modals die Kassenbon-Spalte wieder einblenden
            if(id !== 'login-modal' && id !== 'registration-modal' && id !== 'forgot-password-modal') {
                window.toggleReceiptColumn(true);
            }
        }

        window.openLoginModal = function(){
            window.updateAppView('login');
        }

        window.openRegistrationModal = function(){
            closeModal('login-modal');
            document.getElementById('registration-modal').style.display='flex';
        }

        window.openForgotPasswordModal = function(){
            closeModal('login-modal');
            document.getElementById('forgot-password-modal').style.display='flex';
        }

        // ---------- Auth Functions ----------
        window.handleRegisterSubmit = function(){
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            window.showLoading(true);
            createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                // Signed in
                const user = userCredential.user;
                window.showToast('Registrierung erfolgreich!', 'success');
                // No need to call updateAppView, onAuthStateChanged handles it
            })
            .catch((error) => {
                window.showToast(`Registrierung fehlgeschlagen: ${error.message}`, 'error');
            })
            .finally(() => window.showLoading(false));
        }

        window.handlePasswordReset = function(){
            const email = document.getElementById('reset-email').value;
            window.showLoading(true);
            sendPasswordResetEmail(auth, email)
            .then(() => {
                window.showToast('Link zum Zurücksetzen gesendet!', 'success');
                closeModal('forgot-password-modal');
                openLoginModal();
            })
            .catch((error) => {
                window.showToast(`Fehler beim Zurücksetzen: ${error.message}`, 'error');
            })
            .finally(() => window.showLoading(false));
        }

        window.handleLoginSubmit = function(){
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            window.showLoading(true);
            signInWithEmailAndPassword(auth, email, password)
            .catch((error) => {
                window.showToast(`Anmeldung fehlgeschlagen: ${error.message.includes('auth/invalid-credential') ? 'Falsche E-Mail oder falsches Passwort.' : error.message}`, 'error');
            })
            .finally(() => window.showLoading(false));
        }

        window.handleLogout = function(){
            signOut(auth).then(() => {
                window.showToast('Erfolgreich abgemeldet.', 'info');
                // Clear local state
                currentBestellung = [];
                products = {};
                categories = {};
                userSettings = {};
                reversalCode = '';
                cashBoxBalance = 0.00;
            }).catch((error) => {
                window.showToast('Fehler beim Abmelden.', 'error');
            });
        }

        // NEU: Initialisierung von Standard-Einstellungen und Produkten, falls Benutzer neu ist
        async function seedUserDataIfNeeded(uid){
            const settingsRef = settingsDocRef(uid);
            const docSnap = await getDoc(settingsRef);
            if (docSnap.exists() && docSnap.data().initialized) {
                return; // Daten sind bereits initialisiert
            }

            // Wenn keine Einstellungen vorhanden sind, initialisieren
            await setDoc(settingsRef, {
                initialized: true,
                companyName: 'Kassensystem FH-Erfurt',
                address: 'Altonaer Str. 25, 99085 Erfurt',
                taxId: '123/456/7890',
                taxRate: 19.0, // Fallback
                reversalCode: '', // Kein Code gesetzt
                cashBoxBalance: 100.00 // Startguthaben
            });
            
            // Produkte und Kategorien initialisieren
            const batch = writeBatch(db);
            const catIDs = {
                kalt: doc(categoriesCollectionRef(uid), 'kaltgetraenke'),
                snack: doc(categoriesCollectionRef(uid), 'snacks')
            };
            const prodIDs = {
                kaffee: doc(productsCollectionRef(uid), 'kaffee'),
                cola: doc(productsCollectionRef(uid), 'cola'),
                wasser: doc(productsCollectionRef(uid), 'wasser'),
                muffin: doc(productsCollectionRef(uid), 'muffin'),
                bier: doc(productsCollectionRef(uid), 'bier')
            };

            batch.set(catIDs.kalt, { name: 'Kaltgetränke', order: 1 });
            batch.set(catIDs.snack, { name: 'Snacks', order: 2 });
            
            batch.set(prodIDs.kaffee, { name: 'Kaffee (0,2l)', price: 1.50, categoryId: catIDs.kalt.id, stock: 50, taxRate: 7.0 });
            batch.set(prodIDs.cola, { name: 'Cola (0,33l)', price: 2.50, categoryId: catIDs.kalt.id, stock: 50, taxRate: 19.0 });
            batch.set(prodIDs.wasser, { name: 'Mineralwasser', price: 1.00, categoryId: catIDs.kalt.id, stock: 50, taxRate: 7.0 });
            batch.set(prodIDs.muffin, { name: 'Muffin', price: 2.00, categoryId: catIDs.snack.id, stock: 20, taxRate: 7.0 });
            batch.set(prodIDs.bier, { name: 'Bier (0,5l)', price: 3.50, categoryId: catIDs.kalt.id, stock: 40, taxRate: 19.0 });
            await batch.commit();
            window.showToast('Erste Initialisierung abgeschlossen.', 'success');
        }

        // ---------- Settings Management (MODIFIZIERT um neuen Code zu speichern) ----------
        window.saveSecurityCode = async function(){
            if (!currentUser) return;
            window.showLoading(true);
            try{
                const codeInput = document.getElementById('reversal-code-separate').value;
                const newCode = codeInput.trim().length === 4 ? codeInput.trim() : '';
                // Update local state and firestore
                await updateDoc(settingsDocRef(currentUser.uid), {
                    reversalCode: newCode
                });
                reversalCode = newCode;
                window.showToast('Sicherheitscode gespeichert.', 'success');
                closeModal('settings-modal');
            } catch(err){
                window.showToast('Fehler beim Speichern des Codes.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.saveSettings = async function(){
            if (!currentUser) return;
            window.showLoading(true);
            try{
                const settings = {
                    companyName: document.getElementById('company-name').value,
                    address: document.getElementById('address').value,
                    taxId: document.getElementById('tax-id').value,
                    taxRate: parseFloat(document.getElementById('tax-rate').value) || 19.0 // Fallback
                };
                await updateDoc(settingsDocRef(currentUser.uid), settings);
                userSettings = {...userSettings, ...settings}; // Lokalen Status aktualisieren
                window.showToast('Einstellungen gespeichert.', 'success');
                window.showSettingsMenu(); // Zurück zum Menü
            } catch(err){
                window.showToast('Fehler beim Speichern der Einstellungen.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.loadSettings = async function(){
            if (!currentUser) return;
            try{
                const docSnap = await getDoc(settingsDocRef(currentUser.uid));
                if(docSnap.exists()){
                    userSettings = docSnap.data();
                    reversalCode = userSettings.reversalCode || '';
                    cashBoxBalance = userSettings.cashBoxBalance || 0.00;
                }
                // Fülle die Einstellungs-Formularfelder aus (wenn das Modal geöffnet wird)
                if(document.getElementById('company-name')){
                    document.getElementById('company-name').value = userSettings.companyName || '';
                    document.getElementById('address').value = userSettings.address || '';
                    document.getElementById('tax-id').value = userSettings.taxId || '';
                    document.getElementById('tax-rate').value = userSettings.taxRate || 19.0;
                    document.getElementById('reversal-code-separate').value = reversalCode;
                }
            } catch(err){
                console.error("Fehler beim Laden der Einstellungen: ", err);
            }
        }

        window.showSettingsMenu = function(){
            document.getElementById('settings-menu').style.display = 'block';
            document.getElementById('general-settings-form-container').style.display = 'none';
            document.getElementById('security-code-settings-container').style.display = 'none';
            window.loadSettings(); // Lade aktuelle Einstellungen in das Formular, falls das Menü geöffnet wird
        }

        window.openGeneralSettings = function(){
            document.getElementById('settings-menu').style.display = 'none';
            document.getElementById('general-settings-form-container').style.display = 'block';
        }

        window.openSecurityCodeSettings = function(){
            document.getElementById('settings-menu').style.display = 'none';
            document.getElementById('security-code-settings-container').style.display = 'block';
            // Lade den Code, falls er bereits gesetzt ist
            document.getElementById('reversal-code-separate').value = reversalCode; 
        }

        // ---------- PIN Modal (Security) ----------
        window.updatePinInputDisplay = function(){
            document.getElementById('pin-input-display').innerText = '*'.repeat(currentPinInput.length);
        }

        window.handlePinInput = function(key){
            if(key === 'clear'){
                currentPinInput = '';
            } else if (key === 'enter'){
                if(currentPinInput.length !== 4){
                    window.showToast('Code muss 4-stellig sein.', 'error');
                } else if (currentPinInput === reversalCode){ // If code is set, allow access
                    closeModal('pin-modal');
                    pinActionCallback();
                } else if (reversalCode === '' && pinActionCallback){ // If no code is set, but modal was explicitly opened for action, also allow
                    closeModal('pin-modal');
                    pinActionCallback();
                } else {
                    window.showToast('Falscher Code.', 'error');
                    currentPinInput = '';
                }
            } else if (currentPinInput.length < 4 && key.match(/^\d$/)){
                currentPinInput += key;
            }
            window.updatePinInputDisplay();
        }

        window.openPinModal = function(title, callback){
            if(!reversalCode){ // If no code is set, skip the modal and run the callback immediately
                if(callback) callback();
                return;
            }
            document.getElementById('pin-modal-title').innerText = title;
            currentPinInput = '';
            pinActionCallback = callback;
            window.updatePinInputDisplay();
            document.getElementById('pin-modal').style.display='flex';
            window.toggleReceiptColumn(false); // Hide receipt column when PIN modal is open
        }

        window.openSettingsModalWithPin = function(){
            window.openPinModal('Einstellungen freischalten', () => {
                document.getElementById('settings-modal').style.display='flex';
                window.showSettingsMenu(); // Start with the menu
                window.toggleReceiptColumn(false);
            });
        }

        window.openReportModalWithPin = function(){
            window.openPinModal('Tagesabschluss freischalten', () => {
                document.getElementById('report-modal').style.display='flex';
                // Beim Öffnen des Modals die Transaktionen des aktuellen Tages laden
                window.loadTransactionHistory();
                window.toggleReceiptColumn(false);
            });
        }

        // ---------- Product & Category Management ----------
        window.loadProductsAndCategories = async function(){
            if (!currentUser) return;
            window.showLoading(true);

            try{
                // Kategorien laden
                const catSnapshot = await getDocs(query(categoriesCollectionRef(currentUser.uid), orderBy('order')));
                categories = {};
                catSnapshot.forEach(doc => categories[doc.id] = {...doc.data(), id: doc.id});

                // Produkte laden
                const prodSnapshot = await getDocs(productsCollectionRef(currentUser.uid));
                products = {};
                prodSnapshot.forEach(doc => products[doc.id] = {...doc.data(), id: doc.id});

                window.renderCategoryTabs();
                window.renderProductGrid(null); // Initial (alle Produkte)
                window.renderCategoryManagement();
                window.renderProductManagement();
                
            } catch(err){
                window.showToast('Fehler beim Laden der Produkte.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.openProductModal = function(){
            document.getElementById('product-modal').style.display='flex';
            window.renderCategoryManagement();
            window.renderProductManagement();
            window.toggleReceiptColumn(false);
        }

        window.addCategory = async function(){
            if (!currentUser) return;
            const name = document.getElementById('new-category-name').value.trim();
            if(name === '') return window.showToast('Kategoriename erforderlich.', 'error');
            window.showLoading(true);
            try{
                const newDocRef = doc(categoriesCollectionRef(currentUser.uid));
                const newOrder = Object.values(categories).length + 1;
                await setDoc(newDocRef, { name: name, order: newOrder });
                document.getElementById('new-category-name').value = '';
                window.showToast('Kategorie hinzugefügt.', 'success');
                await window.loadProductsAndCategories(); // Lade alles neu
            } catch(err){
                window.showToast('Fehler beim Hinzufügen der Kategorie.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.addProduct = async function(){
            if(!currentUser) return;
            const name = document.getElementById('new-product-name').value.trim();
            const price = parseFloat(document.getElementById('new-product-price').value);
            const stock = parseInt(document.getElementById('new-product-stock').value) || 0;
            const categoryId = document.getElementById('new-product-category').value;
            const taxRate = parseFloat(document.getElementById('new-product-tax-rate').value);
            if(name === '' || isNaN(price) || price <= 0) return window.showToast('Produktname und Preis sind erforderlich.', 'error');
            window.showLoading(true);
            try{
                await setDoc(doc(productsCollectionRef(currentUser.uid)), {
                    name: name,
                    price: price,
                    categoryId: categoryId || '',
                    stock: stock,
                    taxRate: taxRate
                });
                document.getElementById('new-product-name').value = '';
                document.getElementById('new-product-price').value = '';
                document.getElementById('new-product-stock').value = '1';
                window.showToast('Produkt hinzugefügt.', 'success');
                await window.loadProductsAndCategories();
            } catch(err){
                window.showToast('Fehler beim Hinzufügen des Produkts.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.updateProduct = async function(productId){
            if(!currentUser || !products[productId]) return;
            window.showLoading(true);
            try{
                const price = parseFloat(document.getElementById(`price-${productId}`).value);
                const stock = parseInt(document.getElementById(`stock-${productId}`).value);
                if(isNaN(price) || price <= 0) {
                    window.showToast('Ungültiger Preis.', 'error');
                    return;
                }
                await updateDoc(doc(productsCollectionRef(currentUser.uid), productId), {
                    price: price,
                    stock: stock
                });
                products[productId].price = price; // Lokalen Cache aktualisieren
                products[productId].stock = stock; // Lokalen Cache aktualisieren
                window.showToast('Produkt aktualisiert.', 'success');
                // Keine erneute loadProductsAndCategories nötig, nur Management-View aktualisieren
                window.renderProductManagement(); 
                window.renderProductGrid(products[productId].categoryId || null); // Grid aktualisieren
            } catch(err){
                window.showToast('Fehler beim Aktualisieren des Produkts.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.deleteProduct = async function(productId){
            if(!currentUser || !products[productId]) return;
            if(!confirm(`Produkt "${products[productId].name}" wirklich löschen?`)) return;
            window.showLoading(true);
            try{
                await deleteDoc(doc(productsCollectionRef(currentUser.uid), productId));
                delete products[productId]; // Aus Cache entfernen
                window.showToast('Produkt gelöscht.', 'success');
                window.renderProductManagement(); 
                window.renderProductGrid(null); // Grid aktualisieren
            } catch(err){
                window.showToast('Fehler beim Löschen des Produkts.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        window.renderCategoryTabs = function(){
            const tabs = document.getElementById('category-tabs');
            tabs.innerHTML = '';
            
            // "Alle Produkte" Tab
            tabs.innerHTML += `<button onclick="window.renderProductGrid(null)" class="product-btn p-2 bg-red-600 text-white rounded-lg whitespace-nowrap">ALLE</button>`;

            // Dynamische Tabs
            Object.values(categories).sort((a,b) => a.order - b.order).forEach(cat => {
                tabs.innerHTML += `
                    <button onclick="window.renderProductGrid('${cat.id}')" class="product-btn p-2 bg-white text-gray-800 rounded-lg whitespace-nowrap">${cat.name.toUpperCase()}</button>
                `;
            });
        }

        window.renderProductGrid = function(categoryId = null){
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            const filteredProducts = categoryId 
                ? Object.values(products).filter(p => p.categoryId === categoryId) 
                : Object.values(products);
            
            if (filteredProducts.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center p-4">Keine Produkte in dieser Kategorie.</p>';
                return;
            }

            filteredProducts.sort((a, b) => a.name.localeCompare(b.name)).forEach(product => {
                const stockStatus = product.stock <= 5 && product.stock > 0 ? `<div class="absolute top-1 right-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full shadow-md">Noch ${product.stock}x</div>` : (product.stock === 0 ? `<div class="absolute top-1 right-1 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full shadow-md">Ausverkauft</div>` : '');
                const disabled = product.stock === 0 ? 'disabled' : ''; // Button deaktivieren
                const disabledClass = product.stock === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100';

                grid.innerHTML += `
                    <button onclick="window.addToBestellung('${product.id}')" class="product-btn p-3 bg-white rounded-xl shadow-md flex flex-col items-center justify-center space-y-1 relative overflow-hidden h-32 ${disabledClass}" ${disabled}>
                        ${stockStatus}
                        <div class="font-bold text-base text-gray-800 text-center">${product.name}</div>
                        <div class="text-xl font-extrabold text-red-600">${product.price.toFixed(2).replace('.', ',')} €</div>
                    </button>
                `;
            });
        }

        window.renderCategoryManagement = function(){
            const list = document.getElementById('category-list');
            const select = document.getElementById('new-product-category');
            list.innerHTML = '';
            select.innerHTML = '<option value="">Kategorie wählen</option>';
            
            Object.values(categories).sort((a,b) => a.order - b.order).forEach(cat => {
                // Dropdown für neue Produkte
                select.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                
                // Liste für Verwaltung
                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 border rounded-lg bg-gray-50">
                        <span class="font-semibold">${cat.name}</span>
                    </div>
                `;
            });
        }

        window.renderProductManagement = function(){
            const list = document.getElementById('product-list');
            list.innerHTML = '';

            Object.values(products).sort((a,b) => a.name.localeCompare(b.name)).forEach(product => {
                list.innerHTML += `
                    <div class="grid grid-cols-6 gap-2 items-center p-2 border rounded-lg bg-white shadow-sm">
                        <span class="col-span-2 text-sm">${product.name}</span>
                        <input type="number" id="price-${product.id}" value="${product.price.toFixed(2)}" step="0.01" class="col-span-1 p-1 border rounded-lg text-sm">
                        <input type="number" id="stock-${product.id}" value="${product.stock}" min="0" class="col-span-1 p-1 border rounded-lg text-sm">
                        <button onclick="window.updateProduct('${product.id}')" class="col-span-1 p-1 bg-blue-500 text-white rounded-lg text-xs font-bold">Speichern</button>
                        <button onclick="window.deleteProduct('${product.id}')" class="col-span-1 p-1 bg-red-500 text-white rounded-lg text-xs font-bold">Löschen</button>
                    </div>
                `;
            });
        }


        // ---------- Quantity Numpad & Order Logic ----------
        window.updateQuantityModeDisplay = function(){
            const modeText = isRemovalMode ? 'REMOVE' : 'ADD';
            const btn = document.getElementById('btn-quantity-mode');
            const display = document.getElementById('quantity-mode-display');

            display.innerText = modeText;
            btn.innerText = modeText;
            if(isRemovalMode){
                display.classList.add('text-red-600');
                display.classList.remove('text-green-600');
                btn.classList.add('bg-red-500');
                btn.classList.remove('bg-green-500');
            } else {
                display.classList.add('text-green-600');
                display.classList.remove('text-red-600');
                btn.classList.add('bg-green-500');
                btn.classList.remove('bg-red-500');
            }
        }

        window.toggleQuantityMode = function(){
            isRemovalMode = !isRemovalMode;
            window.updateQuantityModeDisplay();
            currentQuantity = 1; // Setzt die Menge nach dem Umschalten zurück
            window.updateQuantityDisplay();
        }

        window.updateQuantityDisplay = function(){
            document.getElementById('quantity-display').innerText = currentQuantity;
        }

        window.handleQuantityInput = function(key){
            if(key === 'clear'){
                currentQuantity = 1; // Immer auf 1 zurücksetzen
            } else {
                const currentStr = currentQuantity.toString();
                let newQuantity = currentQuantity;
                
                // *** KORRIGIERTE FUNKTION FÜR MENGEN-EINGABE ***
                if (key.match(/^\d$/)) { // Nur Ziffern 0-9
                    if (currentQuantity === 1 && key === '0') {
                        newQuantity = 10;
                    } else if (currentQuantity.toString().length < 2 || currentQuantity === 1) { 
                        const appendedStr = currentQuantity === 1 && key !== '0' ? key : currentStr + key;
                        newQuantity = parseInt(appendedStr);
                    }
                }
                
                if (newQuantity <= 99) { 
                    currentQuantity = newQuantity; 
                } else {
                    window.showToast('Maximal 99.', 'error');
                }
            }
            window.updateQuantityDisplay();
        }

        // MODIFIZIERT: Berücksichtigt den isRemovalMode für Hinzufügen oder Entfernen
        window.addToBestellung = function(productId){
            if (!products[productId]) return;
            const product = products[productId];
            const quantityToProcess = currentQuantity;

            if (isRemovalMode) {
                // ENTFERNEN-Modus (Storno eines Artikels)
                const existingItemIndex = currentBestellung.findIndex(item => item.id === productId);
                if(existingItemIndex !== -1){
                    const existingItem = currentBestellung[existingItemIndex];
                    if(existingItem.quantity >= quantityToProcess){
                        // Menge im Warenkorb reduzieren
                        existingItem.quantity -= quantityToProcess;
                        existingItem.totalBrutto = existingItem.quantity * product.price;

                        // Lagerbestand erhöhen
                        product.stock += quantityToProcess;

                        if(existingItem.quantity === 0){
                            currentBestellung.splice(existingItemIndex, 1); // Artikel komplett entfernen
                        }
                        window.showToast(`${quantityToProcess}x ${product.name} storniert.`, 'info');
                    } else {
                        window.showToast(`Fehler: Nur ${existingItem.quantity}x ${product.name} im Bon.`, 'error');
                    }
                } else {
                    window.showToast(`${product.name} ist nicht im Bon.`, 'error');
                }

            } else {
                // HINZUFÜGEN-Modus
                const quantityToAdd = currentQuantity;
                const existingItem = currentBestellung.find(item => item.id === productId);

                if (product.stock < quantityToAdd) {
                    window.showToast(`Nur noch ${product.stock}x ${product.name} auf Lager!`, 'error');
                } else {
                    // Stock reduzieren
                    product.stock -= quantityToAdd;

                    if(existingItem){
                        // Artikel existiert, Menge erhöhen
                        existingItem.quantity += quantityToAdd;
                        existingItem.totalBrutto = existingItem.quantity * product.price; // Gesamtpreis aktualisieren
                    } else {
                        // Neuer Artikel
                        currentBestellung.push({
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            quantity: quantityToAdd,
                            totalBrutto: quantityToAdd * product.price,
                            taxRate: product.taxRate || userSettings.taxRate // Fallback to settings
                        });
                    }
                    window.showToast(`${quantityToAdd}x ${product.name} hinzugefügt.`, 'success');
                }
            }

            // Gemeinsame Updates
            window.renderProductGrid(product.categoryId || null);
            window.updateReceipt();
            currentQuantity = 1; // Menge auf 1 zurücksetzen
            window.updateQuantityDisplay();
        }

        window.clearBestellung = function(){
            if(currentBestellung.length === 0) return;
            if(confirm('Möchten Sie den aktuellen Bon wirklich löschen?')){
                // Return stock to all products in the order
                currentBestellung.forEach(item => {
                    if(products[item.id]) {
                        products[item.id].stock += item.quantity;
                    }
                });
                currentBestellung = [];
                window.updateReceipt();
                window.renderProductGrid(null); // Grid neu rendern (alle Produkte)
                window.showToast('Bestellung geleert.', 'info');
            }
        }

        window.updateReceipt = function(){
            const receiptContent = document.getElementById('receipt-content-interactive');
            const totalDisplay = document.getElementById('total-display');
            const btnFinalize = document.getElementById('btn-finalize');
            
            totalBrutto = 0.00;
            receiptContent.innerHTML = '';

            if (currentBestellung.length === 0) {
                receiptContent.innerHTML = '<p class="text-gray-500 text-center p-4">Es wurden noch keine Artikel gebucht.</p>';
                totalDisplay.innerText = 'GESAMT: 0,00 €';
                btnFinalize.disabled = true;
                return;
            }

            currentBestellung.forEach((item, index) => {
                totalBrutto += item.totalBrutto;
                const totalText = item.totalBrutto.toFixed(2).replace('.', ',');
                receiptContent.innerHTML += `
                    <div class="flex justify-between items-center p-1 border-b">
                        <span class="text-sm font-semibold flex-grow">${item.quantity}x ${item.name}</span>
                        <span class="text-sm font-bold text-red-600">${totalText} €</span>
                        <button onclick="window.removeFromReceipt(${index})" class="text-xs text-red-400 hover:text-red-600 ml-2">X</button>
                    </div>
                `;
            });

            totalDisplay.innerText = `GESAMT: ${totalBrutto.toFixed(2).replace('.', ',')} €`;
            btnFinalize.disabled = false;
        }

        window.removeFromReceipt = function(index){
            const item = currentBestellung[index];
            if (item) {
                // Stock zurückgeben
                if (products[item.id]) {
                    products[item.id].stock += item.quantity;
                }
                currentBestellung.splice(index, 1);
                window.updateReceipt();
                window.renderProductGrid(item.categoryId || null); // Re-render grid to update stock display
                window.showToast(`Artikel entfernt.`, 'info');
            }
        }


        // ---------- Finalize Payment Modal ----------

        window.openFinalizeModal = function(){
            if (currentBestellung.length === 0) return;
            closeModal('settings-modal'); 
            document.getElementById('finalize-modal').style.display='flex';
            
            // Setze die Standardzahlungsmethode auf BAR und aktualisiere die Gesamtanzeige (inkl. Gebührenlogik)
            window.setPaymentMethod('BAR'); 
        }

        // MODIFIZIERT: Die Gebührenberechnung und Display-Update sind hier integriert
        window.setPaymentMethod = function(method){
            cashPaymentMethod = method;
            
            let total = totalBrutto; // Basis ist der Warenwert OHNE Gebühr
            let fee = 0.00;
            let textSuffix = '';

            if (method === 'KARTE') {
                fee = total * CARD_FEE_RATE;
                total += fee;
                total = parseFloat(total.toFixed(2)); // Auf 2 Nachkommastellen runden
                textSuffix = ` (inkl. 1,39% Gebühr: ${fee.toFixed(2).replace('.', ',')} €)`;
            }

            finalTotalForPayment = total; // Speichere den finalen Betrag (mit oder ohne Gebühr)
            document.getElementById('finalize-total').innerText = finalTotalForPayment.toFixed(2).replace('.', ',') + ' €' + textSuffix;

            // UI-Logik:
            document.getElementById('cash-payment-area').style.display = method === 'BAR' ? 'block' : 'none'; 
            document.getElementById('cash-finalize-buttons').style.display = method === 'BAR' ? 'block' : 'none'; 
            document.getElementById('card-finalize-buttons').style.display = method === 'KARTE' ? 'block' : 'none'; 
            
            const btnBar = document.getElementById('btn-bar');
            const btnKarte = document.getElementById('btn-karte');

            // Bar-Button-Stil
            if(method === 'BAR'){
                btnBar.classList.add('bg-indigo-700');
                btnBar.classList.remove('bg-indigo-600');
            } else {
                btnBar.classList.add('bg-indigo-600');
                btnBar.classList.remove('bg-indigo-700');
            }

            // Karte-Button-Stil
            if(method === 'KARTE'){
                btnKarte.classList.add('bg-indigo-700');
                btnKarte.classList.remove('bg-indigo-600');
            } else {
                btnKarte.classList.add('bg-indigo-600');
                btnKarte.classList.remove('bg-indigo-700');
            }
            
            document.getElementById('btn-bar-indicator').style.display = method === 'BAR' ? 'block' : 'none';
            
            window.updateCashChangeDisplay();
        }

        window.updateCashChangeDisplay = function(){
            const totalCents = Math.round(totalBrutto * 100);
            // Korrekte Umwandlung des Komma-Strings in Cent-Betrag
            const receivedStr = cashReceivedInput.replace(',', '.');
            const receivedCents = Math.round(parseFloat(receivedStr) * 100) || 0;
            const changeCents = receivedCents - totalCents;
            const changeDisplay = document.getElementById('change-display');
            changeDisplay.innerText = (changeCents / 100).toFixed(2).replace('.', ',') + ' €';

            // Update finalize buttons status for BAR payment
            const canFinalize = changeCents >= 0;
            const btnCashNone = document.getElementById('btn-cash-none');
            const btnCashStandard = document.getElementById('btn-cash-standard');
            const btnCashBewirtung = document.getElementById('btn-cash-bewirtung');

            if(btnCashNone) btnCashNone.disabled = !canFinalize;
            if(btnCashStandard) btnCashStandard.disabled = !canFinalize;
            if(btnCashBewirtung) btnCashBewirtung.disabled = !canFinalize;

            // Farbe des Rückgeld-Displays
            if(changeCents < 0){
                changeDisplay.classList.remove('text-green-700');
                changeDisplay.classList.add('text-red-700');
            } else {
                changeDisplay.classList.remove('text-red-700');
                changeDisplay.classList.add('text-green-700');
            }
        }

        window.handleCashInput = function(key){
            let current = cashReceivedInput;
            if (key === 'clear') {
                current = '0';
            } else if (key === 'dot') {
                if (!current.includes(',')) {
                    // Füge Komma hinzu, wenn noch keines da ist
                    current += ',';
                }
            } else if (key.match(/^\d$/)) {
                if (current === '0' && key !== '0') {
                    current = key;
                } else if (current.includes(',')) {
                    const parts = current.split(',');
                    if (parts[1].length < 2) { // Max 2 Nachkommastellen
                        current += key;
                    } else {
                        window.showToast('Maximal zwei Nachkommastellen.', 'error');
                    }
                } else {
                    current += key;
                }
            }

            if(current.match(/^-?\d{1,6}(,\d{0,2})?$/)){ // Max 6 Vorkomma-Stellen
                 cashReceivedInput = current;
            }
            
            document.getElementById('cash-received-display').innerText = cashReceivedInput;
            window.updateCashChangeDisplay();
        }

        window.setCashExact = function(){
            cashReceivedInput = totalBrutto.toFixed(2).replace('.', ',');
            document.getElementById('cash-received-display').innerText = cashReceivedInput;
            window.updateCashChangeDisplay();
        }

        window.addCashShortcut = function(amount){
            let currentCash = parseFloat(cashReceivedInput.replace(',', '.')) || 0;
            currentCash += amount;
            cashReceivedInput = currentCash.toFixed(2).replace('.', ',');
            document.getElementById('cash-received-display').innerText = cashReceivedInput;
            window.updateCashChangeDisplay();
        }


        // MODIFIZIERT: Verwendet finalTotalForPayment und übergibt cardFee
        window.handleFinalizeAction = async function(paymentMethod, receiptType){
            if (currentBestellung.length === 0) return;
            
            window.showLoading(true);
            closeModal('finalize-modal');

            // NEU: Verwende den final berechneten Betrag (inkl. Gebühr bei KARTE)
            const totalWithFee = finalTotalForPayment;
            let cardFee = 0.00;

            // 1. Daten für die Transaktion vorbereiten
            const itemsForTransaction = currentBestellung.map(item => ({
                id: item.id,
                name: item.name,
                price: item.price,
                quantity: item.quantity,
                totalBrutto: item.totalBrutto,
                taxRate: item.taxRate
            }));

            if (paymentMethod === 'KARTE') {
                cardFee = totalBrutto * CARD_FEE_RATE;
                cardFee = parseFloat(cardFee.toFixed(2));
            }
            
            // 2. Bar-Zahlung prüfen und Rückgeld berechnen
            let receivedAmount = 0.00;
            let changeAmount = 0.00;

            if (paymentMethod === 'BAR') {
                const totalCents = Math.round(totalBrutto * 100); // Wichtig: totalBrutto OHNE Gebühr
                const receivedCents = Math.round(parseFloat(cashReceivedInput.replace(',', '.')) * 100) || 0;
                if(receivedCents < totalCents) {
                    window.showToast('Fehler: Erhaltener Betrag ist zu gering.', 'error');
                    window.showLoading(false);
                    return;
                }
                receivedAmount = receivedCents / 100;
                changeAmount = (receivedCents - totalCents) / 100;
            }
            // Für KARTE: receivedAmount ist gleich totalWithFee, changeAmount ist 0.00

            try{
                // 3. Transaktion in Firestore speichern
                await addDoc(transactionsCollectionRef(currentUser.uid), {
                    timestamp: serverTimestamp(),
                    items: itemsForTransaction,
                    totalBrutto: totalWithFee, // Wichtig: Gesamtbetrag inkl. Gebühr bei KARTE
                    paymentMethod: paymentMethod,
                    status: 'completed',
                    cardFee: cardFee, // NEU
                    received: receivedAmount || totalWithFee, // Betrag kann bei BAR anders sein
                    change: changeAmount
                });

                // 4. Kassenstand aktualisieren (nur bei BAR)
                if (paymentMethod === 'BAR') {
                    const diff = totalBrutto; // Nur der eingenommene Betrag (ohne Gebühr)
                    await updateDoc(settingsDocRef(currentUser.uid), {
                        cashBoxBalance: cashBoxBalance + diff
                    });
                    cashBoxBalance += diff; // Lokalen Stand aktualisieren 
                } // Bei KARTE: Kassenstand (BAR) ändert sich nicht
                
                window.showToast('Transaktion erfolgreich abgeschlossen.', 'success');

                // 5. Beleg drucken
                if (receiptType !== 'none') {
                    window.printReceipt(itemsForTransaction, totalWithFee, receiptType, userSettings, cardFee); // MODIFIZIERT: totalWithFee und cardFee übergeben
                }

                // Bestellung leeren und UI aktualisieren
                currentBestellung = []; // Stock wurde bereits in addToBestellung korrigiert
                window.updateReceipt();
                window.renderProductGrid(null); // Grid neu rendern (alle Produkte)
                window.loadTransactionHistory(); // Lade Historie neu
            } catch(err){
                console.error(err);
                window.showToast('Fehler beim Abschließen der Zahlung.', 'error');
            } finally {
                window.showLoading(false);
            }
        }

        // ---------- Cash Management (Einlage/Entnahme) ----------
        window.openCashManagementModal = function(){
            document.getElementById('cash-management-modal').style.display='flex';
            document.getElementById('cash-balance-display').innerText = cashBoxBalance.toFixed(2).replace('.', ',') + ' €';
            cashReceivedInput = '0'; // Use this for the amount input
            document.getElementById('cash-man-received-display').innerText = '0,00';
            window.toggleReceiptColumn(false);
        }

        // Uses the cashReceivedInput state for amount
        window.handleCashManInput = function(key){
            let current = cashReceivedInput;
            if (key === 'clear') {
                current = '0';
            } else if (key === 'dot') {
                if (!current.includes(',')) {
                    current += ',';
                }
            } else if (key.match(/^\d$/)) {
                if (current === '0' && key !== '0') {
                    current = key;
                } else if (current.includes(',')) {
                    const parts = current.split(',');
                    if (parts[1].length < 2) {
                        current += key;
                    } else {
                        window.showToast('Maximal zwei Nachkommastellen.', 'error');
                    }
                } else {
                    current += key;
                }
            }

            if(current.match(/^-?\d{1,6}(,\d{0,2})?$/)){
                 cashReceivedInput = current;
            }
            document.getElementById('cash-man-received-display').innerText = cashReceivedInput;
        }

        window.handleCashManagement = async function(type){
            if (!currentUser) return;
            
            const amountStr = cashReceivedInput.replace(',', '.');
            const amount = parseFloat(amountStr) || 0.00;
            if (amount <= 0) return window.showToast('Betrag muss größer 0 sein.', 'error');

            window.showLoading(true);
            try{
                const newBalance = type === 'EINLAGE' ? cashBoxBalance + amount : cashBoxBalance - amount;
                
                // Transaction
                await addDoc(cashMovementsCollectionRef(currentUser.uid), {
                    timestamp: serverTimestamp(),
                    type: type, // 'EINLAGE' or 'ENTNAHME'
                    amount: amount,
                    balanceBefore: cashBoxBalance,
                    balanceAfter: newBalance
                });

                // Update settings
                await updateDoc(settingsDocRef(currentUser.uid), {
                    cashBoxBalance: newBalance
                });

                cashBoxBalance = newBalance; // Lokalen Stand aktualisieren
                document.getElementById('cash-balance-display').innerText = cashBoxBalance.toFixed(2).replace('.', ',') + ' €';
                window.showToast(`${type} von ${amount.toFixed(2).replace('.', ',')} € erfolgreich.`, 'success');

                cashReceivedInput = '0';
                document.getElementById('cash-man-received-display').innerText = '0,00';
            } catch(err){
                window.showToast('Fehler bei der Kassenverwaltung.', 'error');
            } finally {
                window.showLoading(false);
            }
        }


        // ---------- Reporting & Transaction History ----------
        window.loadTransactionHistory = async function(){
            if (!currentUser) return;
            window.showLoading(true);
            const date = document.getElementById('report-date').value;
            if (!date) {
                window.showLoading(false);
                return;
            }
            const startOfDay = new Date(date);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);

            // 1. Transaktionen (inkl. Storno-Funktion)
            // Lädt alle Transaktionen für den Tag (inkl. stornierter), damit sie in der Liste angezeigt werden können
            const q = query(transactionsCollectionRef(currentUser.uid), 
                where('timestamp', '>=', startOfDay), 
                where('timestamp', '<=', endOfDay), 
                orderBy('timestamp', 'desc'));

            const querySnapshot = await getDocs(q);
            transactionHistory = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.renderTransactionHistory();
            window.showLoading(false);
        }

        // KORREKTUR 2: FUNKTIONALITÄTS-FIX FÜR REPORT-BUTTONS
        window.runDailyReport = async function(type){
            if (!currentUser) return;
            window.showLoading(true);
            
            // ZUERST: Sicherstellen, dass die Daten für den Bericht geladen sind.
            await window.loadTransactionHistory();

            const date = document.getElementById('report-date').value;
            const startOfDay = new Date(date);
            startOfDay.setHours(0, 0, 0, 0);
            const endOfDay = new Date(date);
            endOfDay.setHours(23, 59, 59, 999);

            // 1. Transaktionen für den Bericht laden: KEIN Status-Filter in der Firestore-Abfrage!
            const q = query(transactionsCollectionRef(currentUser.uid), 
                where('timestamp', '>=', startOfDay), 
                where('timestamp', '<=', endOfDay), 
                where('status', '==', 'completed'), // Nur erfolgreiche Verkäufe zählen
                orderBy('timestamp', 'asc')); // Für Bericht in richtiger Reihenfolge

            const transactionSnapshot = await getDocs(q);
            const completedTransactions = transactionSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // 2. Kassenbewegungen laden
            const cashQ = query(cashMovementsCollectionRef(currentUser.uid), 
                where('timestamp', '>=', startOfDay), 
                where('timestamp', '<=', endOfDay), 
                orderBy('timestamp', 'asc'));
            const cashSnapshot = await getDocs(cashQ);
            const cashMovements = cashSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // 3. Daten aggregieren
            let totalSales = 0.00; // Brutto-Umsatz (Warenwert + Gebühr)
            let totalCashSales = 0.00; // Brutto-Umsatz Bar (Warenwert)
            let totalCardSales = 0.00; // Brutto-Umsatz Karte (Warenwert + Gebühr)
            let taxTotals = {};

            completedTransactions.forEach(t => {
                totalSales += t.totalBrutto; // totalBrutto enthält Gebühr bei Karte
                if(t.paymentMethod === 'BAR'){
                    totalCashSales += (t.totalBrutto); // totalBrutto ist hier nur der Warenwert (da BAR keine Gebühr hat)
                } else if (t.paymentMethod === 'KARTE'){
                    totalCardSales += t.totalBrutto; // totalBrutto enthält hier Gebühr
                }

                t.items.forEach(item => {
                    const rateKey = item.taxRate.toFixed(1);
                    const rate = item.taxRate / 100;
                    const brutto = item.totalBrutto / item.quantity * item.quantity; // Einzelpreis * Menge
                    const netto = brutto / (1 + rate);
                    const taxAmount = brutto - netto;

                    if (!taxTotals[rateKey]) { taxTotals[rateKey] = { gross: 0, net: 0, tax: 0 }; }
                    taxTotals[rateKey].gross += brutto;
                    taxTotals[rateKey].net += netto;
                    taxTotals[rateKey].tax += taxAmount;
                });
            });

            let totalInlays = 0.00;
            let totalRemovals = 0.00;
            cashMovements.forEach(ct => {
                if(ct.type === 'EINLAGE') totalInlays += ct.amount;
                if(ct.type === 'ENTNAHME' || ct.type === 'STORNO-AUSZAHLUNG') totalRemovals += ct.amount;
            });

            const netSales = Object.values(taxTotals).reduce((sum, t) => sum + t.net, 0);
            const totalTax = Object.values(taxTotals).reduce((sum, t) => sum + t.tax, 0);
            const grossSales = totalSales; // Total Sales is already totalBrutto incl. card fee

            const totalCashMovement = (totalCashSales + totalInlays) - totalRemovals;
            
            // Report HTML generieren
            const companyName = userSettings.companyName || 'Kassensystem';
            const address = userSettings.address || '';
            const taxId = userSettings.taxId || '';

            let reportHtml = `<div class="receipt-print p-4">
                <div class="text-center font-bold text-xl mb-1">${(companyName).toUpperCase()}</div>`;
            if(address) reportHtml += `<div class="text-center text-sm">${address}</div>`;
            if(taxId) reportHtml += `<div class="text-center text-sm">St-Nr.: ${taxId}</div>`;
            reportHtml += `
                <div class="separator"></div>
                <div class="text-center font-extrabold text-base mb-2">TAGESABSCHLUSS & STORNO (${document.getElementById('report-date').value})</div>
                <div class="separator"></div>
                <div class="line total-line"><span>GESAMTEINNAHMEN BRUTTO:</span><span>${grossSales.toFixed(2).replace('.', ',')} €</span></div>
                <div class="line"><span>- Bar-Umsatz (Warenwert):</span><span>${totalCashSales.toFixed(2).replace('.', ',')} €</span></div>
                <div class="line"><span>- Karten-Umsatz (Inkl. Gebühr):</span><span>${totalCardSales.toFixed(2).replace('.', ',')} €</span></div>
                <div class="separator"></div>
                <div class="line"><span>Gesamtumsatz Netto:</span><span>${netSales.toFixed(2).replace('.', ',')} €</span></div>
                <div class="line"><span>Gesamte Steuer (MwSt.):</span><span>${totalTax.toFixed(2).replace('.', ',')} €</span></div>
                <div class="separator"></div>
                <div class="text-center font-bold text-base mb-2">Kassenbewegungen (Bar)</div>
                <div class="line"><span>+ Bar-Umsatz:</span><span>${totalCashSales.toFixed(2).replace('.', ',')} €</span></div>
                <div class="line"><span>+ Einlagen:</span><span>${totalInlays.toFixed(2).replace('.', ',')} €</span></div>
                <div class="line"><span>- Entnahmen/Stornos:</span><span>${totalRemovals.toFixed(2).replace('.', ',')} €</span></div>
                <div class="separator"></div>
                <div class="line total-line"><span>Netto Bar-Bewegung:</span><span>${totalCashMovement.toFixed(2).replace('.', ',')} €</span></div>
                <div class="line total-line"><span>Kassenstand Ende Tag:</span><span>${cashBoxBalance.toFixed(2).replace('.', ',')} €</span></div>
                <div class="separator"></div>
            `;

            // Steuerzusammenfassung detailliert
            reportHtml += `<div class="text-center font-bold text-sm mb-2">DETAILLIERTE STEUERZUSAMMENFASSUNG</div>`;
            reportHtml += `<div class="line"><span>MwSt.-Satz</span><span>Netto</span><span>MwSt.</span><span>Brutto</span></div>`;
            Object.keys(taxTotals).sort().forEach(rateKey => {
                const rate = taxTotals[rateKey];
                reportHtml += `<div class="line">
                    <span>${rateKey}%</span>
                    <span>${rate.net.toFixed(2).replace('.', ',')} €</span>
                    <span>${rate.tax.toFixed(2).replace('.', ',')} €</span>
                    <span>${rate.gross.toFixed(2).replace('.', ',')} €</span>
                </div>`;
            });

            reportHtml += `<div class="separator"></div>
                <div class="text-center text-xs">Bericht erstellt am: ${new Date().toLocaleString('de-DE')}</div>
            </div>`;

            if(type === 'report'){
                document.getElementById('screen-report-content').innerHTML = reportHtml;
            } else if (type === 'csv'){
                window.showToast('CSV-Export ist hier nicht implementiert.', 'info');
            }
            window.showLoading(false);
        }

        window.renderTransactionHistory = function(){
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            if(transactionHistory.length === 0){
                list.innerHTML = '<p class="text-gray-500 text-center p-4">Keine Transaktionen für diesen Tag.</p>';
                return;
            }

            transactionHistory.forEach(t => {
                const isCancelled = t.status === 'cancelled';
                const total = t.totalBrutto.toFixed(2).replace('.', ','); // totalBrutto enthält Gebühr bei Karte
                const time = t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                
                let paymentDisplay = t.paymentMethod;
                if(t.paymentMethod === 'KARTE' && t.cardFee > 0){
                    paymentDisplay += ' (Gebühr)';
                }

                list.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b last:border-b-0 ${isCancelled ? 'bg-red-100 text-red-700 opacity-70' : 'bg-white'}">
                        <span class="text-xs font-mono w-1/4">${time}</span>
                        <span class="font-bold flex-grow text-right pr-2 ${isCancelled ? 'line-through' : ''}">${total} €</span>
                        <span class="text-xs w-1/4 text-center">${paymentDisplay}</span>
                        ${!isCancelled ? `<button onclick="window.confirmCancelTransaction('${t.id}')" class="text-sm font-bold text-red-500 hover:text-red-700 ml-2">STORNO</button>` : `<span class="text-sm font-bold text-red-700 ml-2">STORNIERT</span>` }
                    </div>
                `;
            });
        }

        window.confirmCancelTransaction = function(transactionId){
            window.openPinModal('Transaktion stornieren', async () => {
                await window.cancelTransaction(transactionId);
            });
        }

        window.cancelTransaction = async function(transactionId){
            if (!currentUser) return;

            try{
                // 1. Hole die Transaktion
                const transactionRef = doc(transactionsCollectionRef(currentUser.uid), transactionId);
                const transactionSnap = await getDoc(transactionRef);
                if (!transactionSnap.exists()) {
                    window.showToast('Transaktion nicht gefunden.', 'error');
                    return;
                }
                const transaction = transactionSnap.data();

                if (transaction.status === 'cancelled') {
                    window.showToast('Transaktion ist bereits storniert.', 'info');
                    return;
                }

                // 2. Setze Status auf "cancelled"
                await updateDoc(transactionRef, { status: 'cancelled' });

                // 3. Füge Storno-Bewegung hinzu (nur für BAR relevant, da es eine Auszahlung ist)
                if (transaction.paymentMethod === 'BAR') {
                    const amountToSubtract = transaction.totalBrutto; // Nur der Warenwert
                    
                    // Storno als Entnahme/Auszahlung buchen
                    await addDoc(cashMovementsCollectionRef(currentUser.uid), {
                        timestamp: serverTimestamp(),
                        type: 'STORNO-AUSZAHLUNG',
                        amount: amountToSubtract,
                        balanceBefore: cashBoxBalance,
                        balanceAfter: cashBoxBalance - amountToSubtract
                    });
                    
                    // Kassenstand aktualisieren
                    await updateDoc(settingsDocRef(currentUser.uid), {
                        cashBoxBalance: cashBoxBalance - amountToSubtract
                    });
                    cashBoxBalance -= amountToSubtract;
                } 
                
                // 4. Lagerbestand zurückbuchen
                const batch = writeBatch(db);
                transaction.items.forEach(item => {
                    const productRef = doc(productsCollectionRef(currentUser.uid), item.id);
                    // Nutze runTransaction/getDoc in einer echten Umgebung, 
                    // hier ein einfaches Inkrement auf Basis des aktuellen Caches
                    if(products[item.id]){
                         // Erhöhe den Lagerbestand im Cache
                        products[item.id].stock += item.quantity; 
                        // Füge zur Batch-Operation hinzu
                        batch.update(productRef, { stock: products[item.id].stock });
                    }
                });
                await batch.commit();

                window.showToast('Transaktion erfolgreich storniert.', 'success');
                window.loadTransactionHistory(); // Lade Historie neu
                window.renderProductGrid(null); // Aktualisiere Lagerbestand-Anzeige
            } catch(err){
                console.error("Storno Fehler: ", err);
                window.showToast('Fehler beim Stornieren der Transaktion.', 'error');
            }
        }

        // ---------- Receipt Building (MODIFIZIERT) ----------

        // Helper-Funktion zur Berechnung der Steuerzusammenfassung
        function calculateTaxSummary(items){
            let totalNetto = 0.00;
            let totalTax = 0.00;
            let taxSummary = {};

            items.forEach(item => {
                const rate = (item.taxRate || userSettings.taxRate || 19.0) / 100;
                const brutto = item.totalBrutto;
                const netto = brutto / (1 + rate);
                const taxAmount = brutto - netto;

                totalNetto += netto;
                totalTax += taxAmount;

                const rateKey = (item.taxRate || userSettings.taxRate || 19.0).toFixed(1);
                if (!taxSummary[rateKey]) { taxSummary[rateKey] = { gross: 0, net: 0, tax: 0 }; }
                taxSummary[rateKey].gross += brutto;
                taxSummary[rateKey].net += netto;
                taxSummary[rateKey].tax += taxAmount;
            });
            return { totalNetto, totalTax, taxSummary };
        }

        // MODIFIZIERT: Neuer Parameter cardFee hinzugefügt
        window.printReceipt = function(items, total, receiptType, settings = userSettings, cardFee = 0.00){ 
            const html = window.buildReceiptHtml(items, total, receiptType, settings, cardFee);
            document.getElementById('print-receipt-container').innerHTML = html;
            window.print();
        }

        // MODIFIZIERT: Neuer Parameter cardFee hinzugefügt
        window.buildReceiptHtml = function(items, totalBruttoWithFee, receiptType = 'standard', settings = userSettings, cardFee = 0.00){ 
            const companyName = settings.companyName || 'Kassensystem';
            const address = settings.address || '';
            const taxId = settings.taxId || '';
            const time = new Date().toLocaleString('de-DE');
            const summary = calculateTaxSummary(items); 

            let content = `<div class="receipt-print">
                <div class="text-center font-bold text-base mb-1">${(companyName).toUpperCase()}</div>`;
            if(address) content += `<div class="text-center text-xs">${address}</div>`;
            if(taxId) content += `<div class="text-center text-xs">St-Nr.: ${taxId}</div>`;
            content += `
                <div class="text-center text-xs">Zeit: ${time}</div>
                <div class="separator"></div>`;

            // Warenzeilen hinzufügen
            items.forEach(item => {
                content += `<div class="line">
                    <span class="item-name">${item.quantity}x ${item.name}</span>
                    <span class="item-price">${(item.totalBrutto).toFixed(2).replace('.', ',')} €</span>
                </div>`;
            });

            // NEUE LOGIK: Gesamtbeträge differenzieren
            const totalBruttoWithoutFee = totalBruttoWithFee - cardFee; // Warenwert (Basis für Steuer)

            content += `<div class="line separator"></div>`;
            
            // Zeige zuerst den Warenwert OHNE Gebühr (Basis)
            content += `<div class="line total-line"><span>GESAMT (Brutto):</span><span>${totalBruttoWithoutFee.toFixed(2).replace('.', ',')} €</span></div>`;

            // Zeige die Transaktionsgebühren, falls vorhanden
            if(cardFee > 0){
                content += `<div class="line"><span>Transaktionsgebühren 1,39%:</span><span>${cardFee.toFixed(2).replace('.', ',')} €</span></div>`;
                content += `<div class="line total-line"><span>ZU ZAHLEN:</span><span>${totalBruttoWithFee.toFixed(2).replace('.', ',')} €</span></div>`;
            } else {
                content += `<div class="line total-line"><span>ZU ZAHLEN:</span><span>${totalBruttoWithFee.toFixed(2).replace('.', ',')} €</span></div>`;
            }

            // Steuerzusammenfassung
            content += `<div class="line separator"></div>
                <div class="line"><span>MwSt.-Satz</span><span>Netto</span><span>MwSt.</span><span>Brutto</span></div>`;
            Object.keys(summary.taxSummary).sort().forEach(rateKey => {
                const rate = summary.taxSummary[rateKey];
                content += `<div class="line">
                    <span>${rateKey}%</span>
                    <span>${rate.net.toFixed(2).replace('.', ',')} €</span>
                    <span>${rate.tax.toFixed(2).replace('.', ',')} €</span>
                    <span>${rate.gross.toFixed(2).replace('.', ',')} €</span>
                </div>`;
            });

            content += `<div class="line separator"></div>
                <div class="text-center">Vielen Dank für Ihren Besuch!</div>
                <div class="text-center text-xs">Eine Erfindung der FH-Erfurt</div>`;
            
            // NEU: Gebühr in den Bewirtungsbeleg einfügen
            if(receiptType === 'bewirtung'){
                content += `<div class="separator"></div>
                    <div class="text-center font-bold text-sm mb-2">BEWIRTUNGSBELEG</div>`;
                
                if(cardFee > 0){
                     content += `<div class="line"><span>Transaktionsgebühren 1,39%:</span><span>${cardFee.toFixed(2).replace('.', ',')} €</span></div>`;
                     content += `<div class="separator"></div>`;
                }

                content += `<div class="line total-line"><span>Gesamtbetrag:</span><span>${totalBruttoWithFee.toFixed(2).replace('.', ',')} €</span></div>
                    <div class="line"><span>Anlass der Bewirtung:</span><span class="fill-line"></span></div>
                    <div class="line"><span>Name der bewirteten Person(en):</span><span class="fill-line"></span></div>
                    <div class="line"><span>Ort und Datum:</span><span class="fill-line"></span></div>
                    <div class="line"><span>Unterschrift:</span><span class="fill-line"></span></div>`;
            }

            content += `</div>`;
            return content;
        }

        // NEU: Funktion zum Drucken des Belegs 
        window.printReceipt = function(items, total, receiptType, settings = userSettings, cardFee = 0.00){ 
            const html = window.buildReceiptHtml(items, total, receiptType, settings, cardFee);
            document.getElementById('print-receipt-container').innerHTML = html;
            window.print();
        }


        // --- DOM Ready / Startup (NEU: BINDET LOGIN HANDLER PER JS) ----------
        document.addEventListener('DOMContentLoaded', () => {
            window.setReportDateToday();
            window.updateAppView('login'); 
            
            window.updateQuantityModeDisplay(); // NEU: Initialisiere den Mengenmodus-Anzeiger
            
            // **FIX FÜR INLINE HANDLER PROBLEM**
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.handleLoginSubmit();
                });
            }
            const registerForm = document.getElementById('register-form');
            if(registerForm) {
                registerForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.handleRegisterSubmit();
                });
            }
            const resetForm = document.getElementById('reset-form');
            if(resetForm) {
                resetForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.handlePasswordReset();
                });
            }
            
        });

        window.setReportDateToday = function(){
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('report-date').value = `${year}-${month}-${day}`;
        }

    </script>
</body>
</html>
